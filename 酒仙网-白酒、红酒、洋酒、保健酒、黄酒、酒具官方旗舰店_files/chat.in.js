
/* @file chat.view.in.js
 * @date 2016.04.21 14:04:17 
 */
(function(a,q){a.myScroll=a.Class.create();a.myScroll.prototype={name:"myScroll",mainBox:null,contentBox:null,scrollBar:null,_wheelFlag:0,_wheelData:-1,timeID:null,options:null,initialize:function(b,c,d,e){this.mainBox=b.talkVersion?b:a(b);this.contentBox=c.talkVersion?c:a(c);this.options=a.extend({width:0},e);this.mainBox.length&&this.contentBox.length&&(this._createScroll(d),this.resizeScroll(),this._tragScroll(),this._wheelChange(),this._clickScroll())},scrollBottom:function(){var a=this;this.mainBox.length&&
this.contentBox.length&&(clearTimeout(this.timeID),this.timeID=setTimeout(function(){a.resizeScroll();a.mainBox.scrollTop(a.mainBox.scrollHeight());a.scrollBox.css("top",Math.floor(a.mainBox.offset().top-a.scrollBox.offset().top)+"px");a.scrollBar.css("top",a.scrollBox.height()-a.scrollBar.height()+"px");a._wheelFlag=12*(a.mainBox.height()-a.scrollBar.height())},50))},_createScroll:function(b){this.mainBox.css("overflow-y","hidden");this.scrollBox=a({className:"view-scrollBox",style:a.STYLE_NBODY+
"display:block;border-radius:10px;"}).appendTo(this.mainBox);this.scrollBar=a({className:b,style:a.STYLE_NBODY+"background:#d8d8d8;border-radius:10px;position:absolute;width:6px;top:0;"}).appendTo(this.scrollBox);a({tag:"span",style:a.STYLE_NBODY}).appendTo(this.scrollBar);return this.scrollBar},resizeScroll:function(){var a=this.mainBox.width(),c=(parseInt(this.mainBox.css("border-left-width"))||0)+(parseInt(this.mainBox.css("border-right-width"))||0),d=parseInt(this.contentBox.css("margin-left"))+
parseInt(this.contentBox.css("margin-right")),e=this.mainBox.height()-10-c,f=this.scrollBar.width()||6;this.scrollBox.css({position:"absolute",background:"#f9f9f9",width:this.scrollBar.width()+"px",height:this.mainBox.height()+"px",left:a-f-c+"px",top:"0px"});this.contentBox.css({width:Math.max(this.options.width,a-f-d)+"px"});a=Math.max(this.contentBox.height(),this.mainBox.height());e=parseInt(e*(e/a))||300;e>=this.mainBox.height()?this.scrollBox.display():this.scrollBox.display(1);this.scrollBar.css("height",
e+"px")},_tragScroll:function(){var b=this;this.scrollBar.bind("mousedown",function(c){function d(c){c=a.Event.fixEvent(c).clientY-g+f;c>e-b.scrollBar.height()&&(c=e-b.scrollBar.height());0>=c&&(c=0);var d=c*(b.contentBox.height()/b.mainBox.height());b.mainBox.scrollTop(d);b.scrollBox.css("top",Math.floor(d)+"px");b.scrollBar.css("top",c+"px");b._wheelData=c}var c=a.Event.fixEvent(c),e=b.mainBox.height(),f=b.scrollBar.offset().top-b.scrollBox.offset().top,g=c.clientY;a(document).bind("mousemove",
d);a(document).bind("mouseup",function(){a(document).removeEvent("mousemove",d)})}).hover(function(){a(this).css("background","#a6a6a6")},function(){a(this).css("background","#d8d8d8")})},_wheelChange:function(){var a=this,c=0;this._mouseWheel(this.mainBox,function(d){a._wheelFlag+=d;0<=a._wheelData?(c=a._wheelData,a.scrollBar.css("top",c+"px"),a._wheelFlag=12*a._wheelData,a._wheelData=-1):c=a._wheelFlag/12;0>=c&&(c=0,a._wheelFlag=0);c>=a.mainBox.height()-a.scrollBar.height()&&(c=a.mainBox.height()-
a.scrollBar.height(),a._wheelFlag=12*(a.mainBox.height()-a.scrollBar.height()));d=c*(a.contentBox.height()/a.mainBox.height());a.mainBox.scrollTop(d);a.scrollBox.css("top",Math.floor(d)+"px");a.scrollBar.css("top",c+"px")})},_clickScroll:function(){var b=this;this.scrollBox.click(function(c){var c=a.Event.fixEvent(c),d=c.clientY+a(window).scrollTop()-b.mainBox.offset().top-b.scrollBar.height()/2;0>=d&&(d=0);d>=b.mainBox.height()-b.scrollBar.height()&&(d=b.mainBox.height()-b.scrollBar.height());c.target!=
b.scrollBar&&(c=d*(b.contentBox.height()/b.mainBox.height()),b.mainBox.scrollTop(c),b.scrollBox.css("top",Math.floor(c)+"px"),b.scrollBar.css("top",d+"px"),b._wheelData=d)})},_mouseWheel:function(b,c){function d(b){b=a.Event.fixEvent(b);return b.wheelDelta?b.wheelDelta:40*b.detail}b.bind("mousewheel",function(a){var b=-d(a);c(b);document.all?window.event.returnValue=!1:a.preventDefault()}).bind("DOMMouseScroll",function(a){var b=d(a);c(b);a.preventDefault()})}};a.chatView=a.Class.create();a.chatView.prototype=
{name:"chatView",contains:null,loadElement:null,chatElement:null,messageElement:null,displayiFrame:null,chatHistory:null,objFile:null,objImage:null,_tempHeader:null,_chatsHeader:null,_chatsElement:null,_maxNumber:50,_sendKey:"Enter",_editorStart:0,_initFace:!1,_eventFunction:new Function,scroll:null,_listenNumber:0,_listenTimeID:null,_inputTimerID:null,buttonSelectors:null,imageHash:{},evalRepeatClick:!0,receiveMsgCount:0,mode:null,options:null,siteid:"",settingid:"",initialize:function(b,c){this.options=
b;this.siteid=this.options.siteid;this.settingid=this.options.settingid;this.mode=c;this.buttonSelectors={face:"chat-view-face",image:"chat-view-image",file:"chat-view-file",history:"chat-view-history",loadhistory:"chat-view-load-history",evaluate:"chat-view-evaluate",capture:"chat-view-capture",capoptions:"chat-view-capture-options",csr:"chat-view-change-csr",manual:"chat-view-switch-manual",submit:"chat-view-submit",exp:"chat-view-exp",xiaonengver:"chat-view-xiaoneng-version"};this.mode?(this.scroll=
null,this._create()):a.Log("mode is null",3)},_create:function(){this.contains=a({className:"chat-view-contains",key:this.settingid,style:a.STYLE_NBODY+"overflow:hidden;width:100%;height:auto;position:relative;left:0;top:0;padding-top:1px solid #fff\\0;"}).appendTo(this.options.chatContainter);this.loadElement=a({className:"chat-view-load",style:a.STYLE_BODY+"height:"+this.options.height+"px;_height:"+(this.options.height-240)+"px;box-sizing:border-box;display:block;"}).appendTo(this.contains).html(this._getViewHtml("load"));
this.chatElement=a({className:"chat-view-window",style:a.STYLE_BODY+"width:100%;height:auto;display:none;padding-top:1px solid #fff\\0;"}).appendTo(this.contains).html(this._getViewHtml("window"));this.messageElement=a({className:"chat-view-message",style:a.STYLE_BODY+"height:"+this.options.height+"px;display:none;float:left;width:100%;"}).appendTo(this.contains).html(this._getViewHtml("message"));this.displayiFrame=a({tag:"iframe",id:"chat-view-submit-iframe",name:"chat-view-submit-iframe",className:"chat-view-submit-iframe",
style:a.STYLE_NBODY+"display:none;"}).appendTo(this.contains);this.contains.append(this._getViewHtml("alert"));this.chatHistory=this.chatElement.find(".chat-view-window-history");this._tempHeader=this.options.chatHeader.find(".chat-header-icon,.chat-header-name,.chat-header-sign,.ntalk-button-maxresize,.ntalk-button-min,.ntalk-button-close");this.options.chatHeader.find(".header-chatrecord-title").length||a({className:"header-chatrecord-title",style:a.STYLE_BODY+"font-weight:bold;float:left;margin:15px 10px 5px 20px;height:20px;visibility:visible;overflow:hidden;display:none;"}).appendTo(this.options.chatHeader.find(".chat-header-body")).html(a.lang.button_view);
this.options.chatHeader.find(".header-chatrecord-close").length||a({className:"header-chatrecord-close",style:a.STYLE_NBODY+"float:right;cursor:pointer;margin:20px 5px 0 0;width:20px;height:20px;position:relative;display:none;"}).appendTo(this.options.chatHeader);this._chatsHeader=this.options.chatHeader.find(".header-chatrecord-title,.header-chatrecord-close");this._chatsElement=this.chatElement.find(".chat-view-float-history");this._bind();this.callChatResize(this.options.width,this.options.height)},
close:function(){this.contains.remove();this.contains=null;a.isFunction(this._eventFunction)&&a(document.body).removeEvent("click",this._eventFunction)},minimize:function(){this.contains.css({width:(a.browser.msie&&7>=a.browser.ieversion?1:0)+"px",height:(a.browser.msie&&7>=a.browser.ieversion?1:0)+"px"})},maximize:function(){this.contains.css({width:"100%",height:"auto"})},switchUI:function(b){if(this.contains)switch(b){case this.mode.CON_VIEW_WINDOW:this.contains.find(".chat-view-load,.chat-view-message").display();
this.contains.find(".chat-view-window").display(1);this.scroll||(this.scroll=new a.myScroll(this.chatHistory,this.chatHistory.find("ul"),"chat-view-scrollBar",{width:411}));break;case this.mode.CON_VIEW_MESSAGE:this.contains.find(".chat-view-load,.chat-view-window").display();this.contains.find(".chat-view-message").display(1);this._viewHistory(!1);this._stopListen();break;case this.mode.CON_VIEW_ERROR:this.contains.find(".chat-view-window,.chat-view-message").display();this.contains.find(".chat-view-load").display(1);
this.contains.find(".chat-view-load-icon, .chat-view-load-info").display();this.contains.find(".chat-view-load-error").display(1).find("span");break;default:this.contains.find(".chat-view-window,.chat-view-message").display(),this.contains.find(".chat-view-load").display(1),this.contains.find(".chat-view-load-error").display(),this.contains.find(".chat-view-load-icon, .chat-view-load-info").display(1)}},showMessage:function(b,c){var d=this,e,f,g,h,j,i=1;for(f=[a.STYLE_NBODY+"background:transparent;list-style:none outside none;display:block;padding:5px 30px 0 0;",
a.STYLE_NBODY+"background:transparent;list-style:none outside none;display:block;padding:5px 0 0 30px;text-align:right;",a.STYLE_NBODY+"background:transparent;list-style:none outside none;display:block;padding:5px 10px 0 10px;text-align:center;"];this.chatHistory.find("li[class]").length>=this._maxNumber;)this.chatHistory.find("li[class]").first().remove();switch(b){case "left":f=f[0];g=c.msgid;break;case "bottom":f=f[0];g="systembottom";break;case "right":f=f[1];g=c.msgid;break;case "goods":f=f[2];
g="first";break;case "system":f=f[2];g="system";break;case "system0":f=f[2];g="system0";break;case "info":f=f[2];g=c.msgid;break;case "otherinfo":f=f[0];g=c.msgid;break;default:f=f[2],g="first"}if(this.chatHistory.find("li."+g).length&&"system"!=g)"systembottom"==g&&this.chatHistory.find("li."+g).css("visibility","visible"),e=this.chatHistory.find("li."+g).html(this._getMessageHtml(b,this._contentFilter(c)));else if(c){("system"===g||"system0"===g)&&this.chatHistory.find("li."+g).remove();if("first"===
g&&1<this.chatHistory.find("ul li").length)h=this.chatHistory.find("li").eq(0);else if(j=this.chatHistory.find("li").eq(0-i),j.indexOfClass("first"))h=null;else{j.indexOfClass("systembottom")&&(i++,h=j,j=this.chatHistory.find("li").eq(0-i));if("system"===g&&this.mode.enterUserId){for(;j&&j.attr("userid")==this.mode.enterUserId&&!(5<=i);)i++,h=j,j=this.chatHistory.find("li").eq(0-i);this.mode.enterUserId=""}for(;j&&(!j.indexOfClass("first")&&!j.indexOfClass("system")&&j.attr("localtime")&&i<=this.chatHistory.find("li").length&&
parseFloat(j.attr("localtime"))>=c.localtime)&&!(5<=i);)i++,h=j,j=this.chatHistory.find("li").eq(0-i)}try{e=a({tag:"li",className:g,localtime:c.localtime,userid:c.userid||"",style:f,history:c.history||"0"}).appendTo(this.chatHistory.find("ul"),h),e.insert(this._getMessageHtml(b,this._contentFilter(c))),"systembottom"==g&&e.find("table td.view-history-content").css("width","60px")}catch(l){a.Log(l,3)}"system"!=g&&e.find("a").click(function(){if(!this.onclick){var b=a(this).attr("_href")||a(this).attr("href");
a(this).attr("_href",b).attr("target","_self").attr("href","###");if("function"==typeof window.openURLToBrowser)return window.openURLToBrowser(b),!1;window.open(b);return!1}});1==c.type&&"left"==b&&this.chatHistory.find("li.systembottom").css("visibility","hidden");c&&(/^(1|2|4|6)$/i.test(c.type)&&"left"==b&&"function"==typeof window.webInfoChanged&&"welcome"!=c.msgid&&1!=c.history&&"true"!=c.msgsystem)&&webInfoChanged(400,'{"num":'+ ++this.receiveMsgCount+', "showNum":1}',!1)}else this.chatHistory.find("li."+
g).remove();"systembottom"==g&&(clearTimeout(this._inputTimerID),this._inputTimerID=null,this._inputTimerID=setTimeout(function(){d.chatHistory.find("li.systembottom").css("visibility","hidden")},3E3));this.scroll&&this.scroll.scrollBottom();c&&1==c.type&&this.loadLinkContainer(c.msgid);c&&/^(1|2|4|6|9|13)$/i.test(c.type)&&this.updateMessage(c.msgid,c.type,c,"left"===b);1==a(".welcome").length&&a(".welcome").css("visibility","hidden").css("visibility","visible");return g},removeMessage:function(a){this.chatHistory.find("."+
a).remove()},updateMessage:function(b,c,d,e){var f=this,g=this.chatHistory.find("."+b).last(),h=g.find(".view-history-body").last(),j=a(".chat-view-window-history").height()-95;g.find(".view-history-more").bind("click",function(){h.css({height:"auto","overflow-y":"visible","max-height":"none"});f.scroll&&f.scroll.resizeScroll();a(this).display()});curHeight=h.height();if(a.base.checkID(d.userid)==a.CON_CUSTOMER_ID&&(h.scrollHeight()>j||h.height()>j))h.css({height:j+"px","overflow-y":"hidden"}),g.find(".view-history-more").display(1);
switch(c+""){case "1":"string"===typeof d?this._showResend(b,d).click(function(c){a.Event.fixEvent(c).stopPropagation();a(this).parent().parent().display();f.mode.resend(b)}):h.find(".ntalk-preview").length&&h.find(".ntalk-preview").each(function(){var c=this,e=a(c).attr("sourceurl");a.require(e+"#image",function(e){if(e.error)a(c).display();else{var d=a.zoom(e,332,500);a(c).attr({width:d.width,height:d.height,src:e.src}).click(function(){f._fullScreenImage(this,b)}).css({width:d.width+"px",height:d.height+
"px",cursor:"pointer"})}f.scroll&&f.scroll.scrollBottom&&f.scroll.scrollBottom()})});break;case "13":var f=this,i,l=[],k=d.msg.item||d.msg.items||{};if(!k||a.isEmptyObject(k))break;k.url=k.url||"javascript:void(0)";k.name&&l.push('<a href="',k.url,'" target="_blank" style="'+a.STYLE_BODY+'color:#0479D9;font-weight:bold;">'+k.name+"</a>");a.each(k,function(b,c){a.isArray(c)?(c[1]=(-1<b.indexOf("price")&&k.currency&&-1>=(c[1]+"").indexOf(k.currency)?k.currency:"")+""+c[1],l.push('<div style="'+a.STYLE_BODY+
'"><span style="'+a.STYLE_BODY+'">'+c[0]+(/zh_cn|zh_tw/i.test(a.lang.language)?"&#65306;":":")+"</span>"+c[1]+"</div>"),a.Log(c[0]+": "+c[1])):a.isObject(c)?(c.v=(-1<b.indexOf("price")&&k.currency&&-1>=(c.v+"").indexOf(k.currency)?k.currency:"")+""+c.v,l.push('<div style="'+a.STYLE_BODY+'"><span style="'+a.STYLE_BODY+'">'+c.k+(/zh_cn|zh_tw/i.test(a.lang.language)?"&#65306;":":")+"</span>"+c.v+"</div>"),a.Log(c.k+": "+c.v)):a.lang.goodsinfo[b]&&(c=(-1<b.indexOf("price")&&k.currency&&-1>=(c+"").indexOf(k.currency)?
k.currency:"")+c,l.push('<div style="'+a.STYLE_BODY+'"><span style="'+a.STYLE_BODY+'">'+a.lang.goodsinfo[b]+(/zh_cn|zh_tw/i.test(a.lang.language)?"&#65306;":":")+" </span>"+c+"</div>"),a.Log(a.lang.goodsinfo[b]+""+c))});k.imageurl&&a.require(k.imageurl+"#image",function(b){b.error?f.chatHistory.find(".view-history-goods-image").html(""):(i=a.zoom(b,75,75),f.chatHistory.find(".view-history-goods-image").html('<a href="'+k.url+'" target="_blank" style="'+a.STYLE_BODY+'"><img src="'+k.imageurl+'" width="'+
i.width+'" height="'+i.height+'" style="'+a.STYLE_NBODY+"display:inline;width:"+i.width+"px;height:"+i.height+'px;" /></a>'));f.scroll&&f.scroll.scrollBottom()});f.scroll&&f.scroll.scrollBottom();this.chatHistory.find(".view-history-goods-info").html(l.join(""));break;case "2":case "4":2==d.type&&1==d.emotion?(a.require(d.sourceurl+"#image",function(b){b.error?(a.Log("emotion file failure.",3),d.msgid&&f.removeMessage(d.msgid)):(b=a.zoom(b,100,85),h.css({background:"none",cursor:"auto",height:b.height+
"px"}).html('<img src="'+d.sourceurl+'" sourceurl="'+d.sourceurl+'" width="'+b.width+'" height="'+b.height+'" style="'+a.STYLE_NBODY+"width:"+b.width+"px;height:"+b.height+'px;vertical-align:middle;" />'));f.scroll&&f.scroll.scrollBottom()}),f.scroll&&f.scroll.scrollBottom()):"UPLOADING"==d.status?(g.find("table").css("width","138px"),h.css({width:"100px",height:"85px",background:"url("+a.imageicon+") no-repeat "+(2==c?"-98px -145px":"0 -245px")})):a.isNumeric(d)&&0<d&&100>=d?g.find(".view-history-progress").display(1).find(".view-history-upload-progress").css("width",
d+"%"):0>d||d.error?(2==c?(g.find("table").css("width","138px"),h.css({width:"100px",height:"85px",background:"url("+a.imageicon+") no-repeat "+(2==c?"0 -145px":"-98px -245px")}),-1==d?this._transCancel(b):this._showFailure(b)):this._showFileUpload(g,h,{name:"",size:"",error:e},-1),g.find(".view-history-progress").display()):a.isObject(d)&&d.url&&(2==c?a.require(d.url+"#rnd#image",function(c){if(c.error)a.Log("upload file failure.",3),g.find("table").css("width","120px"),h.css({width:"100px",background:"url("+
a.imageicon+") no-repeat 0 -145px"});else{var e='<img src="'+d.url+'" sourceurl="'+d.sourceurl+'" width="'+c.width+'" height="'+c.height+'" style="vertical-align:middle;'+a.STYLE_NBODY+"width:"+c.width+"px;height:"+c.height+'px;max-width:220px;max-height:160px;" />',j=c.width,i=c.height;if(138>c.width)if(j=138,100>c.height)var i=100,k=!a.browser.Quirks&&(6==a.browser.ieversion||7==a.browser.ieversion)?c.height:i,e='<div style="width:138px;height:'+k+"px;padding:"+(100-c.height)/2+'px 0;box-sizing:border-box;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+
e+"</div>";else e='<div style="width:138px;height:'+c.height+'px;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+e+"</div>";else 100>c.height&&(i=100,k=!a.browser.Quirks&&(6==a.browser.ieversion||7==a.browser.ieversion)?c.height:i,e='<div style="height:'+k+"px;width:"+c.width+"px;padding:"+(100-c.height)/2+'px 0;box-sizing:border-box;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+e+"</div>");g.find("table").css("width",
(220>j?j:220)+26+"px");a.Log("upload file(width:"+c.width+", height:"+c.height+") success:"+d.url);h.css({background:"none",cursor:"pointer",width:220>j?j+"px":"220px",height:160>i?i+"px":"160px","max-width":"220px","max-height":"160px"}).html(e).find("img").click(function(){f._fullScreenImage(this,b)});c=g.attr("userid");1>=a.base.checkID(c)&&c?h.parent().css({padding:"2px",border:"1px solid #e2e2e2"}):h.parent().css({padding:"2px",border:"1px solid #78bde9"});c=g.find(".view-history-angle");c.css("margin-top",
"15px");c.parent().css("vertical-align","top");f.imageHash[b]=1;"function"!=typeof webInfoChanged&&h.bind("mouseenter",function(){var b=['<div class="mouse-enter-download" style="',a.STYLE_BODY,'position:absolute;bottom:0px;width:100%;height:30px;line-height:30px;text-align:right;background:#000;color:white;left:0px">',a.lang.news_download,"&nbsp;&nbsp;</div>"].join("");a(this).css("position","relative");a(this).append(b);a(this).find(".mouse-enter-download").css("opacity",0.5);a(this).find(".mouse-enter-download").click(function(b){a.Event.fixEvent(b).stopPropagation();
f.displayiFrame.attr("src",d.sourceurl||d.url)})}).bind("mouseleave",function(){a(this).css("position","static");a(this).find(".mouse-enter-download").remove()})}f.scroll&&f.scroll.scrollBottom()}):this._showFileUpload(g,h,d,1),g.find(".view-history-progress").display());break;case "6":new a.Music(b,d.url,"audio/mpeg",d.duration||d.length,this.audioView,this.audioBindEvent,this.contains);break;case "9":break;default:h.html(d)}},loadLinkContainer:function(b){var c=this,b=this.chatHistory.find("."+
b).last().find(".view-history-body").find(".ntalk-link-contains");b.length&&b.each(function(b,e){var f=a(e).attr("data-source"),g=a(e).attr("class");f&&c.mode.loadLink(f,"."+g.replace(/ntalk\-link\-contains\s+/gi,""))})},viewLinkContainer:function(b,c){var d=this,e=a(c),f;if("string"==typeof b)try{b=a.JSON.parseJSON(b)}catch(g){}e.css({margin:"5px","border-radius":"5px",border:"1px solid #CCC","background-color":"#FAFAFA",width:"250px"});f=a({className:"link-image",style:a.STYLE_BODY+"margin:10px;background-color:#fff;width:77px;height:77px;overflow:hidden;float:left;display:inline-block;"}).appendTo(e);
container=a({className:"link-container",style:a.STYLE_BODY+"overflow:hidden;zoom:1;"}).appendTo(e);a({className:"link-title",style:a.STYLE_BODY+"margin:10px 0 0 0;width:100%;height:24px;white-space:nowrap;text-overflow:ellipsis;-o-text-overflow:ellipsis;overflow:hidden;"}).appendTo(container).html(['<a href="',b.url,'" target="_blank">',b.title,"</a>"].join(""));a({className:"link-desc",style:a.STYLE_BODY+"margin:5px 0 10px 0;width:100%;max-height:60px;overflow:hidden;"}).appendTo(container).html(a.enCut(b.description,
96,1)+"&nbsp;");a({className:"link-clear",style:a.STYLE_BODY+"clear:both;"}).appendTo(e);a.require(b.imageurl+"#image",function(c){c=a.zoom(c,75,75);f.html(['<img src="',b.imageurl,'" style="',a.STYLE_NBODY,"margin:"+((75-c.height)/2+"px "+(75-c.width)/2+"px")+";width:"+c.width+"px;height:"+c.height+'px;"/>'].join(""));d.scroll&&d.scroll.scrollBottom()})},scrollBottom:function(){},suggest:function(b){var c=this,d=this.chatElement.find(".chat-view-hidden-area .chat-view-suggest-list");d.find("ul li").remove();
a.each(b,function(b,f){a({tag:"LI",talk_index:b,className:"",style:a.STYLE_BODY+"padding:0 0 0 20px;list-style:none;line-height:28px;height:28px;overflow:hidden;cursor:pointer;"}).appendTo(d.find("ul")).html(f).hover(function(){a(this).css({color:"#fff","background-color":"#4297e0"})},function(){a(this).css({color:"#000","background-color":"#fafafa"})}).click(function(b){a.Event.fixEvent(b).stopPropagation();b=parseFloat(a(this).attr("talk_index"))+1;c.mode.send({msg:b,botindex:"index"});c.textEditor.val("");
d.css("display","none")})});d.css({display:"block",top:22-26*b.length+"px"})},_selectSuggest:function(b){var c=this.chatElement.find(".chat-view-suggest-list li"),d=0;c.each(function(){a(this).attr("talk_selected")&&(d=a(this).attr("talk_index"));a(this).attr("talk_selected","").css({color:"#000","background-color":"#fafafa"})});d=parseFloat(d)+b;d=0>d?c.length-1:d;d=d>=c.length?d-c.length:d;a.Log("set selected index:"+d);c.eq(d).attr("talk_selected","1").css({color:"#fff","background-color":"#4297e0"});
this.textEditor.val(d+1)},displayStatusInfo:function(b,c){var d=this.chatElement.find(".chat-view-window-status-info");c&&d.html(c);b?d.display(1):d.hide(function(){a(this).css({display:"none",opacity:1})})},showInputState:function(a){if(!(this._inputStateTimeID&&a===q)){var a=a?a:-140,c=this,d=this.chatHistory.find(".view-history-body-wait");this._inputStateTimeID=setTimeout(function(){d.length?(a=-170>=a?-140:a-10,d.css("background-position",a+"px -60px"),c.showInputState(a)):(clearTimeout(c._inputStateTimeID),
c._inputStateTimeID=null)},500)}},_showResend:function(b,c){this.chatHistory.find("."+b).last().find(".view-history-status").display(1);this.chatHistory.find("."+b).last().find(".view-history-status-icon").display(1);return this.chatHistory.find("."+b).last().find(".view-history-status-link").html(a.utils.handleLinks(c||a.lang.news_send_failure)).find("a")},_showCancel:function(b){this.chatHistory.find("."+b).last().find(".view-history-status").display(1);this.chatHistory.find("."+b).last().find(".view-history-status-icon").display();
return this.chatHistory.find("."+b).last().find(".view-history-status-link").html('<span style="'+a.STYLE_BODY+'cursor:pointer;color:#005ffb;text-decoration:none;">'+(a.lang.news_cancel_trans||"")+"</span>").find("span")},_showDownload:function(b,c,d){d=4==d.type&&d.oldfile?d.oldfile:"";c=c?['<span class="chat-view-download-link" style="'+a.STYLE_BODY+'float:left;line-height:26px;margin:0 5px;cursor:pointer;color:#005ffb;text-decoration:none;">'+a.lang.news_download+"</span>",d?'<span style="'+a.STYLE_BODY+
'float:left;line-height:26px;text-decoration:none;display:block;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;max-width:100px;" title="'+d+'">'+this._toFileName(d)+"</span>":""].join(""):[d?'<span style="'+a.STYLE_BODY+'float:left;line-height:26px;text-decoration:none;display:block;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;max-width:100px;" title="'+d+'">'+this._toFileName(d)+"</span>":"",'<span class="chat-view-download-link" style="'+a.STYLE_BODY+'float:left;line-height:26px;margin:0 5px;cursor:pointer;color:#005ffb;text-decoration:none;">'+
a.lang.news_download+"</span>"].join("");this.chatHistory.find("."+b).last().find(".view-history-status").display(1);this.chatHistory.find("."+b).last().find(".view-history-status-icon").display();return this.chatHistory.find("."+b).last().find(".view-history-status-link").html(c).find(".chat-view-download-link")},_toFileName:function(b){b=b||"";return 16>a.enLength(b)?b:a.enCut(b,10)+".."+b.substr(b.length-4,4)},_showFailure:function(b){this.chatHistory.find("."+b).last().find(".view-history-status").display(1);
this.chatHistory.find("."+b).last().find(".view-history-status-icon").display(1);return this.chatHistory.find("."+b).last().find(".view-history-status-link").html(a.lang.news_trans_failure)},_transCancel:function(b){this.chatHistory.find("."+b).last().find(".view-history-status").display(1);this.chatHistory.find("."+b).last().find(".view-history-status-icon").display(1);return this.chatHistory.find("."+b).last().find(".view-history-status-link").html(a.lang.news_trans_cancel)},_showFileUpload:function(b,
c,d,e){var f=this;b.find("table").css("width","293px");b.find("table").css("height","104px");c.css("height","104px");var g=[104,76,28],h=[11,78],j=[8,-44],i=[110,80,30],l=[13,80],k=[10,-42],r=b.attr("userid"),q=1>=a.base.checkID(r),s;q&&r?(s=270,g=i,i="1px solid #e2e2e2",h=l,j=k):(s=265,i="none");var n="",k="",l=d.oldfile||this.uploadFileName,p=d.oldfile||this.uploadFileName,m=!this.uploadFileSize?d.size?parseInt(d.size.replace("KB","")):"":(this.uploadFileSize/1024).toFixed(2),n=p.toLowerCase().match(/\.[^\.]+$/),
u=[".doc",".docx"];mp3Flag=[".mp3"];txtFlag=[".txt"];-1<a.inArray(n[0],".jpg .jpeg .png .gif .bmp .pjpeg".split(" "))?(n=d.url||"''",k=' width=50 height=50 style="border: 1px solid #d4d4d4;border-radius:5px;margin:2px"'):n=-1<a.inArray(n[0],mp3Flag)?a.sourceURI+"images/filetype/mp3.png":-1<a.inArray(n[0],u)?a.sourceURI+"images/filetype/doc.png":-1<a.inArray(n[0],txtFlag)?a.sourceURI+"images/filetype/txt.png":a.sourceURI+"images/filetype/zip.png";12<p.length&&(p=p.substr(0,4)+"..."+p.substr(p.length-
6,p.length));m?1024<m?m="("+(m/1024).toFixed(2)+" MB)":1024>m&&(m="("+m+" KB)"):m="";var t=1==e,u=q&&r?" display:none ":"",e=t?" -287px -96px ":" -159px -37px ";s=['<div class="view-fileupload-body" style="',a.STYLE_BODY,"position:relative;width:",s,"px;height:",g[0],"px;border-radius:5px;background:#FFF;border:",i,'"><div class="view-fileupload-body-top" style="',a.STYLE_BODY,"width:",s,"px;height:",g[1],'px;border-bottom:1px solid #e2e2e2"><div class="view-fileupload-type-icon" style="',a.STYLE_BODY,
"position:relative;width:54px;height:54px;top:",j[0],"px;left:",h[0],'px"><img src=',n+k,' /></div><div class="view-fileupload-content" style="',a.STYLE_BODY,"position:relative;width:170px;height:54px;top:",j[1],"px;left:",h[1],'px;text-align:left"><span class="view-fileupload-title" title=',l,' style="',a.STYLE_BODY,'cursor:pointer;color:#333333;font-size:12px;font-weight:bold;">',p,'</span><span class="view-fileupload-size" style="',a.STYLE_BODY,'color:#666666;font-size:12px">',m,'</span><div class="view-fileupload-status" style="',
a.STYLE_BODY+u,'position:relative;top:5px;left:-2px;color:#333333;font-size:12px">',t?a.lang.news_trans_success:a.lang.news_trans_failure,'</div><div class="view-fileupload-status-icon" style="',a.STYLE_BODY+u,"position:relative;width:20px;height:20px;top:-2px;left:-25px;background:url(",a.imageicon,") no-repeat ",e,'"></div></div></div><div class="view-fileupload-body-bottom" style="',a.STYLE_BODY,"position:relative;width:",s,"px;height:",g[2],'px"><div class="view-fileupload-download" style="',
a.STYLE_BODY,"width:auto;height:",g[2],"px;line-height:",g[2],'px;font-size:12px;color:#0681D7;text-align:right;margin-right:35px;cursor:pointer">',t?a.lang.news_download:"","</div></div></div>"].join("");c.append(s);q&&r?c.parent().css({padding:"0px",border:"none"}):c.parent().css({padding:"2px",border:"1px solid #78bde9"});r=b.find(".view-history-angle");r.css("margin-top","15px");r.parent().css("vertical-align","top");b.find(".view-history-status-link").last().display(0);b.find(".view-history-status").last().display(0);
t||(d.error.maxSize?d.error.error=a.utils.handleLinks(a.lang.news_trans_failure_size,{maxsize:d.error.maxSize/1048576}):d.error.ext&&(d.error.error=a.utils.handleLinks(a.lang.news_trans_failure_type,{type:d.error.ext})),f.showMessage("system",{type:9,msg:'<span style="display:inline-block;width:20px;height:20px;position:relative;top:5px;background: url('+a.imageicon+") no-repeat "+e+'"></span>'+d.error.error}));c.find(".view-fileupload-download").click(function(b){a.Event.fixEvent(b).stopPropagation();
t&&("function"==typeof openURLToBrowser?openURLToBrowser(d.sourceurl||d.url):f.displayiFrame.attr("src",d.sourceurl||d.url))})},_getPositionForTextArea:function(a){var c=0;if(document.selection){a.focus();var d=document.selection.createRange(),e=d.duplicate();try{e.moveToElementText(a)}catch(f){}for(c=-1;e.inRange(d);)e.moveStart("character"),c++}else if(a.selectionStart||"0"==a.selectionStart)c=a.selectionStart;return c},_setCursorPosition:function(a,c){this._editorStart=c;if(a.setSelectionRange)a.focus(),
a.setSelectionRange(c,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0);d.moveEnd("character",c);d.moveStart("character",c);d.select()}},_insertText:function(b){var c=this.textEditor.get(0),d=c.value==a.lang.default_textarea_text?"":c.value,e=Math.min(d.length,this._editorStart),e=0>e?d.length:e;c.value=d.substr(0,e)+b+d.substr(e,d.length);a.browser.mobile||(this._setCursorPosition(c,e+b.length),c.focus())},createEvaluation:function(b,c,d,e,f){var g=this,h,c=['<div class="ntkf-alert-close" style="'+
a.STYLE_NBODY+"cursor:pointer;height:20px;position:absolute;right:5px;top:9px;width:20px;background:url("+a.imageicon+') no-repeat scroll -60px -61px;-moz-border-radius:0px;-webkit-border-radius:0px;border-radius:0px;"></div>','<table border="0" cellpadding="0" cellspacing="0" style="'+a.STYLE_NBODY+'margin:0px 0 10px 0;width:100%;table-layout:auto;border-collapse:separate;">','<tbody style="',a.STYLE_NBODY,'"><tr style="',a.STYLE_NBODY,'"><td class="chat-view-evaluation-title" colspan="2" style="',
a.STYLE_BODY,'text-align:center;height:39px;color:#fff;"><span style="',a.STYLE_BODY,'color:#000;font-weight:bold;font-size:14px;vertical-align:middle;">'+c+"</span>","</td></tr>",a.FORM.createInput(b),'<tr style="',a.STYLE_NBODY,'"><td colspan="2" style="',a.STYLE_BODY,'padding:5px 0;text-align:center;color:#333;">','<input type="button" class="view-alert-submit" value="'+a.lang.evaluation_button_submit+'" style="'+a.STYLE_BODY+'padding:0 15px;border:1px solid #878787;background:#ebe9e9;height:28px;color:#333;line-height:24px;display:inline-block" />',
"</td></tr></tbody></table>"].join("");this.evalDialog||(this.evalDialog=new a.DialogChat(c,{margin:2,border:3,style:{border:"3px solid #00ACFF",height:"auto"},parent:this.chatElement.get(0)}));h=this.evalDialog.container;for(d=0;d<b.length;d++)"textarea"==b[d].type&&(c=h.find("table textarea[name="+b[d].name+"]").parent(),c.css("position","relative"),a({className:"textarea-"+b[d].name,maxsize:b[d].max,style:a.STYLE_BODY+"font-size:16px;font-weight:bold;color:#ccc;float:right;position:absolute;right:15px;top:70px;"}).appendTo(c).html("0/"+
b[d].max));h.find("table textarea").bind("keyup",function(){var b="table .textarea-"+a(this).attr("name"),c=a.enLength(a(this).val())>h.find(b).attr("maxsize")?"#f00":"#ccc",e=a.enLength(a(this).val())+"/"+h.find(b).attr("maxsize");h.find(b).html(e).css("color",c)});a.FORM.bindFormEvent(b,h);h.find("input[type!=hidden],textarea").get(0).focus();h.find(".ntkf-alert-close").click(function(){g.evalDialog.close();g.evalDialog=null});h.find(".view-alert-submit").click(function(b){a.Event.fixEvent(b).stopPropagation();
g.evalRepeatClick&&(g.evalRepeatClick=!1,g.mode.submitEvaluationForm(function(){a.isFunction(f)&&f();g.evalDialog.close();g.evalDialog=null;g.evalRepeatClick=!0}))}).gradient("top","#f5f5f5","#ffffff");h.find(".chat-view-evaluation-title").gradient("top","#ffffff","#f5f5f5");return h.get(0)},createFileButton:function(a){this.objFile=this._createUpload(a,"uploadfile",this.contains.find(".chat-view-file"));this.objImage=this._createUpload(a,"uploadimage",this.contains.find(".chat-view-image"),"image/jpg,image/png,image/gif,image/jpeg")},
_createUpload:function(b,c,d,e,f){var g=this,h={action:c,roomid:"T2D",siteid:this.siteid,settingid:this.settingid,charset:a.charset};return!b.filetranserver?null:new a.Transfer({server:b.filetranserver+"/imageupload.php",name:"userfile",maxSize:e,accept:f,params:h,onError:function(b){var c=a.chatManage.get(h.settingid);c&&c.uploadFailure(h.action,b)},onChange:function(a){g.uploadFileName=a.name;g.uploadFileSize=a.size},callback:function(b){a.Log(h.settingid+"::jsonp: "+a.JSON.toJSONString(b));var c=
a.chatManage.get(h.settingid);-2==b.result||9==b.type?c&&c.uploadFailure(h.action,b):(c&&c.startUpload(h.action,b.oldfile),setTimeout(function(){c&&c.uploadSuccess(h.action,b)}))}},d)},createMessageForm:function(b,c,d,e){var f=this,g=0;this.evalDialog&&(this.evalDialog.close(),this.evalDialog=null);if(!this.messageElement.find(".chat-view-message-table table").length){d&&(g=this.messageElement.find(".chat-view-message-announcement").html(d).display(1).height()+20);for(d=0;d<b.length;d++)b[d]=a.extend(b[d],
{titlewidth:/zh_cn|zh_tw/ig.test(a.lang.language)?"80px":"140px",inputwidth:"auto",input:{width:"90%",height:"textarea"==b[d].type?"140px":"auto"},messageid:"chat-view-message-"+b[d].name});this.messageElement.find(".chat-view-submit-submit").gradient("top","#f5f5f5","#ffffff");this.messageElement.find(".chat-view-message-body").css("height",this.messageElement.height()-g+"px");this.messageElement.find(".chat-view-message-table").html(['<table cellspacing="0" cellpadding="0" border="0" style="',a.STYLE_BODY,
'margin:20px 0 0 0;width:100%;table-layout:auto;border-collapse:separate;"><tbody style="',a.STYLE_NBODY,'">',c?"":[a.FORM.createInput(b,null,a.lang.message_no_null),'<tr style="',a.STYLE_NBODY,'"><td colspan="2" style="',a.STYLE_BODY,'text-align:center;padding:10px 0px 10px;color:#090;">','<input style="'+a.STYLE_BODY+'text-align:center;padding:0 20px;margin:0 auto;border:1px solid #878787;height:28px;color:#000;line-height:26px;" type="button" class="chat-view-button chat-view-submit-submit" value="'+
a.lang.message_button_submit+'">','<span class="submit_message_complete" style="',a.STYLE_BODY,'text-align:center;color:#090;display:none;">',a.lang.message_success,"</span></td></tr>"].join(""),"</tbody></table>"].join(""));this.messageElement.find("input[name=myuid]").val(e.myuid);this.messageElement.find("input[name=destuid]").val(e.destid);this.messageElement.find("input[name=ntkf_t2d_sid]").val(e.sessionid);this.messageElement.find("input[name=source]").val(e.source);this.messageElement.find("input[type=text],textarea,select").css("color",
"#ccc").attr("disabled","");e.fileError&&(c=a({tag:"tr",style:a.STYLE_NBODY}).appendTo(this.messageElement.find(".chat-view-message-table tbody"),this.messageElement.find(".chat-view-message-table tbody tr").eq(-1)),a({tag:"td",style:a.STYLE_NBODY}).appendTo(c),a({tag:"td",style:a.STYLE_NBODY}).appendTo(c).html(['<div style="',a.STYLE_BODY,'display:block;color:#ef7208;"><div style="',a.STYLE_BODY,"margin:2px;width:15px;height:15px;float:left;background:url(",a.imageicon,') no-repeat -160px -39px;"></div><div style="',
a.STYLE_BODY,'float:left;" class="chat-view-info">',a.lang.message_upload_failure,'</div><div style="',a.STYLE_NBODY,'clear:both;height:0;width:0;"></div></div>'].join("")));this.messageElement.find(".chat-view-submit-submit").show(function(){a(this).css("display",a.browser.oldmsie?"inline-block":"block")});this.messageElement.find(".submit_message_complete").display();a.FORM.bindFormEvent(b,this.messageElement);this.messageElement.find(".chat-view-submit-submit").click(function(){f.mode.submitMessageForm()});
this.messageElement.find("textarea").val(e.content)}},submitMessageForm:function(b,c){var d=this;a.FORM.verificationForm(b,function(){d.messageElement.find(".chat-view-message-form").attr("action",c);d.messageElement.find(".chat-view-message-form").get(0).submit();a.Log("chatView.submitMessageForm complete",1);d.messageElement.find("input[type=text],textarea,select").attr("disabled",!0);d.messageElement.find(".chat-view-submit-submit").display();d.messageElement.find(".submit_message_complete").css("display",
"block")},this.messageElement)},_fullScreenImage:function(b,c){var d=this,e=this._createfullScreen(b),f=a(b).attr("sourceurl")||b.src,g=function(){a.Log("download image "+f);"function"==typeof openURLToBrowser?openURLToBrowser(f):d.displayiFrame.attr("src",f)};a.Log(this.settingid+":chatView._fullScreenImage(), src:"+f,1);a(".view-fullScreen-background").css("opacity",0.6);e.click(function(b){a.Event.fixEvent(b).stopPropagation();d._hideScreenImage()}).find(".view-fullScreen-close").click(function(b){a.Event.fixEvent(b).stopPropagation();
d._hideScreenImage()});this.nextClick&&this.prevClick&&(e.find(".view-next-picture").removeEvent("click",this.nextClick),e.find(".view-prev-picture").removeEvent("click",this.prevClick));this.nextClick=function(b){a.Event.fixEvent(b).stopPropagation();var b=0,e=1E7;for(hashMsgId in d.imageHash){var f=parseInt(hashMsgId.substr(0,c.length-1)),g=parseInt(c.substr(0,c.length-1));0<f-g&&f-g<e&&(b=hashMsgId,e=f-g)}0==b?d._hideScreenImage():d._fullScreenImage(a("."+b).find(".view-history-body").find("img"),
b)};this.prevClick=function(b){a.Event.fixEvent(b).stopPropagation();var b=0,e=-1E7;for(hashMsgId in d.imageHash){var f=parseInt(hashMsgId.substr(0,c.length-1)),g=parseInt(c.substr(0,c.length-1));0>f-g&&f-g>e&&(b=hashMsgId,e=f-g)}0==b?d._hideScreenImage():d._fullScreenImage(a("."+b).find(".view-history-body").find("img"),b)};e.find(".view-next-picture").addEvent("click",this.nextClick);e.find(".view-prev-picture").addEvent("click",this.prevClick);e.find(".view-fullScreen-download").removeEvent("click",
g).bind("click",g);a(document).bind("keypress",function(b){27==a.Event.fixEvent(b).keyCode&&d._hideScreenImage()});a(window).bind("resize",function(){a(".view-fullScreen-background,.view-fullScreen-iframe,.view-fullScreen-container").css({width:a(window).width()+"px",height:a(window).height()+"px"})});e.find("img").attr("src")!=f&&(e.find("td").css({background:"url("+a.imageloading+") no-repeat center center"}),a.require(f+"#image",function(b){a.Log("nTalk._fullScreenImage() width:"+b.width+", height:"+
b.height);var c=a(window).width(),d=a(window).height(),b=a.zoom(b,c-100,d);0<e.find("td img").length&&e.find("td img").remove();e.find("td").append('<img src="'+f+'" width="'+Math.floor(b.width)+'" height="'+Math.floor(b.height)+'" style="'+a.STYLE_NBODY+"margin:0 auto;max-width:"+(c-100)+"px;max-height:"+d+'px"/>');e.find("td img")&&e.find("td").css({"background-image":""})}))},_hideScreenImage:function(){a(".view-fullScreen-container,.view-fullScreen-background,.view-fullScreen-iframe").display()},
_createfullScreen:function(){var b=a(window).width(),c=a(window).height();a(".view-fullScreen-iframe").length||a({tag:"iframe",className:"view-fullScreen-iframe",style:a.STYLE_NBODY+"display:none;width:"+b+"px;height:"+c+"px;"}).appendTo(!0).fixed();a(".view-fullScreen-background").length?a(".view-fullScreen-background").display(1):a({className:"view-fullScreen-background",style:a.STYLE_NBODY+"background:#000;opacity:0.6;filter:alpha(opacity=60);width:"+b+"px;height:"+c+"px;position:absolute;top:0;left:0;z-index:2000000000;"}).appendTo(!0).fixed();
a(".view-fullScreen-container").length?(a(".view-fullScreen-container img").remove(),a(".view-fullScreen-container").width()!=b&&a(".view-fullScreen-container").css("width",b+"px"),a(".view-fullScreen-container").height()!=c&&a(".view-fullScreen-container").css("height",c+"px"),a(".view-fullScreen-container").display(1)):a({className:"view-fullScreen-container",style:a.STYLE_NBODY+"width:"+b+"px;height:"+c+"px;text-align:center;position:absolute;top:0px;left:0;z-index:2000000001;"}).appendTo(!0).html(['<table style="',
a.STYLE_NBODY,'width:100%;height:100%;table-layout:auto;border-collapse:separate;"><tbody style="',a.STYLE_NBODY,'"><tr style="',a.STYLE_NBODY,'"><td valign="middle" align="center" style="',a.STYLE_NBODY,"text-align:center;vertical-align:middle;background:url(",a.imageloading,') no-repeat center center;"><div class="view-prev-picture" style="',a.STYLE_NBODY,'-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;position:absolute;width:50px;height:100%;bottom:0px;top:0px;left:0px">',
'<div style="position:relative;width:50px; height:40px;top:'+(a(window).height()-40)/2+"px;background:url(",a.imageicon,') no-repeat -225px -92px"></div></div><div class="view-next-picture" style="',a.STYLE_NBODY,'-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;position:absolute;width:50px;height:100%;bottom:0px;top:0px;right:0px">','<div style="position:relative;width:50px; height:40px;top:'+(a(window).height()-40)/2+"px;background:url(",a.imageicon,') no-repeat -178px -92px"></div></div></td></tr></table><span class="view-fullScreen-close" style="',
a.STYLE_NBODY,"position:absolute;width:28px;height:28px;margin:20px 20px 0 0;top:0;right:0;cursor:pointer;background:url(",a.imageicon,') no-repeat scroll -259px 0;z-index:2000000001;"></span><span class="view-fullScreen-download"  style="',a.STYLE_NBODY,"position:absolute;width:28px;height:28px;margin:20px 20px 0 0;top:0;right:50px;cursor:pointer;background:url(",a.imageicon,') no-repeat scroll -219px 0;z-index:2000000001;"></span>'].join("")).fixed();return a(".view-fullScreen-container")},_getMessageHtml:function(b,
c){var d=a.browser.oldmsie?Math.min(6*a.enLength(a.clearHtml(c.msg)),340)+"px":"auto";"otherinfo"===b&&(b="left",c.userid="",c.name="",c.msg=['<h1 style="',a.STYLE_BODY,'"><span style="',a.STYLE_NBODY,"float:left;margin-right:5px;width:15px;height:15px;background:transparent url(",a.imageicon,') no-repeat -199px -38px;"></span><span style="',a.STYLE_BODY,'font-weight:bold;">',c.title,'</span><br style="',a.STYLE_NBODY,'clear:both;" /></h1><p style="',a.STYLE_BODY,'">',c.msg,"</p>"].join(""));return"right"===
b?['<table style="',a.STYLE_NBODY,'float:right;_float:none;border-collapse:separate;" class="view-history-right" cellpadding="0" cellspacing="0" border="0" class="table"><tbody style="',a.STYLE_NBODY,'text-align:right;"><tr style="',a.STYLE_NBODY,'"><td class="view-history-content" style="',a.STYLE_BODY,'padding:8px;background:#8CD0F3;border:1px solid #d5d5d5;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;"><div class="view-history-body" style="min-height:20px;',a.STYLE_BODY,/^(2|4)$/i.test(c.type)&&
!c.emotion?"text-align:center;display:table-cell;*display:inline-block;vertical-align:middle;/*width:100px;*/min-height:50px;height:85px;*font-size:0px;*line-height:0px;*font-family:Arial;":"display:block;/*width:100%;*/","word-break:break-all;word-wrap:break-word;",1==c.type?"color:#"+c.color+";font:"+("true"==c.italic?"italic":"normal")+" "+("true"==c.bold?"bold":"normal")+" "+c.fontsize+"px/160% Arial,SimSun;text-decoration:"+("true"==c.underline?"underline":"none")+";":"",'">',1==c.type?c.msg:
6==c.type?['<div style="'+a.STYLE_NBODY+'width:200px;height:40px;overflow:hidden;">','<div class="view-history-audio" style="',a.STYLE_BODY,'float:left;min-width:1px;height:40px;overflow:hidden;">','<video controls="controls" width="200" height="40" style="'+a.STYLE_NBODY+'width:200px;height:40px;" src="',a.browser.opera||a.browser.firefox?c.url:c.sourceurl,'"></video></div></div>'].join(""):"",'</div><div class="view-history-progress" style="',a.STYLE_NBODY,'display:none;border-top:1px solid #30c2fd;background:#fff;height:5px"><div class="view-history-upload-progress" style="',
a.STYLE_NBODY,'height:5px;width:20%;background:#30c2fd;"></div></div></td><td style="',a.STYLE_NBODY,'width:20px;vertical-align:middle;overflow:visible;"><div class="view-history-angle" style="',a.STYLE_NBODY,"position:relative;left:-1px;z-index:1;width:20px;height:18px;background:url(",a.imageicon,') no-repeat -1px -63px;"></div></td></tr><tr style="',a.STYLE_NBODY,'"><td style="',a.STYLE_BODY,'overflow:visible;text-align:right;position:relative;"><span class="view-history-time" style="',a.STYLE_BODY,
'float:right;color:#b9b9c1;line-height:26px;">',a.formatDate(c.timerkeyid),'</span><span class="view-chat-hidden-area" style="',a.STYLE_NBODY,'float:right;width:1px;height:26px;overflow:visible;position:relative;top:0px;"><div class="view-history-status" style="',a.STYLE_BODY,'display:none;color:#010002;line-height:26px;width:280px;position:absolute;left:-280px;top:0px;"><div class="view-history-status-link" style="',a.STYLE_BODY,'float:right;line-height:26px;height:26px;"></div><div class="view-history-status-icon" style="',
a.STYLE_NBODY,"margin:7px 3px;float:right;display:block;line-height:26px;width:10px;height:10px;background:#fff url(",a.imageicon,') no-repeat -140px -39px;"></div></div></span></td><td style="',a.STYLE_NBODY,'"></td></tr></tbody></table><br style="',a.STYLE_NBODY,'clear:both;" />'].join(""):/left|bottom/gi.test(b)?['<table style="',a.STYLE_NBODY,'float:left;float:none;table-layout:auto;border-collapse:separate;" class="view-history-left" cellpadding="0" cellspacing="0" border="0" class="table"><tbody style="',
a.STYLE_NBODY,'"><tr style="',a.STYLE_NBODY,'"><td style="',a.STYLE_NBODY,'width:20px;vertical-align:middle;overflow:visible;"><div class="view-history-angle" style="',a.STYLE_NBODY,"position:relative;right:-1px;top:0px;z-index:1;width:20px;height:18px;background:url(",a.imageicon,') no-repeat -20px -62px;"></div></td><td class="view-history-content" style="',a.STYLE_BODY,'padding:8px;background:#ffffff;border:1px solid #d5d5d5;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px"><div class="view-history-body" style="min-height:20px;',
a.STYLE_BODY,/^(2|4)$/i.test(c.type)&&!c.emotion?"text-align:center;display:table-cell;*display:inline-block;vertical-align:middle;/*width:100px;*/min-height:50px;height:85px;*font-size:0px;*line-height:0px;*font-family:Arial;":"display:block;/*width:100%;*/","word-break:break-all;word-wrap:break-word;","bottom"==b?"width:60px;":"",1==c.type?"color:#"+c.color+";font:"+("true"==c.italic?"italic":"normal")+" "+("true"==c.bold?"bold":"normal")+" "+c.fontsize+"px/160% Arial,SimSun;text-decoration:"+("true"==
c.underline?"underline":"none")+";":"",'">',/^(1|9)$/i.test(c.type)?c.msg:"",'</div></td></tr><tr style="',a.STYLE_NBODY,'"><td style="',a.STYLE_NBODY,'"></td><td style="',a.STYLE_BODY,'overflow:visible;position:relative;"><span class="view-history-more" style="',a.STYLE_BODY,'margin-right:5px;float:left;color:blue;cursor:pointer;line-height:26px;display:none;">',a.lang.button_more,"</span>",c.userid&&!this.mode.isVisitor(c.userid)&&this.mode.dest.id!=c.userid?['<span class="view-history-destname" style="',
a.STYLE_BODY,'padding-right:5px;float:left;color:#b9b9c1;line-height:26px;">',c.name,"</span>"].join(""):"",'<span class="view-history-time" style="',a.STYLE_BODY,'float:left;color:#b9b9c1;line-height:26px;">',"bottom"==b?"":a.formatDate(c.timestamp||c.timerkeyid),'</span><span class="view-chat-hidden-area" style="',a.STYLE_NBODY,'float:left;width:1px;height:26px;overflow:visible;position:absolute;"><div class="view-history-status" style="',a.STYLE_BODY,'display:none;color:#010002;line-height:26px;height:26px;width:280px;position:absolute;left:0px;top:0px;"><div class="view-history-status-icon" style="',
a.STYLE_NBODY,"margin:7px 3px;float:left;line-height:26px;display:block;width:10px;height:10px;background:url(",a.imageicon,') no-repeat -140px -39px;"></div><div class="view-history-status-link" style="',a.STYLE_BODY,'float:left;line-height:26px;height:26px;">',/^(2|4)$/i.test(c.type)&&!c.emotion?['<a href="javascript:void(0);" style="',a.STYLE_BODY,'">',a.lang.news_download,"</a>"].join(""):"",'</div></div></span></td></tr></tbody></table><br style="',a.STYLE_NBODY,'clear:both;" />'].join(""):"first"===
b?['<div class="view-history-system" style="',a.STYLE_BODY,'background:transparent;line-height:180%;marign:0 auto;padding:20px 0;text-align:center;word-break:break-all;word-wrap:break-word;">',c.msg,'</div><br style="',a.STYLE_NBODY,'clear:both;" />'].join(""):"goods"===b?['<table style="',a.STYLE_NBODY,'float:left;width:100%;table-layout:auto;border-collapse:separate;" class="view-history-goods" cellpadding="0" cellspacing="0" border="0" class="table"><tbody style="',a.STYLE_NBODY,'text-align:center;"><tr style="',
a.STYLE_NBODY,'"><td class="view-history-goods-image" style="',a.STYLE_BODY,'width:50%;min-width:150px;text-align:center;"></td><td class="view-history-goods-info" style="',a.STYLE_BODY,'width:50%;text-align:left;"></td></tr><tr style="',a.STYLE_NBODY,'"><td colspan="2" style="',a.STYLE_NBODY,'height:10px;width:100%;"><div style="',a.STYLE_BODY,"margin:0 auto;background:#FFF url(",a.imageicon,') no-repeat 85px -80px;height:10px;width:391px;"></div></td></tr></tbody></table><br style="',a.STYLE_NBODY,
'clear:both;" />'].join(""):['<div class="view-history-system" style="',a.STYLE_BODY,'marign:20px 0;text-align:center;color:#706E6F;"><fieldset style="',a.STYLE_BODY,'margin:0 0 10px 0;text-align:center;border-top:1px solid #ccc;"><legend style="',a.STYLE_BODY,"margin:0 auto;text-align:center;word-break: normal;word-wrap:break-word;font:normal normal normal 12px/160% Arial,SimSun;color:#706e6f;width:",d,';overflow-x:hidden;display:block;" align="center"><div style="',a.STYLE_BODY,"text-align:center;word-break: normal;word-wrap:break-word;color:#706e6f;width:",
d,';overflow-x:hidden;">',c.msg,'</div></legend></fieldset></div><br style="',a.STYLE_NBODY,'clear:both;" />'].join("")},_getViewHtml:function(b){var c=a.browser.msie&&8>=a.browser.ieversion?"":"box-shadow:inset 0px 0px 5px #aaa;-moz-box-shadow:inset 0px 0px 5px #aaa;-webkit-box-shadow:inset 0px 0px 5px #aaa;";return"load"==b?['<div class="chat-view-load-icon" style="',a.STYLE_NBODY,"margin:0 auto;width:100px;height:33px;background:transparent url(",a.imageloading,') no-repeat 0px 0px;"></div><div class="chat-view-load-info" style="',
a.STYLE_BODY,'text-align:center;">',a.lang.chat_info_loading,'</div><div class="chat-view-load-error" style="',a.STYLE_BODY,'text-align:center;margin:120px auto 0;display:none;">',a.lang.chat_info_failure,'<\!--<span style="',a.STYLE_BODY,'cursor:pointer;color:#005ffb;text-decoration:none;">',a.lang.chat_info_reload,"</span>--\></div>"].join(""):"window"==b?['<div class="chat-view-float-history" style="',a.STYLE_BODY,'width:100%;height:270px;height:267px\\0;_height:269px;background:#fff;padding-top:1px solid #fff\\0;position:absolute;overflow:hidden;z-index:99;display:none;box-shadow:0 5px 3px #888888;"><iframe class="chat-view-float-iframe" scrolling="no" frameborder="0" style="',
a.STYLE_BODY,'display:block;width:100%;height:100%;"></iframe></div><div class="chat-view-window-history" style="',a.STYLE_BODY,'width:100%;height:270px;height:267px\\0;_height:269px;background-repeat:no-repeat;background-position:center bottom; padding-top:1px solid #fff\\0;position:relative;overflow-x:hidden;overflow-y:scroll;"><ul style="',a.STYLE_NBODY,'list-style:none;margin:10px 0px 10px 0px;"></ul></div><div class="chat-view-window-toolbar" style="',a.STYLE_BODY,'height:28px;width:100%;border-top:1px solid #d5d5d5;background:#f9f9f9;"><div class="chat-view-hidden-area" style="',
a.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;"><div class="chat-view-window-status-info" style="',a.STYLE_BODY,'background:#66ccff;overflow:hidden;margin-left:10px;width:380px;line-height:30px;height:30px;position:absolute;top:-30px;z-index:99;text-align:center;display:none;"></div></div><div class="chat-view-hidden-area" style="',a.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;"><div class="chat-view-suggest-list chat-view-span" style="',a.STYLE_NBODY,
'border:1px solid #999;background:#fafafa;width:400px;line-height:30px;height:auto;position:absolute;top:-2px;left:2px;z-index:999;display:none;"><ul style="',a.STYLE_BODY,'list-style:none;"></ul></div></div><div class="chat-view-button chat-view-face" title=',a.lang.button_face,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:3px 0 3px 10px;_margin-left:5px;border:0px solid #ccc;height:22px;display:inline-block;cursor:pointer;width:20px;background:url(",a.imageicon,') no-repeat -100px 1px;"><div class="chat-view-hidden-area" style="',
a.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;"><div class="chat-view-span chat-view-window-face" style="',a.STYLE_NBODY,'display:none;position:absolute;left:-11px;top:-229px;border:1px solid #979A9E;width:273px;height:224px;background:#fff;z-index:1000002;cursor:auto;border-radius:3px;overflow:hidden;"></div></div></div><div class="chat-view-button chat-view-image" title=',a.lang.button_image,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",
a.imageicon,') no-repeat -120px 0;"></div><div class="chat-view-button chat-view-file" title=',a.lang.button_file,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",a.imageicon,') no-repeat -140px 0;"></div><div class="chat-view-button chat-view-history" title=',a.lang.button_save,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",
a.imageicon,') no-repeat -180px 0;"></div><div class="chat-view-button chat-view-load-history" title=',a.lang.button_view,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",a.imageicon,') no-repeat -220px -40px;"></div><div class="chat-view-button chat-view-evaluate" title=',a.lang.button_evaluation,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",
a.imageicon,') no-repeat -160px 0;"></div><div class="chat-view-button chat-view-capture" title=',a.lang.button_captureImage,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",a.imageicon,') no-repeat -200px 0;"></div><div class="chat-view-capture-options" style="',a.STYLE_BODY,'color:#525252;float:left;margin:4px 0 4px 0px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;">\u25bc<div class="chat-view-capture-hidden-area" style="',
a.STYLE_NBODY,'width:1px;height:1px;position:relative;overflow:visible;"><div class="chat-view-span chat-view-options-capture-menu" style="',a.STYLE_BODY,'display:none;padding:1px;background:#fff;position:absolute;left:-89px;top:-79px;border:1px solid #ccc;width:100px;*width:102px;_width:102px;height:auto;z-index:1000002;cursor:cursor;"><div class="view-option-hidden talk_selected" style="',a.STYLE_BODY,'padding:3px 0 3px 10px;background:#efefef;">',a.lang.button_capture_hidden_chatWin,'</div><div class="view-option-show" style="',
a.STYLE_BODY,'padding:3px 0 3px 10px;">',a.lang.button_capture_show_chatWin,'</div></div></div></div><div class="chat-view-switch-manual chat-view-robot-button" title="',a.lang.button_switch_manual,'" style="',a.STYLE_BODY,"color:#525252;float:left;padding:0 0 0 20px;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:auto;background:url(",a.imageicon,') no-repeat -265px -40px;display:none;">',a.lang.button_switch_manual,'</div><div class="chat-view-button chat-view-change-csr" title=',
a.lang.button_change_csr,' style="',a.STYLE_BODY,"color:#525252;float:left;margin:4px 0 4px 10px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;width:20px;background:url(",a.imageicon,') no-repeat -243px -40px;"></div><div class="chat-view-button chat-view-exp" style="',a.STYLE_BODY,'color:#525252;float:right;margin:4px 3px;padding:0 3px;border:0px solid #ccc;height:20px;display:inline-block;cursor:pointer;">',a.lang.button_more,' &lt;</div></div><div class="chat-view-window-editor" style="',
a.STYLE_BODY,'height:95px;width:100%;overflow:hidden;"><textarea placeholder="',a.lang.default_textarea_text,'" style="',a.STYLE_BODY,c,'margin:1px;padding:10px;width:391px;width:411px\\9;height:73px;height:93px\\9;outline:0px solid #08f;border:0px solid #08f;color:#ccc;resize:none;overflow:hidden;"></textarea></div><div class="chat-view-window-bottom" style="',a.STYLE_BODY,'height:40px;width:100%;background:#f9f9f9;border-radius:0px 0px 0px 5px;-moz-border-radius:0px 0px 0px 5px;-webkit-border-radius:0px 0px 0px 5px"><div class="chat-view-options" style="',
a.STYLE_BODY,'margin:6px 10px 6px 0;float:right;border:1px solid #ccc;width:14px;height:26px;line-height:25px;text-align:center;cursor:pointer;">\u25bc<div class="chat-view-hidden-area" style="',a.STYLE_NBODY,'width:1px;height:1px;position:relative;overflow:visible;"><div class="chat-view-span chat-view-options-menu" style="',a.STYLE_BODY,'display:none;padding:1px;background:#fff;position:absolute;left:-89px;top:-79px;border:1px solid #ccc;width:100px;*width:102px;_width:102px;height:auto;z-index:1000002;cursor:cursor;"><div class="view-option-enter talk_selected" style="',
a.STYLE_BODY,'padding:3px 0 3px 10px;background:#efefef;">',a.lang.button_enter,'</div><div class="view-option-ctrl+enter" style="',a.STYLE_BODY,'padding:3px 0 3px 10px;">',a.lang.button_ctrl_enter,'</div></div></div></div><div class="chat-view-submit" style="',a.STYLE_BODY,'margin:6px 0;float:right;width:auto;height:26px;line-height:26px;text-align:center;padding:0 25px;border:1px #CCC solid;border-right:none;cursor:pointer;">',a.lang.chat_button_send,'</div><span class="chat-view-end-session" style="',
a.STYLE_BODY,'text-decoration:none;margin:8px 10px 8px 0;padding:0 10px;float:right;height:24px;line-height:24px;cursor:pointer;">',a.lang.button_end_session,'</span><span class="chat-view-xiaoneng-version" style="',a.STYLE_BODY,'display:block;visibility:visible;text-decoration:none;margin:6px 0px 6px 10px;float:left;height:26px;line-height:26px;color:#DDD;">',a.lang.chat_xiaoneng_version,'</span><div style="',a.STYLE_NBODY,'clear:both;"></div></div>'].join(""):"message"==b?['<div class="chat-view-message-announcement" style="',
a.STYLE_BODY,'margin:10px 20px 10px 20px;height:auto;max-height:200px;overflow:hidden;display:none;"></div><div class="chat-view-message-body" style="',a.STYLE_BODY,'overflow-x:hidden;overflow-y:auto;width:100%;"><form name="chat-view-message-form" action="" enctype="multipart/form-data" target="chat-view-submit-iframe" method="post" class="chat-view-message-form" style="',a.STYLE_NBODY,'display:block;">','<input type="hidden" value="'+a.charset+'" name="charset" />','<input type="hidden" value="'+
a.source+'" name="parentpageurl" />','<input type="hidden" value="" name="myuid" /><input type="hidden" value="" name="destuid" /><input type="hidden" value="" name="ntkf_t2d_sid" /><input type="hidden" value="" name="source" />','<input type="hidden" value="'+this.settingid+'" name="settingid" />','<div class="chat-view-message-table" style="',a.STYLE_BODY,'width:100%;"></div></form></div>'].join(""):['<iframe class="ntkf-alert-iframe" style="',a.STYLE_BODY,'display:none;position:absolute;left:0;top:0;width:100%;height:464px;-moz-opacity:0;opacity:0;filter:alpha(opacity=0);z-index:88888;"></iframe><div class="ntkf-alert-background" style="',
a.STYLE_BODY,'display:none;position:absolute;left:0;top:0;width:100%;height:464px;background:#000;-moz-opacity:0.35;opacity:0.35;filter:alpha(opacity=35);z-index:99999;"></div><div class="ntkf-alert-container" style="',a.STYLE_BODY,'display:none;position:absolute;left:2px;top:0;width:100%;min-height:260px;height:auto;-moz-opacity:1;opacity:1;filter:alpha(opacity=100);border:3px solid #00acff;z-index:2000000000;background:#fff;"></div>'].join("")},_bind:function(){var b=this;this.textEditor=this.chatElement.find(".chat-view-window-editor textarea").css({width:a.browser.Quirks?
"411px":"391px",height:a.browser.Quirks?"93px":"73px"}).bind("keypress",function(c){c=a.Event.fixEvent(c);c.stopPropagation();13==c.keyCode&&c.shitfKey||("Enter"==b._sendKey?13==c.keyCode&&c.ctrlKey||10==c.keyCode?b.textEditor.val(b.textEditor.val()+"\r\n"):13==c.keyCode&&(c.preventDefault(),b._send()):"Ctrl+Enter"==b._sendKey&&(/^(10|13)$/.test(c.keyCode)&&c.ctrlKey)&&(c.preventDefault(),b._send()));b._editorStart=b._getPositionForTextArea(this)+1}).bind("keyup",function(c){var c=a.Event.fixEvent(c),
d=c.keyCode;a.enLength(a(this).val())>b.mode.inputMaxByte&&a(this).val(a.enCut(a(this).val(),b.mode.inputMaxByte));38==d?(c.preventDefault(),b._selectSuggest(-1)):40==d&&(c.preventDefault(),b._selectSuggest(1))}).bind("click",function(){b._editorStart=b._getPositionForTextArea(this)}).bind("focus",function(){a.promptwindow.stopPrompt();b.chatElement.find(".chat-view-hidden-area .chat-view-span").display();var c={color:"#000"};a.browser.msie&&7>=a.browser.ieversion?a(this).css(a.merge(c,{width:a(this).parent().width()-
26+"px",height:a(this).parent().height()-26+"px","border-width":"1px"})):a(this).css(a.merge(c,{"outline-width":"1px"}));a.browser.html5||a(this).val()==a.lang.default_textarea_text&&a(this).val("");b._listenTextEditor()}).bind("blur",function(){a.browser.html5||(""===a(this).val()&&a(this).val(a.lang.default_textarea_text),a(this).val()==a.lang.default_textarea_text&&a(this).css({color:"#ccc"}));a.browser.msie&&7>=a.browser.ieversion?a(this).css({"border-width":"0px",width:a(this).parent().width()-
24+"px",height:a(this).parent().height()-24+"px"}):a(this).css({"outline-width":"0"});b._stopListen()}).bind("paste",function(c){(new a.paste(c,function(c){if(c){a.pasteBase64=c;var d=(a(window).height()-510)/2,e=d+480,j=(a(window).width()-640)/2,d=['<div class="pastepic-background" style="width:100%;height:100%;position:absolute;top:0px;left:0px;background-color:#000;opacity:0.6;z-index:5000000;display:none;color:#FFF;"></div><div class="pastepic-container" style="top:',d,"px;left:",j,'px;width:640px;height:480px;background-color:#fff;text-align:center;z-index:5000000;margin:auto;position:absolute;display:none;"><img class="pastepic-show" style="max-width:640px;max-height:480px;" src=""></img></div><div class="pastepic-toolbar" style="top:',
e,"px;left:",j,'px;width:640px;height:30px;position:absolute;z-index:5000000;margin:auto;text-align:right;background-color:transparent;display:none;"><div class="pastepic-toolbar-main" style="width:320px;height:30px;line-height:30px;position:relative;float:right;background-color:#F9F9F9;"><span class="pastepic-describe" style="font-size:12px;font-weight:bold;color:#333333;float:left;margin-left:10px;">\u662f\u5426\u7c98\u8d34\u6b64\u56fe\u7247</span><span class="pastepic-choose-no" style="font-size:12px;color:#333333;cursor:pointer;width:45px;display:inline-block;margin-right:25px;background:url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAANeSURBVDhPXVW/axVBEJ7du7zCMqW1hXX0L0gjRIMWplALRbAIMYnxByiibXgIYhA0gqJgp4JirIMaGxUVbcXOTpuYvNzt3e2O3zf33otxHsfe7c58+83Mt/tcCEEF5iWTqJWNSdTGxifJk5eE0cFLnWDku7d3enksKD8Q1eL0LUk0EDMPB6+SpSiOSIkB3kAbcZiDX1JxPkoCjnexjYMNAW0TD5aIQigCMlF8KzZyFpCA4STHDEfJMB8zW6sHRGBDQEspJgOLf35jA3BBegQdpJhlDTwRorX4ouqninn4DWwIyFfFrs3chNQHdku8eQ4p5+AXAYZaMQaMUtiS+vyEbI2PSrp/zTYimYH9A4hib22KfnoNjl6aZ3el6k4jM3qDKcmUW9IsHJb4YRU+KtWbFyw1SrwNsyPluGtU9Pi8fROmXnkgaXEOqeErbEh5cVLc5zU0A/4oReckGALC/5PyUDaORacnOlovXRJ5ugQgznvJJ09J/PlDGoBlZApanSvLIgdP2WYuY5zBbAMyLS8j5qAuSXProjRPbpuC6Gvlx4ZUUOfysuSHToBdbpFt0/7TIV8bqUzE7HQ235VsakbUNMiKoQxIrXPljvjJkwZGEOp0AOYc8xkaUsPPaonHl0Hc96/cHt3GMnBH2PVv763bFsFThAUTOozZDQG5SwXt8Si5cl3ChcOiX94Zs4SaOTBtPHT46qHU3TMWAzwzhS7JjjYEpM46mkvT25Tq0lEweYtF/PyIZFeXxR2bRVB79NLKQ4mLMxbDhzpNPIM0NoVPGWqtQ6Wb0+O6vs/pxn7RP/u9Fs/vaSgaLctSe91Z3RwTrGNtzGlxc0GrUGhVthhVVaE9fUNCOHK/RD+u4rih0DjL+dV74iZOg0abUs5GHT9r3qxtubaCEYyBYuqgzgYMAxiWVaG9Gwu6fmSPliuPbT6CdVkFLUJpGfQwFnev68bUXg0vH9laKMo+RtBtYVNLihuEZwm78uCTFWvWQX0iSHEOXubTgJY1EO48EDwYtGHKwtsF3Y+KK8sObntdEd+6jNF0h3dcSrzpWhJ0BRHaTtnAwzSFAO4s0CSlzofzrFPW7yaZMzhBRnQd4ZGF7RQ2dEanPCKoz9D2AwtKw+5GziMNB3lt/xVwy5ahc07+ArnLFQPLE82pAAAAAElFTkSuQmCC\') no-repeat 5px 5px">\u5426</span><span class="pastepic-choose-yes" style="font-size:12px;color:#333333;cursor:pointer;width:50px;display:inline-block;margin-right:25px;border:1px solid #cfcfcf;height:20px;line-height:20px;padding:0 8px 0 1px;border-radius:3px;background:url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAKPSURBVDhP1VLNS1VREJ85531oGomaCMFDREmIIgg3FW0qamGLFyUFtXFlRBgIkS500cciigjSvyCiTRS2blHQ8oGtkvSpkGj4kSX4vF9npt+5T7G1u+bCveeemfnNzG9+HIYh7dXM9ndP9v8mi7I/qaqh9LSL6F1KmerPWrJ0/9v5YqlpfOEeYpQMR0Eo5NPUqjpi9vlWRXyaIXW4wWElnB+ZubIYzAu85F4dna7PNRthA6+QoyTtIoV0bMSDMcCc2oXw+9DUxZ/BDyaXVenc112Xb0Zxj02UCXXrw/LYp/X3pDFK+17gMqqUKweTQ1M9q26NNQZWR/2J0cNvEYYGOYyDROhJ+Xpp/WPC7kxj8U7bWC3VOJS10dRG6cHctc1oA80L8fH9p4Y7X+e5DmUTcoYdZ5VXojVHzrL5/Ovd05m+QLdQ9uvvL6Plq5vxHz+22u6GC8Mdb/JcS5rBZHlljuIKsqYrpZHZYiWspBX02IGT5xpvvpwdSDh2xlnh0w3Fu+3jlms0ZR7DGlZoO8Y/WCpvTY7M9FaiZQEPaUjKPGLkbPONW4Vn1mZZHNhIebTgGD5EJeC8vfbI466JpuyhNMsC3HNPdOlg/+2255ZzhEzcbovC+QUKHr8f0GELua6HXRMt+YJJ41C1t3Wwr/CIU/qhFtTw9zvmRUIsaizqQFCWdNUtvZjrXwzmLrcO9LT0QThgiCnx3UJNANoxrkShrU7o+/eNgli/ZIBVW8QXesGLwbF1ZjfZIBN6AiR48kU4D1EJxSKJVxp2xPCwVZw0AU3/GGSIPSMATugNRMesOdaMABbXkrA11SaYs2nbu4b4OFYnFgyzOgyG+cFejI4yIsZkIO6UJxGJ4N3OgxH9Ben/Y4RnXjBoAAAAAElFTkSuQmCC\') no-repeat 5px 0px">\u662f</span></div></div>'].join("");
0==a(".pastepic-background").length&&(a(document.body).append(d),a(".pastepic-choose-no").bind("click",function(){i.display(0);l.display(0);k.display(0)}),a(".pastepic-choose-yes").bind("click",function(){i.display(0);l.display(0);k.display(0);b.objImage.base64Transf(a.pasteBase64)}));var i=a(".pastepic-background"),l=a(".pastepic-container"),k=a(".pastepic-toolbar");a(".pastepic-show").attr("src",c);i.display(1);l.display(1);k.display(1)}})).getImgBase64Str()});""==this.textEditor.val()&&!a.browser.html5&&
this.textEditor.val(a.lang.default_textarea_text);this.chatElement.find(".chat-view-end-session").hover(function(){a(this).css("color","#005fea")},function(){a(this).css("color","#010101")}).click(function(c){a.Event.fixEvent(c).stopPropagation();b._endSession()});var c,d;this.chatElement.find(".chat-view-button,.chat-view-switch-manual").hover(function(b){a.Event.fixEvent(b).stopPropagation();!a(this).attr("talk_disable")&&!a(this).attr("selected")&&(c=a(this).css("background-position").split(" ").shift(),
d=a(this).indexOfClass("chat-view-load-history")||a(this).indexOfClass("chat-view-switch-manual")||a(this).indexOfClass("chat-view-change-csr")?" -60px":" -19px",a(this).css("background-position",c+d))},function(b){a.Event.fixEvent(b).stopPropagation();!a(this).attr("talk_disable")&&!a(this).attr("selected")&&(c=a(this).css("background-position").split(" ").shift(),d=a(this).indexOfClass("chat-view-face")?" 1px":a(this).indexOfClass("chat-view-load-history")||a(this).indexOfClass("chat-view-switch-manual")||
a(this).indexOfClass("chat-view-change-csr")?" -40px":" 0px",a(this).css("background-position",c+d))});this.chatElement.find(".chat-view-face").click(function(c){b.mode.callTrack("10-02-02");a.Event.fixEvent(c).stopPropagation();b.chatElement.find(".chat-view-window-face").display(1);b._initFaceGroup()});this.chatElement.find(".chat-view-image").click(function(c){b.mode.callTrack("10-02-03");a.Event.fixEvent(c).stopPropagation();b._image(c)});this.chatElement.find(".chat-view-file").click(function(c){b.mode.callTrack("10-02-05");
a.Event.fixEvent(c).stopPropagation();b._file(c)});this.chatElement.find(".chat-view-history").click(function(c){a.Event.fixEvent(c).stopPropagation();a(this).attr("talk_disable")||b._download(c)});this.chatElement.find(".chat-view-load-history").click(function(c){a.Event.fixEvent(c).stopPropagation();a(this).attr("talk_disable")||b._viewHistory(!a(this).attr("selected"))});this.chatElement.find(".chat-view-evaluate").click(function(c){b.mode.callTrack("10-02-09");a.Event.fixEvent(c).stopPropagation();
a(this).attr("talk_disable")||b._evaluate(c)});this.chatElement.find(".chat-view-capture").click(function(c){b.mode.callTrack("10-02-04");a.Event.fixEvent(c).stopPropagation();a(this).attr("talk_disable")||b._capture(c)});this.chatElement.find(".chat-view-switch-manual").click(function(c){a.Event.fixEvent(c).stopPropagation();a(this).attr("talk_disable")||b._switchManual(c)});this.chatElement.find(".chat-view-change-csr").click(function(c){a.Event.fixEvent(c).stopPropagation();a(this).attr("talk_disable")||
b._changeCsr(c)});this.chatElement.find(".chat-view-exp").click(function(c){a.Event.fixEvent(c).stopPropagation();b._expansion(c)});this._eventFunction=function(){b._hiddenFloatMenu()};a(document.body).click(this._eventFunction);this.chatElement.find(".chat-view-submit").hover(function(b){a.Event.fixEvent(b).stopPropagation();a(this).css({"background-color":"#F1F1F1"})},function(b){a.Event.fixEvent(b).stopPropagation();a(this).css({"background-color":"none"})});this.chatElement.find(".chat-view-submit").click(function(c){a.Event.fixEvent(c).stopPropagation();
a(this).attr("talk_disable")||b._send(!0)});this.chatElement.find(".chat-view-options").click(function(c){a.Event.fixEvent(c).stopPropagation();b.chatElement.find(".chat-view-hidden-area .chat-view-options-menu").display(1)});this.chatElement.find(".chat-view-capture-options").click(function(c){a.Event.fixEvent(c).stopPropagation();b.chatElement.find(".chat-view-capture-hidden-area .chat-view-options-capture-menu").display(1)});this.chatElement.find(".chat-view-options-menu div").click(function(c){a.Event.fixEvent(c).stopPropagation();
b.chatElement.find(".chat-view-options-menu div").each(function(b,c){a(c).removeClass("talk_selected").css("background","none")});b._sendKey=a(this).indexOfClass("view-option-enter")?"Enter":"Ctrl+Enter";a(this).addClass("talk_selected").css("background","#f1f1f1");a(this).parent().display()});this.chatElement.find(".chat-view-options-capture-menu div").click(function(c){a.Event.fixEvent(c).stopPropagation();b.chatElement.find(".chat-view-options-capture-menu div").each(function(b,c){a(c).removeClass("talk_selected").css("background",
"none")});a.Capture.captureWithMin=a(this).indexOfClass("view-option-hidden")?!0:!1;a(this).addClass("talk_selected").css("background","#f1f1f1");a(this).parent().display()});this.options.chatHeader.find(".header-chatrecord-close").css({margin:"20px 5px 0 0",background:"url("+a.imageicon+") no-repeat -60px 0"}).attr("title",a.lang.chat_button_close).hover(function(){a(this).css("background-position","-60px -20px")},function(){a(this).css("background-position","-60px 0")}).click(function(c){a.Event.fixEvent(c).stopPropagation();
b._viewHistory(!1)})},audioProgress:function(){},_hiddenFloatMenu:function(){this.chatElement.find(".chat-view-hidden-area .chat-view-span").display();this.chatElement.find(".chat-view-capture-hidden-area .chat-view-span").display()},disableButton:function(b,c){var d=this,e=[],b=a.isArray(b)?b:[b];a.each(b,function(a,b){e.push("."+d.buttonSelectors[b])});e=e.join(",");if(c)return-1<e.indexOf("chat-view-image")&&this.chatElement.find(".chat-view-image").find("object,embed,form").css("visibility","hidden"),
-1<e.indexOf("chat-view-file")&&this.chatElement.find(".chat-view-file").find("object,embed,form").css("visibility","hidden"),-1<e.indexOf("chat-view-change-csr")&&a(".chat-view-change-csr").css("background-position-y"," -40px"),this.chatElement.find(e).attr("talk_disable","disable").css("opacity","0.4"),!1;-1<e.indexOf("chat-view-image")&&this.chatElement.find(".chat-view-image").find("object,embed,form").css("visibility","visible");-1<e.indexOf("chat-view-file")&&this.chatElement.find(".chat-view-file").find("object,embed,form").css("visibility",
"visible");this.chatElement.find(e).attr("talk_disable","").css("opacity",1);return!0},displayButton:function(b,c){var d=this,e=[],b=a.isArray(b)?b:[b];a.each(b,function(a,b){e.push("."+d.buttonSelectors[b])});e=e.join(",");this.chatElement.find(e).display(!c)},disabledAudioButton:function(){},_listenTextEditor:function(){var b=this;this._listenTimeID=setInterval(function(){var c=b.textEditor.val(),d=b._cacheListen;!a.browser.html5&&c==a.lang.default_textarea_text&&(c="");500<a.enLength(c)&&(c=a.enCut(c,
500),b.textEditor.val(c),b.textEditor.scrollTop(b.textEditor.scrollHeight()));b._listenNumber++;(c&&d!==c||!c&&d)&&0==b._listenNumber%2&&b.mode.predictMessage(c);b._cacheListen=c},1E3)},_stopListen:function(){this._listenNumber=0;clearInterval(this._listenTimeID);this._listenTimeID=null},_initFaceGroup:function(){var b=this,c,d=a.STYLE_NBODY+"outline:0;float:left;padding:8px;width:23px;height:23px;display:inline;zoom:1;";this._initFace||(this._initFace=!0,this.chatElement.find(".chat-view-face-tags").length||
this.chatElement.find(".chat-view-window-face").append(['<div class="chat-view-face-tags" style="',a.STYLE_NBODY,'background:#F1F1F1;clear:both;padding:0 10px;height:38px;border-top:1px solid #D4D4D4;"></div>'].join("")),a.each(this.mode.config.faces,function(e,f){var g="chat-view-face-group-"+e,h="chat-view-face-tag-"+e;b.chatElement.find("."+g).length||b.chatElement.find(".chat-view-window-face").insert('<div class="'+g+' chat-view-face-group" style="'+a.STYLE_NBODY+(0==e?"":"display:none;")+'overflow-x:hidden;overflow-y:auto;margin:10px 0px 10px 10px;clear:left;height:165px;"></div>',
"afterbegin");a.each(f.pics,function(a,f){var h=a+1,k=0==e?' title="'+f.sourceurl+'"':' title="" sourceurl="'+f.sourceurl+'"';c=d+"border:1px solid #F6FBFE;border-left:1px solid #DFEFF8;border-bottom:1px solid #DFEFF8;background:#F6FBFE;"+(6>=h?"border-top:1px solid #DFEFF8;":"")+(0==h%6?"border-right:1px solid #DFEFF8;":"");b.chatElement.find("."+g).append('<img src="'+f.url+'" '+k+' border="0" style="'+c+'" />')});0==e?a({className:"chat-view-face-tag "+h+" tag-selected",title:f.name,index:"0",
style:a.STYLE_NBODY+"zoom:1;margin:0 5px 0 0;float:left;background:#fff;position:relative;top:-1px;border-left:1px solid #D4D4D4;border-right:1px solid #D4D4D4;"}).appendTo(b.chatElement.find(".chat-view-face-tags")).append('<img src="'+f.icon+'" border="0" style="'+d+'border:none;" />'):a({className:"chat-view-face-tag "+h,title:f.name,index:e,style:a.STYLE_NBODY+"zoom:1;margin:0 5px 0 0;float:left;position:relative;top:0px;border-left:1px solid #f1f1f1;border-right:1px solid #f1f1f1;"}).appendTo(b.chatElement.find(".chat-view-face-tags")).append('<img src="'+
f.icon+'" border="0" style="'+d+'border:none;" />')}),this.chatElement.find(".chat-view-face-group").hover(function(b){a.Event.fixEvent(b).stopPropagation();b=a.Event.fixEvent(b).target;"img"===b.tagName.toLowerCase()&&a(b).css({cursor:"pointer","background-color":"#FFF"})},function(b){a.Event.fixEvent(b).stopPropagation();b=a.Event.fixEvent(b).target;"img"===b.tagName.toLowerCase()&&a(b).css({"background-color":"#F6FBFE"})}).click(function(c){a.Event.fixEvent(c).stopPropagation();c=a.Event.fixEvent(c).target;
"img"===c.tagName.toLowerCase()&&(b.chatElement.find(".chat-view-window-face").display(),a(this).indexOfClass("chat-view-face-group-0")?b._insertText("["+a(c).attr("title")+"]"):(a.Log("selected current face:"+a(c).attr("sourceurl")),b.mode.send({type:2,emotion:1,msg:"current face",url:a(c).attr("src"),sourceurl:a(c).attr("sourceurl"),oldfile:"",size:"",extension:""})))}),this.chatElement.find(".chat-view-face-tags").hover(function(b){a.Event.fixEvent(b).stopPropagation();b=a.Event.fixEvent(b).target;
b="img"==b.tagName.toLowerCase()?b.parentNode:b;a(b).indexOfClass("chat-view-face-tag")&&!a(b).indexOfClass("tag-selected")&&a(b).css({"background-color":"#fafafa",top:"-1px","border-left":"1px solid #D4D4D4","border-right":"1px solid #D4D4D4","margin-right":"5px",zoom:"1"})},function(b){a.Event.fixEvent(b).stopPropagation();b=a.Event.fixEvent(b).target;b="img"==b.tagName.toLowerCase()?b.parentNode:b;a(b).indexOfClass("chat-view-face-tag")&&!a(b).indexOfClass("tag-selected")&&a(b).css({"background-color":"transparent",
top:"0px","border-left":"1px solid #f1f1f1","border-right":"1px solid #f1f1f1","margin-right":"5px",zoom:"1"})}).click(function(c){a.Event.fixEvent(c).stopPropagation();c=a.Event.fixEvent(c).target;c="img"==c.tagName.toLowerCase()?c.parentNode:c;a(c).indexOfClass("chat-view-face-tag")&&(b.chatElement.find(".chat-view-face-tag").css({"background-color":"transparent",top:"0px","border-left":"1px solid #f1f1f1","border-right":"1px solid #f1f1f1","margin-right":"5px",zoom:"1"}).removeClass("tag-selected"),
b.chatElement.find(".chat-view-face-group").display(),a(c).css({"background-color":"#fff",top:"-1px","border-left":"1px solid #D4D4D4","border-right":"1px solid #D4D4D4","margin-right":"5px",zoom:"1"}).addClass("tag-selected"),b.chatElement.find(".chat-view-face-group-"+a(c).attr("index")).display(1))}))},_contentFilter:function(b){if("string"!==typeof b.msg||/\<.*?\>/gi.test(b.msg))return 1==b.type&&/<img(.*?)src=([^\s]+)(.*?)>/gi.test(b.msg)&&(b.msg=b.msg.replace(/<img(.*?)src=([^\s]+)(.*?)>/gi,
'<img class="ntalk-preview" src="'+a.imageloading+'" sourceurl=$2 style="'+a.STYLE_NBODY+'" />')),b;b.msg=b.msg.replace(/[\r\n]/ig," <br>");b.msg=b.msg.replace(/(\s{2})/ig," {$null}");b.msg=a.myString(b.msg).linkFilter1(a.STYLE_BODY+"color:#0a8cd2;");b.msg=b.msg.replace(/\{\$null\}/ig,"&nbsp;&nbsp;");b.msg=b.msg.replace(/\t/ig,"&nbsp;&nbsp;&nbsp;&nbsp;");b.msg=a.utils.handleLinks(b.msg,{settingid:this.settingid});b.msg=this._faceFilter(b.msg);return b=a.extend({color:"000000",fontsize:"12",bold:"false",
italic:"false",underline:"false"},b)},_faceFilter:function(b){var c=b.match(/\[([a-z]+)\]/ig),d=function(b){var c=null;a.each(a.lang.editorFaceAlt,function(a,d){d&&RegExp(b.replace(/\[/,"\\[").replace(/\]/,"\\]"),"gi").test("["+d+"]")&&(c=a)});return c};if(!c||!b)return b;for(var e,f=0;f<c.length;f++)if(e=d(c[f]))b=b.replace(c[f],'<img src="'+a.sourceURI+"images/faces/"+e+(a.browser.msie6?".gif":".png")+'" style="'+a.STYLE_NBODY+'width:23px;height:23px;margin:0 2px;display:inline;vertical-align:text-bottom;" />');
return b},_image:function(){},_file:function(){},_download:function(){this.mode.download&&this.mode.download(this.settingid)},_viewHistory:function(a){this.mode.viewHistory&&(a?this.chatElement.find(".chat-view-load-history").attr("selected","selected").css("background-position","-220px -60px"):this.chatElement.find(".chat-view-load-history").attr("selected","").css("background-position","-220px -40px"),this._tempHeader.display(!a),this._chatsHeader.display(a),this._chatsElement.css({height:this.chatHistory.height()+
"px"}).display(a),a&&this.mode.viewHistory(this.settingid,this._chatsElement.find("IFRAME.chat-view-float-iframe").get(0)))},_evaluate:function(){this.mode.showEvaluation&&this.mode.showEvaluation()},_capture:function(){this.mode.startCapture&&this.mode.startCapture(this.settingid)},_switchManual:function(){this.mode.switchServerType&&this.mode.switchServerType(!0,this.settingid)},_changeCsr:function(){this.mode.changeCustomerServiceInfo&&this.mode.changeCustomerServiceInfo()},_expansion:function(){this.options.toggleExpansion(this.settingid)},
updateMore:function(b){this.chatElement.find(".chat-view-exp").html(a.lang.button_more+(b?" &lt;":" &gt;"))},switchToolbar:function(b){var c=this;a.Log("nTalk.chat.view.switchToolbar("+b+")");b?(this.chatElement.find(".chat-view-button,.chat-view-capture-options").each(function(){var b=a(this).indexOfClass("chat-view-capture-options");(!b&&"disable"!=a(this).attr("talk_disable")||b&&"block"==c.chatElement.find(".chat-view-capture").css("display"))&&a(this).display(1)}),this.displayButton("csr",1!=
this.mode.config.changecsr),this.displayButton("history",1!=this.mode.config.chatingrecord),this.displayButton("loadhistory",1!=this.mode.config.viewchatrecord),this.displayButton(["capture","capoptions"],0==this.mode.config.captureimage),this.displayButton("evaluate",0==this.mode.config.evaluation),this.chatElement.find(".chat-view-exp").display(this.mode._moreData&&this.mode._moreData.length),this.chatElement.find(".chat-view-switch-manual").display()):(this.chatElement.find(".chat-view-button,.chat-view-capture-options").each(function(){a(this).display()}),
this.chatElement.find(".chat-view-exp").display(this.mode._moreData&&this.mode._moreData.length),this.chatElement.find(".chat-view-switch-manual").display(1))},_send:function(b){this.chatElement.find(".chat-view-hidden-area .chat-view-suggest-list").display();if(/QUERY|QUEUE/i.test(this.mode.statusConnectT2D))return!1;var c=this._clearEditor();c.length&&c!=a.lang.default_textarea_text&&this.mode.send(c);!a.browser.html5&&!0===b&&this.textEditor.css({color:"#ccc"}).val(a.lang.default_textarea_text).get(0).focus();
a.fn.isReaded()},_endSession:function(){this.mode.endSession()},_clearEditor:function(){var a=this.textEditor.val().replace(/(^\s*)|(\s*$)/g,"");this.textEditor.val("");return a},callChatResize:function(a,c){this.chatHistory.find("ul").css({width:a-2+"px"});this.chatHistory.css({height:c-165+"px"});this.chatElement.find(".chat-view-float-history, .chat-view-float-history iframe").css({height:c-165+"px"});this.chatElement.find(".chat-view-window-status-info").css("width",a-40+"px");this.evalDialog&&
this.evalDialog.resize();this.textEditor.css({width:a-22+"px"});this.scroll&&this.scroll.resizeScroll()},changeQueueStyle:function(){return!1},audioView:function(b){if(!this.msgid&&a.musicEl)a.musicEl.emit(),a.musicEl=null;else{var c=this.msgid,d=this.duration,e=a("."+c).find(".view-history-body"),f,g,h;-1<c.indexOf("J")?(f=a.sourceURI+"images/mySound.png",g="#CEF2FF",h="left",durationAlign="right"):(f=a.sourceURI+"images/kfSound.png",g="#FFFFFF",h="right",durationAlign="left");switch(b){case "init":a.Log("[nTalk music]: mp3 view init, msgid is "+
c);b=['<div id="duration_',c,'" style="',a.STYLE_BODY,"height:24px;line-height:24px;padding:4px 4px 0px;float:",durationAlign,'" >',d,"''</div><div id=\"player_",c,'" style="',a.STYLE_BODY," width:80px;height:24px;padding:4px 0;background:",g,";border-radius:5px;border: none;text-align:",h,'"><img width="24px" height="24px" src="',f,'"/></div>'].join("");e.parent().css("padding","0px");e.append(b);a.browser.msie&&7>=a.browser.ieversion&&(a("#player_"+c).css("width","50px"),a("."+c).find("table").css("width",
"100px"));break;case "play":a.Log("[nTalk music]: mp3 view play, msgid is "+c);a.musicEl&&(a.Log("[nTalk music]: stop playing mp3 view, msgid is "+a.playMsgid,2),a.musicEl.emit());a.musicEl=this;c=a("#player_"+c+" img")[0];c.src=c.src.replace("png","gif");break;case "stop":a.Log("[nTalk music]: mp3 view stop, msgid is "+c),a.musicEl=null,c=a("#player_"+c+" img")[0],c.src=c.src.replace("gif","png")}}},audioBindEvent:function(b){var c=this.msgid;switch(b){case "init":a.Log("[nTalk music]: mp3 event init, msgid is "+
c);var d=this;a("#player_"+c).click(function(){a.Log("[nTalk music]: mp3 trigger click, msgid is "+c);d.emit()})}}};a.minimizeView=a.Class.create();a.minimizeView.prototype={_width:0,_height:0,_isMessageView:!1,element:null,title:"",status:0,count:0,initialize:function(b,c,d){var e=this;a.Log("new nTalk.minimizeView()",1);this.status=b.status||0;this._isMessageView=c;this.callback=d||new Function;this.element=a(".ntalk-minimize-window");this._width=213;this._height=44;this.element.length||(this.element=
a({className:"ntalk-minimize-window",style:a.STYLE_BODY+"width:"+(this._width-2)+"px;height:"+(this._height-2)+"px;border:1px solid #c8c7c6;background:#e5e5e4;cursor:pointer;z-Index:2000000000;"}).appendTo(!0).gradient("top","#e5e5e4","#f2f3f3").fixed({left:a(window).width()-this._width-2,top:a(window).height()-this._height-2}).html(['<div class="ntalk-minimize-icon" style="',a.STYLE_BODY,"float:left;margin:4px 8px;_margin:4px 4px;width:35px;height:35px;background:url(",a.imageicon,') no-repeat -383px -8px;"></div><div class="ntalk-minimize-title" style="',
a.STYLE_BODY,'float:left;margin:4px 0;line-height:35px;overflow:hidden;width:160px;height:35px;max-width:162px;"></div><div style="',a.STYLE_NBODY,'clear:both;"></div>'].join("")));a(window).bind("resize",function(a){e._fiexd(a)});this.update(b.name||"",b.logo||"");if(this.status)this.online();else this.offline();this.element.click(function(b){a.Event.fixEvent(b).stopPropagation();e.remove()})},online:function(){this.element.find(".ntalk-minimize-icon").css("opacity",1)},offline:function(){this.element.find(".ntalk-minimize-icon").css("opacity",
0.5)},update:function(b,c){this.title=b?a.utils.handleLinks(a.lang.toolbar_min_title,{destname:b}):a.lang.toolbar_default_text;this.element.find(".ntalk-minimize-title").html(this.title);if(c&&c!=a.CON_SINGLE_SESSION){var d=this,e;a.require(c+"#image",function(b){b.error?a.Log("load logo:"+c,2):(e=a.zoom(b,35,35),d.element.find(".ntalk-minimize-icon").css("background-position","-500px -8px").html('<img src="'+c+'" width="'+e.width+'" height="'+e.height+'" style="'+a.STYLE_NBODY+"margin:"+(35-e.height)/
2+"px "+(35-e.width)/2+"px;width:"+e.width+"px;height:"+e.height+'px;" />'))})}else this.element.find(".ntalk-minimize-icon").css("background-position","-383px -8px")},remove:function(){a(window).removeEvent("resize",this._fiexd);this.stopFlicker();this.element.remove();this.callback()},startFlicker:function(b,c){var d=this,e=99<this.count?"99+":this.count,f=b?1E3:500,c=c||0;b===q&&this.stopFlicker(!0);a.Log("$.minView.startFlicker("+a.JSON.toJSONString(arguments)+") timeid:"+this.timeID,1);b?this.element.css({"border-color":"#d55f01"}).gradient("top",
"#ff8803","#ff7b16"):this.element.css({"border-color":"#c8c7c6"}).gradient("top","#e5e5e4","#f2f3f3").find(".ntalk-minimize-title").html(a.utils.handleLinks(a.lang.toolbar_min_news,{count:'<span style="'+a.STYLE_BODY+'color:#fff;font-weight:bold;">'+e+"</span>"}));7<=c||(this.timeID=setTimeout(function(){c++;d.startFlicker(!b,c)},f))},stopFlicker:function(b){a.Log("$.minView.stopFlicker()",1);clearTimeout(this.timeID);this.timeID=null;b||(this.count=0);this.element.find(".ntalk-minimize-icon").css("background-position",
"-98px -38px");this.element.css({"border-color":"#d55f01"}).gradient("top","#e5e5e4","#f2f3f3").find(".ntalk-minimize-title").html(this.title)},_fiexd:function(){(this.element=a(".ntalk-minimize-window"))&&this.element.length&&this.element.fixed({width:this.width-2,height:this.height-2,left:a(window).width()-this.width-2,top:a(window).height()-this.height-2})}};a.fn.extend({isReaded:function(){a.chatManage&&(a.chatManage.get()&&a.chatManage.get().view&&a.chatManage.get().view.receiveMsgCount)&&(a.chatManage.get().view.receiveMsgCount=
0);a.im&&(a.im.receiveMsgCount=0);"function"==typeof window.webInfoChanged&&webInfoChanged(400,'{"num":0, "showNum":1}',!1)}});a.chatManageView=a.Class.create();a.chatManageView.prototype={name:"chatManageView",defaultOptions:{dropHeight:55,width:415,height:465,minWidth:415,minHeight:520,leftElementWidth:140,rightElementWidth:200,resizeHeight:595,drag:!0,resize:!1,fixed:!0,zIndex:1E6},_flickerTimeID:[],_objView:null,_manageMode:null,tagKey:"",tagTitle:"",extended:null,options:null,header:null,body:null,
leftContent:null,leftElement:null,chatBody:null,chatContainter:null,rightElement:null,chatWidth:0,chatHeight:0,CON_ICON_WIDTH:53,CON_ICON_HEIGHT:53,initialize:function(b,c){this.options=a.extend({},this.defaultOptions,b);this.extended={leftElement:!1,rightElement:!1};this._manageMode=c;this._getChatPosition(b.position||{});this._create();this._bind()},close:function(){a.Log("nTalk.chatManageView.close()",1);try{a.browser.oldmsie?this._objView.containter.display():this._objView.containter.remove()}catch(b){a.Log(b,
3)}},addChatTag:function(b){var c=this;this.leftContent&&(this.tagKey=b,this.tagTitle=a.lang.toolbar_default_text,b=a({tag:"li",style:a.STYLE_NBODY+"margin:5px 0 0 5px;list-style:none;border:1px solid #fafafa;border-right:none;position:relative;cursor:pointer;",className:this.tagKey,key:this.tagKey}).appendTo(this.leftContent).html(['<div class="tag-head-icon" style="',a.STYLE_NBODY,'width:12px;height:12px;overflow:hidden;position:absolute;left:0;margin:11px 0px 11px 11px;background:#666;"></div><div class="tag-content-text" style="',
a.STYLE_BODY,'margin-left:30px;height:35px;line-height:35px;overflow:hidden;">',this.tagTitle,'</div><div class="tag-button-close" style="',a.STYLE_NBODY,'width:15px;height:15px;position:absolute;left:110px;top:10px;"></div>'].join("")).click(function(a){c._onSwitchChat(this,a)}).hover(this._onOverChatTag,this._onOutChatTag),this._onSelectedChatTag(b),b.find("div.tag-button-close").click(function(a){c._onCloseChatTag(this,a)}),1<this.leftContent.find("li").length&&!this.extended.leftElement&&this.toggleExpansion("leftElement",
!0),this.leftBody.scrollTop(this.leftBody.scrollHeight()))},removeChatTag:function(a){this.leftContent.find("li."+a).remove();1>=this.leftContent.find("li").length&&this.extended.leftElement&&this.toggleExpansion("leftElement",!1)},updateChatTag:function(b,c,d){var e=this.header.find(".chat-header-icon"),f=this.header.find(".chat-header-name"),g=this.header.find(".chat-header-sign");this.leftContent.find("li."+b+" .tag-head-icon").css("background-color",1!==c.status?"#666":"#060");!0!==d&&(this.leftContent.find("li."+
b+" .tag-content-text").html(c.id==a.CON_SINGLE_SESSION?a.lang.toolbar_default_text:c.name),c.id?(a.CON_MULTIPLAYER_SESSION===c.logo?c.logo=a.imagemultiplayer:a.CON_SINGLE_SESSION===c.logo&&(c.logo=a.imagesingle),e.css("visibility","visible").css("background-image","none"),!e.find("img").length||e.find("img").attr("src")!=c.logo?e.html('<img data-single="1" onerror="nTalk.loadImageAbnormal(this, event)" src="'+c.logo+'" border="0" width="'+c.attr.width+'" height="'+c.attr.height+'" style="'+a.STYLE_NBODY+
"margin:"+(this.CON_ICON_HEIGHT-c.attr.height)/2+"px "+(this.CON_ICON_WIDTH-c.attr.width)/2+"px;width:"+c.attr.width+"px;height:"+c.attr.height+'px;background:#fff;" />'):e.find("img").attr({"data-single":a.CON_MULTIPLAYER_SESSION!=c.logo?"1":"0",width:c.attr.width,height:c.attr.height}).css({margin:(this.CON_ICON_HEIGHT-c.attr.height)/2+"px "+(this.CON_ICON_WIDTH-c.attr.width)/2+"px",width:c.attr.width+"px",height:c.attr.height+"px"}),0==c.status&&a.CON_SINGLE_SESSION!==c.id?e.find("img").css("opacity",
"0.5"):e.find("img").css("opacity","1"),f.css("visibility","visible").html(c.title||c.name),b=Math.max(0,this.header.width()-f.width()-165),g.css("visibility","visible").attr("title",c.sign).css("width",b+"px").html(c.sign)):this.header.find(".chat-header-icon,.chat-header-name,.chat-header-sign").css("visibility","hidden"))},switchChatTag:function(b){var c=a("li."+b,this.leftContent);c.length&&this._onSelectedChatTag(c);this._manageMode.callSwitchChat(b)},toggleExpansion:function(b,c){!1===a.inArray(["leftElement",
"rightElement"],b)&&(b="leftElement");c=a.isBoolean(c)?c:!this.extended[b];"rightElement"===b?(c?(this[b].css({width:this.options.rightElementWidth+"px",display:"block"}),this.chatWidth=this.options.width+this.options.rightElementWidth):c||(this[b].css({width:this.options.rightElementWidth+"px",display:"none"}),this.chatWidth=this.options.width),this.extended[b]=c,this.chatHeight=this.options.height+this.options.dropHeight,this.chatWidth+=this.extended.leftElement?this.options.leftElementWidth:0):
(c?(this.chatWidth=this.options.width+this.options.leftElementWidth,this[b].css("display","block"),this.chatContainter.css("border-bottom-left-radius","0px")):c||(this.chatWidth=this.options.width,this[b].css("display","none"),this.chatContainter.css("border-bottom-left-radius","5px")),this.extended[b]=c,this.chatWidth+=this.extended.rightElement?this.options.rightElementWidth:0);this._objView.minWidth=this.defaultOptions.width+(this.extended.leftElement?this.options.leftElementWidth:0)+(this.extended.rightElement?
this.options.rightElementWidth:0);this.headBody.css("width",this.chatWidth+"px");this.body.css("width",this.chatWidth-(this.extended.rightElement?this.options.rightElementWidth:0)+"px");this._objView.changeAttr(this.chatWidth,this.chatHeight);return this.extended[b]},updateRightData:function(b,c){var d=this,e=!1;this.settingid=b;!c||!c.length?this.toggleExpansion("rightElement",!1):(this._clearTag(),a.each(c,function(a,b){b.data&&b.data.length&&(!0==b.selected&&(e=!0),!e&&a==c.length-1&&(b.selected=
!0),d._addRightLabel(b.title,b.data,c.length,b.selected))}),this._bindTag())},updateViewStatus:function(){},updataSkin:function(b,c,d){var e=/^#[0-9a-f]{6}$/i;c==d?e.test(c)?(d=a.toHSL(c).l,this.headBody.css({background:c,color:0.75>d?"#fff":"#525252"}),this.rightElement.find(".window-right-head").css({background:c,color:0.75>d?"#fff":"#525252"})):(this.headBody.css({background:"url("+c+") repeat"}),this.rightElement.find(".window-right-head").css({background:"url("+c+") repeat"})):(this.headBody.gradient("top",
c,d),this.rightElement.find(".window-right-head").gradient("top",c,d));(c=this._manageMode.get())&&e.test(b)?c.view.chatElement.find(".chat-view-window-history").css("background-color",b):c&&b&&c.view.chatElement.find(".chat-view-window-history").css("background-image","url("+b+")")},minimize:function(a){this._objView.minimize(a)},maximize:function(a){this._objView.maximize(a)},hidden:function(){this._objView.minimize(null,!0);a.Log("chatManageView.hidden:"+this._objView.containter.css("visibility"),
2)},visible:function(){this._objView.maximize(null,!0);a.Log("chatManageView.visible:"+this._objView.containter.css("visibility"),2)},labelFlicker:function(a,c,d){var e=this,f=c?1E3:500,d=d||0;c===q&&this.stopFlicker(a);c?this.leftContent.find("."+a).css({"background-color":"#FE800F"}).addClass("talk_flicker"):this.leftContent.find("."+a).css({"background-color":"#fafafa"}).addClass("talk_flicker");7<=d||(this._flickerTimeID[a]=setTimeout(function(){d++;e.labelFlicker(a,!c,d)},f))},stopFlicker:function(a){clearTimeout(this._flickerTimeID[a]);
this._flickerTimeID[a]=null;this.leftBody.find("."+a).css({"background-color":"#fafafa"}).removeClass("talk_flicker")},_create:function(){var b=this,c=a.extend({},this.options,{width:this.options.width,height:this.options.height+this.options.dropHeight,minWidth:this.defaultOptions.minWidth,minHeight:this.defaultOptions.minHeight});this._objView=new a.Window(a.extend({onChanage:function(a){b._callResize.call(b,a)},onClose:function(){b._callClose.call(b)},onMinimize:function(){b._callMinimize.call(b)},
onMaximize:function(){b._callMaximize.call(b)},onMaxResize:function(){b._callMaxResize.call(b)}},c));this.header=this._objView.header;this.body=this._objView.body;this.chatWidth=this.options.width;this.chatHeight=this.options.height+this.options.dropHeight;this._objView.buttonClose.hover(function(){a(this).css("background-position","-60px -20px")},function(){a(this).css("background-position","-60px 0")}).attr("title",a.lang.chat_button_close).css({margin:"20px 5px 0 0",background:"url("+a.imageicon+
") no-repeat -60px 0"});this._objView.buttonResize&&this._objView.buttonResize.css({width:"12px",height:"15px",background:"url("+a.imageicon+") no-repeat -298px -5px"});this._objView.buttonMax.hover(function(){var b=a(this).css("background-position").split(" ").shift();a(this).css("background-position",b+" -20px")},function(){var b=a(this).css("background-position").split(" ").shift();a(this).css("background-position",b+" 0")}).css({margin:"20px 5px 0 0",background:"url("+a.imageicon+") no-repeat -40px 0"}).attr("title",
a.lang.chat_button_resize_max);this._objView.buttonMin.hover(function(){a(this).css("background-position","-1px -20px")},function(){a(this).css("background-position","-1px 0")}).css({margin:"20px 5px 0 0",background:"url("+a.imageicon+") no-repeat -1px 0"}).attr("title",a.lang.chat_button_min);this.headBody=a({className:"chat-header-body",style:a.STYLE_BODY+"background:#ebe9e9;z-index:0;color:#525252;"}).appendTo(this.header,!0).css({position:"absolute","border-top":"1px solid #5f6467","border-left":"1px solid #5f6467",
"border-right":"1px solid #5f6467","border-bottom":"0",top:"13px","border-right":"1px solid #5f6467","border-radius":"5px 5px 0px 0px","-moz-border-radius":"5px 5px 0px 0px","-webkit-border-radius":"5px 5px 0px 0px",width:this.options.width-2+"px",height:this.options.dropHeight-13+"px"});this.headName=a({tag:"span",className:"chat-header-name",style:a.STYLE_BODY+"color:#ffffff;margin:10px 0px 10px 80px;display:inline-block;float:left;height:20px;line-height:20px;max-width:220px;visibility:hidden;overflow:hidden;font-weight:bold;cursor:auto;font-size:12px;color:#fff;"}).appendTo(this.headBody).html("");
this.headSign=a({tag:"span",className:"chat-header-sign",style:a.STYLE_BODY+"color:#c3c3c3;margin:10px 0px 10px 10px;display:inline-block;float:left;height:20px;line-height:20px;visibility:hidden;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;cursor:auto;"}).appendTo(this.headBody);this.headIcon=a({tag:"div",className:"chat-header-icon",style:a.STYLE_NBODY+"visibility:hidden;border-radius:0px;overflow:hidden;background:url("+a.imageicon+");background-repeat:no-repeat;background-position:-374px 0; background-color:#ffffff;position:absolute;left:20px;top:0px;width:"+
this.CON_ICON_WIDTH+"px;height:"+this.CON_ICON_HEIGHT+"px;border:1px solid #5f6467;z-index:1;"}).appendTo(this.header,!0);this.chatBody=this._objView.chatBody;this.leftElement=a({className:"body-chat-tags",style:a.STYLE_NBODY+"display:none;float:left;background:#fafafa;overflow:hidden;"}).css({"border-left":"1px solid #5f6467","border-bottom":"1px solid #5f6467","border-radius":"0px 0px 0px 5px",width:this.options.leftElementWidth-1+"px",height:this.options.height-1+"px"}).appendTo(this.chatBody);
this.chatContainter=a({className:"body-chat-containter",style:a.STYLE_NBODY+"float:left;overflow:hidden;background:#fff;"}).css({"border-right":"1px solid #5f6467","border-bottom":"1px solid #5f6467","border-left":"1px solid #5f6467","border-radius":"0px 0px 0px 5px","-moz-border-radius":"0px 0px 0px 5px","-webkit-border-radius":"0px 0px 0px 5px",width:+this.options.width-2+"px",height:+this.options.height-1+"px"}).appendTo(this.chatBody);a({style:a.STYLE_NBODY+"clear:both;"}).appendTo(this.chatBody);
this.rightElement=this._objView.rightElement.css({width:this.options.rightElementWidth+"px"});this.rightBody=a({className:"window-right-body",style:a.STYLE_BODY+"width:199px;background:#fff;"}).css({"border-right":"1px solid #5f6467","border-bottom":"1px solid #5f6467",height:+this.options.height-1+"px","border-radius":"0px 0px 5px 0px","-moz-border-radius":"0px 0px 5px 0px","-webkit-border-radius":"0px 0px 5px 0px"}).appendTo(this.rightElement);this.buttonScrollTop=a({tag:"div",className:"nTalk-scroll-top",
style:a.STYLE_NBODY+"height:20px;width:100%;z-index:99;background:url("+a.imageicon+") no-repeat 20px -92px;display:block;cursor:pointer;"}).appendTo(this.leftElement);this.leftBody=a({tag:"div",className:"nTalk-scroll-body",style:a.STYLE_NBODY+"overflow:hidden;height:424px;"}).appendTo(this.leftElement);this.leftContent=a({tag:"ul",className:"ntalke-scroll-content",style:a.STYLE_NBODY}).appendTo(this.leftBody);this.buttonScrollBottom=a({tag:"div",className:"nTalk-scroll-bottom",style:a.STYLE_NBODY+
"height:20px;width:100%;z-index:99;background:url("+a.imageicon+") no-repeat 20px -108px;display:block;cursor:pointer;"}).appendTo(this.leftElement)},_bind:function(){var b=this;this.buttonScrollTop.click(function(){b._verificationScroll(!0)&&b.leftBody.scrollTop(b.leftBody.scrollTop()-40)}).hover(function(){b._verificationScroll(!0)&&a(this).css("background-position","-79px -92px")},function(){a(this).css("background-position","20px -92px")});this.buttonScrollBottom.click(function(){b._verificationScroll(!1)&&
b.leftBody.scrollTop(b.leftBody.scrollTop()+40)}).hover(function(){b._verificationScroll(!1)&&a(this).css("background-position","-79px -108px")},function(){a(this).css("background-position","20px -108px")})},_onOverChatTag:function(){for(var b=this;"LI"!==b.tagName.toUpperCase();)b=b.parentNode;a(b).find(".tag-button-close").css({background:"url("+a.imageicon+") no-repeat -159px -39px"});a(b).indexOfClass("talk_flicker")||a(b).css({"border-top":"1px solid #ccc","border-bottom":"1px solid #ccc","border-left":"1px solid #ccc",
left:"1px",background:"#fff"})},_onOutChatTag:function(){for(var b=this;"LI"!==b.tagName.toUpperCase();)b=b.parentNode;a(b).find(".tag-button-close").css({background:"none"});a(b).indexOfClass("talk_flicker")||a(b).indexOfClass("talk_selected")||a(b).css({"border-top":"1px solid #fafafa","border-bottom":"1px solid #fafafa","border-left":"1px solid #fafafa",left:"0px",background:"#fafafa"})},_onSelectedChatTag:function(b){var c=this;a("li",this.leftContent).each(function(b,e){a(e).removeClass("talk_selected");
a(e).indexOfClass("talk_flicker")||c._onOutChatTag.apply(e)});this.stopFlicker(a(b).attr("key"));a(b).addClass("talk_selected").css({"border-top":"1px solid #ccc","border-bottom":"1px solid #ccc","border-left":"1px solid #ccc",left:"1px",background:"#fff"})},_callResize:function(a){var c=a.width,d=a.height;this.extended.leftElement&&(c-=this.options.leftElementWidth);this.extended.rightElement&&(c-=this.options.rightElementWidth);this.options.width=c;this.options.height=d-this.options.dropHeight;
this.headBody.css("width",a.width-2+"px");this.body.css("width",this.options.width+(this.extended.leftElement?this.options.leftElementWidth:0)+"px");this.leftElement.css({width:this.options.leftElementWidth-1+"px",height:this.options.height-1+"px"});this.leftBody.css("height",this.options.height-40+"px");this.chatContainter.css({width:this.options.width-2+"px",height:this.options.height-1+"px"});this.rightBody.css({height:this.options.height-1+"px"});a=this.options.height-29;this.rightElement.find(".view-right-content").css({height:a+
"px"});this.rightElement.find(".window-right-content iframe").attr("height",a).css({height:a+"px"});this._manageMode.callManageResize(this.options.width,this.options.height)},_callMaxResize:function(){var b=this.options.height<this.defaultOptions.resizeHeight;this.chatHeight=this.options.dropHeight+(b?this.defaultOptions.resizeHeight:this.defaultOptions.height);this._objView.changeAttr(this.chatWidth,this.chatHeight);b?this._objView.buttonMax.css("background-position","-20px 0").attr("title",a.lang.chat_button_resize_min):
this._objView.buttonMax.css("background-position","-40px 0").attr("title",a.lang.chat_button_resize_max);this._callResize({width:this.chatWidth,height:this.chatHeight})},_callMaximize:function(){},_callClose:function(){this._manageMode.close()},_callMinimize:function(){this._manageMode.callMinimize()},_onSwitchChat:function(b,c){var d=a(b).attr("key");a.Event.fixEvent(c).stopPropagation();this._onSelectedChatTag(b);this._manageMode.callSwitchChat(d)},_onCloseChatTag:function(b,c){var d;d=b;for(a.Event.fixEvent(c).stopPropagation();"LI"!==
d.tagName.toUpperCase();)d=d.parentNode;a(d).removeClass("talk_selected");d=d.className.replace(/^\s*|\s*$/g,"")||"";this._manageMode.closeChat(d)},_getChatPosition:function(b){var c;if(!b||a.isEmptyObject(b))this.options.left=Math.max(0,a(window).width()-this.options.width),this.options.top=Math.max(0,a(window).height()-this.options.height-this.options.dropHeight);else if(b.rightline&&b.width)this.options.left=Math.max(0,(a(window).width()-b.width)/2+b.width-this.options.width),this.options.top=
Math.max(0,a(window).height()-this.options.height-this.options.dropHeight);else if((b.id||b.entryid)&&a.isDefined(b.left)&&a.isDefined(b.left))c=b.id||b.entryid||"",c=/(^[#\.])|\s+/gi.exec(c)?c:"#"+c,a(c).length?(c=a(c).offset(),b.left=b.left||0,b.top=b.top||0,this.options.left=Math.min(c.left-this.options.width+b.left,a(window).width()-this.options.width),this.options.top=Math.min(c.top+b.top,a(window).height()-this.options.height-this.options.dropHeight)):(this.options.left=Math.max(0,a(window).width()-
this.options.width),this.options.top=Math.max(0,a(window).height()-this.options.height-this.options.dropHeight));else{switch(b.position){case "left-top":this.options.left=0;this.options.top=0;break;case "center-top":this.options.left=Math.max(0,(a(window).width()-this.options.width)/2);this.options.top=0;break;case "right-top":this.options.left=Math.max(0,a(window).width()-this.options.width);this.options.top=0;break;case "left-center":this.options.left=0;this.options.top=Math.max(0,(a(window).height()-
this.options.height-this.options.dropHeight)/2);break;case "center-center":this.options.left=Math.max(0,(a(window).width()-this.options.width)/2);this.options.top=Math.max(0,(a(window).height()-this.options.height-this.options.dropHeight)/2);break;case "right-center":this.options.left=Math.max(0,a(window).width()-this.options.width);this.options.top=Math.max(0,(a(window).height()-this.options.height-this.options.dropHeight)/2);break;case "left-bottom":this.options.left=0;this.options.top=Math.max(0,
a(window).height()-this.options.height-this.options.dropHeight);break;case "center-bottom":this.options.left=Math.max(0,(a(window).width()-this.options.width)/2);this.options.top=Math.max(0,a(window).height()-this.options.height-this.options.dropHeight);break;default:this.options.left=Math.max(0,a(window).width()-this.options.width),this.options.top=Math.max(0,a(window).height()-this.options.height-this.options.dropHeight)}this.options.left+=b.xoff||0;this.options.top+=b.yoff||0;this.options.left=
Math.min(Math.max(this.options.left,0),a(window).width()-this.options.width);this.options.top=Math.min(Math.max(this.options.top,0),a(window).height()-this.options.height-this.options.dropHeight)}},_verificationScroll:function(a){var c=this.leftBody.scrollHeight()-this.leftBody.height();return a&&0<c&&0<self.leftBody.scrollTop()?!0:!a&&0<c&&c>this.leftBody.scrollTop()?!0:!1},_addRightLabel:function(b,c,d,e){var f=this,g=/^https?:\/\/(.*?)/gi,h=a.randomChar(),j,i=this.options.height-28;this.rightTags||
(this.rightTags=a({className:"window-right-tags",style:a.STYLE_NBODY+"background:#FAF9F9;z-index:-1;overflow:hidden;height:26px;border-top:2px solid #FFF;"}).appendTo(this.rightBody),this.rightTags.insert('<div style="'+a.STYLE_NBODY+'clear:both;"></div>'));this.rightContent||(this.rightContent=a({className:"window-right-content",style:a.STYLE_NBODY+"overflow:hidden;background:#FAF9F9;position:relative;top:-1px;z-index:1;border-radius:0px 0px 5px 0px;-moz-border-radius:0px 0px 5px 0px;-webkit-border-radius:0px 0px 5px 0px"}).appendTo(this.rightBody));
j=a.STYLE_BODY+"background-color:#FAF9F9;height:24px;line-height:24px;text-align:center;cursor:pointer;border-bottom:1px solid #d5d5d5;float:left;";j=1==d?j+"width:199px;":1==this.rightTags.find("div").length?j+("width:"+(2==d?98:65)+"px;border-right:1px solid #D5D5D5;"):this.rightTags.find("div").length<d?j+("width:"+(2==d?98:65)+"px;border-right:1px solid #D5D5D5;"):j+("width:"+(2==d?99:65)+"px;");b=a({className:h,title:b,style:j}).appendTo(this.rightTags,this.rightTags.find("div").last()).html(b);
h=this.rightContent.insert(['<div class="',h,' view-right-content" style="',a.STYLE_BODY,"background-color:#FAF9F9;width:100%;height:"+i+'px;overflow-x:hidden;overflow-y:auto;display:none;border-radius:0px 0px 5px 0px;-moz-border-radius:0px 0px 5px 0px;-webkit-border-radius:0px 0px 5px 0px"></div>'].join(""));if(a.isArray(c)){g=a({tag:"ul",style:a.STYLE_BODY+"margin:10px 0 10px 25px;list-style:disc;background-color:#FAF9F9;"}).appendTo(h).click(function(b){var c=a.Event.fixEvent(b).target;"li"===
c.tagName.toLowerCase()&&(b=a(c).attr("talk_title"),c=a(c).attr("talk_content"),f._manageMode.showFAQ(f.settingid,b,c))});for(i=0;i<c.length;i++)a({tag:"li",talk_title:c[i].title,talk_content:c[i].con,title:a.clearHtml(c[i].con||""),style:a.STYLE_BODY+"list-style:disc outside none;margin-top:5px;cursor:pointer;background-color:#FAF9F9;"}).appendTo(g).html(a.clearHtml(c[i].title||""))}else g.test(c)?(c+=(-1==c.indexOf("?")?"?":"&")+a.toURI({lan:a.extParmas.lan,sellerid:this._manageMode.sellerid,userid:a.user.id,
exparams:a.global.exparams||""}),a({className:"window-right-iframe",tag:"iframe",width:"100%",frameborder:"0",height:i,scrolling:"auto",style:a.STYLE_NBODY+"width:100%;height:"+i+"px;"}).appendTo(h.css("overflow-y","hidden")).attr("src",c)):a({className:"window-right-text",style:a.STYLE_BODY+"margin:5px;"}).appendTo(h).html(c);e&&this._selectedTag(b);return b},_bindTag:function(){var a=this;this.rightTags&&this.rightTags.find("[class]").click(function(){a._selectedTag(this)})},_selectedTag:function(b){var c=
this;this.rightTags.find("[class]").each(function(d,e){var f=a.myString(e.className.replace("talk_selected","")).trim();a(b).indexOfClass(f)?(a(e).addClass("talk_selected").css({height:"25px","border-bottom":"none"}),c.rightContent.find("."+f).display(1)):(a(e).removeClass("talk_selected").css({height:"24px","border-bottom":"1px solid #D5D5D5"}),c.rightContent.find("."+f).display())})},_clearTag:function(){this.rightBody.find("*").remove();this.rightContent=this.rightTags=null}}})(nTalk);

/* @file chat.js
 * @date 2016.04.21 14:04:14 
 */
(function(b,i){var l=/[\r\n]/gi;b.extend({default_connect_robot:!0});b.Capture={udCapCtl:null,setupFrame:null,version:"1.6.1",mimeType:"application/xiaonengcapture-plugin",license:"C35F3907AADCC3BB0FEB1DAC6866D806A0DAA7C07A001D97E14ECFBE1D27CC99891F79A7D86AA9CCAFF6B24C1CC1BA89143E5F61849BCC87E12ED104A23B4F980EDCEBE5471FEDE121826153381CC7A3E040D9D5374D13A587BE7B4011FCA44C6E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F837310A71452C349CA1EB060B439E6535037D30D63B4FEE80AB2C8102DFC48E0C486E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F837",
setup:"setup/Xiaonengcapture.msi",inited:!1,loaded:!1,callback:null,supportActiveX:!1,captureWithMin:!0,init:function(a){if(!this.inited||!a){this.inited=!0;b.Log("filetranserver:"+a);this.id="setFrame-"+b.randomChar();this.PostUrl=a+"/imageupload.php?"+b.toURI({action:"uploadimage",siteid:b.global.siteid,roomid:"t2d",type:"json",charset:b.charset});if((this.supportActiveX=window.ActiveXObject!==i)&&"Win64"==window.navigator.platform||"x64"==window.navigator.cpuClass)this.setup="setup/Xiaonengcapture64.msi";
this.loaded=!1;this.udCapCtlSpan=b({tag:"span",className:"nTalk-hidden-element",id:"udCapSpan",style:b.STYLE_NBODY}).appendTo(!0);this.setupFrame=b({tag:"iframe",className:"nTalk-hidden-element",id:this.id,src:"",style:"display:none;"}).appendTo(!0)}},start:function(a,c,d){b.Log("nTalk.Capture.start("+a+", "+c+", callback)");var e=this;this.settingid=a;this.callback=d||new Function;b.Capture.installCheck()&&(this.captureWithMin&&b.chatManage.view.hidden(),setTimeout(function(){(e.supportActiveX||
e.loaded)&&e.doCapture(c)},300))},doCapture:function(a){if(a&&this.udCapCtl.StartCapture)this.udCapCtl.StartCapture();else try{this.udCapCtl.Capture()}catch(c){this.udCapCtl&&this.udCapCtl.StartCapture?this.udCapCtl.StartCapture():(b.chatManage.view.visible(),alert(b.lang.capture_reload))}},hasVersion:function(a){"v"==a.substring(0,1)&&(a=a.substring(1,a.length));var b=this.version.split("."),a=a.split(".");return parseInt(b[0])>parseInt(a[0])||parseInt(b[0])==parseInt(a[0])&&parseInt(b[1])>parseInt(a[1])||
parseInt(b[0])==parseInt(a[0])&&parseInt(b[1])==parseInt(a[1])&&parseInt(b[2])>parseInt(a[2])?!0:!1},addEvent:function(a,b,d){if(this.udCapCtl.attachEvent)this.udCapCtl.attachEvent(a,b);else{var e=/^function\s?([^\s(]*)/,f=b.toString().match(/\(\)|\(.+\)/)[0],b=b.name||b.toString().match(e)[1]||d,d=document.createElement("script");d.setAttribute("for",this.udCapCtl.id);d.event=a+f;d.appendChild(document.createTextNode(b+f+";"));document.body.appendChild(d)}},_onBeforeCapture:function(){b.Log("Capture._onBeforeCapture",
2)},_onCaptureCanceled:function(){b.Log("Capture._onCaptureCanceled");b.chatManage.view.visible()},_onCaptureCompleted:function(a){b.Log("Capture._onCaptureCompleted("+a+")");b.chatManage.view.visible()},_onBeforeUpload:function(a,c){b.Log("Capture._onBeforeUpload("+a+", "+c+")")},_onUploadCompleted:function(a){b.Log('Capture._onUploadCompleted("'+a+'")');var c=b.Capture,d,e=500;try{d=b.JSON.parseJSON(a)}catch(f){a=a.substring(a.indexOf("{"),a.indexOf("}")+1);try{d=b.JSON.parseJSON(a)}catch(g){return}}!1===
c.callback.call()&&(e=0);c._callback("fIM_startSendFile",["","uploadimage",d.oldfile]);setTimeout(function(){c._callback("fIM_receiveUploadSuccess",["","uploadimage",d])},e)},_onUploadFailed:function(a){b.Log("Capture._onUploadFailed("+a+")",2)},_callback:function(a,c){c.push(this.settingid);b.hasOwnProperty(a)?b[a].apply(this,c):b.Log("nTalk."+a+"(...)",2)},installCheck:function(){this.loaded=!1;this.udCapCtl&&(this.loaded=!0);if(this.supportActiveX)if(b("#udCapSpan").html('<object id="udCaptureCtl" width="0" height="0" classid="CLSID:0FAE7655-7C34-4DEE-9620-CD7ED969B3F2"></object>'),
this.udCapCtl=b("#udCaptureCtl").get(0),this.udCapCtl.PostUrl!==i){if(this.hasVersion(this.udCapCtl.GetVersion()))return confirm(b.lang.capture_activex_update)&&this.startSetup(),!1;this.udCapCtl.PostUrl=this.PostUrl;this.udCapCtl.License=this.license;this.addEvent("OnBeforeCapture",nTalk.Capture._onBeforeCapture,"nTalk.Capture._onBeforeCapture");this.addEvent("OnCaptureCanceled",nTalk.Capture._onCaptureCanceled,"nTalk.Capture._onCaptureCanceled");this.addEvent("OnCaptureCompleted",nTalk.Capture._onCaptureCompleted,
"nTalk.Capture._onCaptureCompleted");this.addEvent("OnBeforeUpload",nTalk.Capture._onBeforeUpload,"nTalk.Capture._onBeforeUpload");this.addEvent("OnUploadCompleted",nTalk.Capture._onUploadCompleted,"nTalk.Capture._onUploadCompleted");this.addEvent("OnUploadFailed",nTalk.Capture._onUploadFailed,"nTalk.Capture._onUploadFailed");this.loaded=!0}else return confirm(b.lang.capture_install)?(b("#udCapSpan").html(""),this.udCapCtl=null,this.startSetup()):(b("#udCapSpan").html(""),this.udCapCtl=null),!1;else if(navigator.plugins){var a=
navigator.mimeTypes&&navigator.mimeTypes[this.mimeType]?navigator.mimeTypes[this.mimeType].enabledPlugin:0;if(a){var c="v1.0.0",a=a.description.split(" ");"v"==a[a.length-1].substring(0,1)&&(c=a[a.length-1]);if(this.hasVersion(c))return confirm(b.lang.capture_other_update)&&this.startSetup(),!1;b("#udCapSpan").html('<embed id="udCaptureCtl" width="0" height="0" type="'+this.mimeType+'"></embed>');this.udCapCtl=b("#udCaptureCtl").get(0);this.udCapCtl.PostUrl=this.PostUrl;this.udCapCtl.License=this.license;
this.udCapCtl.OnBeforeCapture="nTalk.Capture._onBeforeCapture";this.udCapCtl.OnCaptureCanceled="nTalk.Capture._onCaptureCanceled";this.udCapCtl.OnCaptureCompleted="nTalk.Capture._onCaptureCompleted";this.udCapCtl.OnBeforeUpload="nTalk.Capture._onBeforeUpload";this.udCapCtl.OnUploadCompleted="nTalk.Capture._onUploadCompleted";this.udCapCtl.OnUploadFailed="nTalk.Capture._onUploadFailed";this.loaded=!0}!this.loaded&&confirm(b.lang.capture_install)&&this.startSetup()}return this.loaded},startSetup:function(){this.setupFrame.attr("src",
b.baseURI+this.setup)}};b.extend({CON_SINGLE_SESSION:"SINGLE",CON_MULTIPLAYER_SESSION:"MULTIPLAYER",imageicon:"",imagebg:"",imagesingle:"",imagemultiplayer:"",loadImageAbnormal:function(a){if("ntalk-enterprise-logo"==b(a).attr("data-type"))a.src=b.sourceURI+"images/blank.gif";else try{var c=b(a).parent().width(),d=b(a).parent().height();b(a).css({margin:"0px"}).attr({width:c,height:d,src:"1"==b(a).attr("data-single")?b.imagesingle:b.imagemultiplayer})}catch(e){b.Log("img parent is null",2)}},zoom:function(a,
c,d){var e,f={width:c,height:d};if(!a||!a.width)return f;c=a.width>c?c:a.width;e=c/a.width*a.height;e>d&&(e=d,c=e/a.height*a.width);return b.extend(f,{width:c,height:e})},entityList:{"&":"&amp;","<":"&lt;","\uff1c":"&lt;",">":"&gt;","\uff1e":"&gt;","\uff06":"&amp;","\u00a9":"&copy;","\u00ae":"&reg;",'"':"&quot;","'":"&apos;","\uff02":"&quot;"},charFilter:function(a){var c,d,e=function(a){for(var c in b.entityList)"function"!=typeof b.entityList[c]&&(a=a.replace(RegExp(""+c+"","g"),b.entityList[c]));
return a};if(b.isArray(a)){c=[];for(d=0;d<a.length;d++)c[d]="object"==typeof a[d]?b.charFilter(a[d]):"string"==typeof a[d]?e(a[d]):a[d]}else if("object"==typeof a)for(d in c={},a)"function"!=typeof a[d]&&(c[d]="object"==typeof a[d]?b.charFilter(a[d]):"string"==typeof a[d]?e(a[d]):a[d]);else c=e(a);return c}});b.chatConnect=b.Class.create();b.chatConnect.prototype={name:"chatConnect",debug:!1,options:null,switchTimeId:null,error:!1,initialize:function(a,c){this.debug&&b.Log("create chatConnect()",
1);this.options=a;this.options.requestRobot&&b.Robot?(b.global.connect="robot",this._createRobotConnect()):b.global.connect==b.CON_CONNECT_FLASH&&"1"!=c?this._createFlashConnect():this._createCometConnect();var d=this;this.switchTimeId=setTimeout(function(){b.Log("connect tchat abnormalities["+b.global.connect+"], switch the connection type.",2);d.switchConnect()},5E3)},sendMessage:function(a){a=b.JSON.toJSONString(a);this.debug&&b.Log("chatConnect.sendMessage("+a+")");this.connect&&b.isFunction(this.connect.sendMessage)?
this.connect.sendMessage(a):b.Log("connect.sendMessage is undefined",3)},predictMessage:function(a){this.debug&&b.Log("chatConnect.predictMessage("+a+")");this.connect&&b.isFunction(this.connect.predictMessage)&&this.connect.predictMessage(a)},setTextStyle:function(a){this.debug&&b.Log("chatConnect.setTextStyle("+b.JSON.toJSONString(a)+")");this.connect&&b.isFunction(this.connect.setTextStyle)&&this.connect.setTextStyle(a)},disconnect:function(){this.debug&&b.Log("chatConnect.disconnect()");if(this.connect&&
b.isFunction(this.connect.closeTChat)){try{this.connect.closeTChat()}catch(a){}b.global.connect==b.CON_CONNECT_FLASH&&b.flash.remove(this.connect);this.connect=null}},closeTChat:function(){this.debug&&b.Log("chatConnect.closeTChat()");this.disconnect()},switchConnect:function(){this.stopSwitchConnect();!this.options.requestRobot&&b.global.connect!=b.CON_CONNECT_COMET?(this.connect&&b.isFunction(this.connect.remove)&&this.connect.remove(),this.connect&&b.isFunction(this.connect.disconnect)&&this.connect.disconnect(),
b.global.connect=b.CON_CONNECT_COMET,this._createCometConnect(this.options)):(this.error=!0,b.Log("comet or robot connect failure",3))},stopSwitchConnect:function(){this.debug&&b.Log("chatConnect.stopSwitchConnect");clearTimeout(this.switchTimeId);this.switchTimeId=null},_createFlashConnect:function(){b.Log("chatConnect._createFlashConnect()",1);var a=b("#nTalk-flash-element"),c=b.sourceURI+"fs/TChat.swf?"+b.version.chat,d="ntkf-flash-tchat_"+b.randomChar(),c=b.flashHtml(d,c,this.options);a.length||
(a=b(document.body).insert('<div id="nTalk-flash-element" class="nTalk-hidden-element" style="position: absolute; z-index: 9996; top: -200px;"></div>'));a.insert(c);b.browser.msie&&a.find("#"+d).display(1);this.connect=b("#"+d).get(0)},_createCometConnect:function(){b.Log("chatConnect._createCometConnect()",1);this.connect=new b.TChat(this.options,b.server)},_createRobotConnect:function(){b.Log("chatConnect._createRobotConnect()",1);if(!b.Robot)return!1;this.connect=new b.Robot(this.options)}};b.TChat=
b.Class.create();b.TChat.prototype={name:"TChat",options:null,data:null,connectParams:"userid usertoken sessionid destid machineID devicetype chattype chatvalue username userlevel settingid".split(" "),connect:null,debug:!1,login:!1,status:!1,defBody:{bold:!1,italic:!1,color:"000000",fontsize:"14",underline:!1},abnormalCount:0,loginAbnormalCount:0,fontsize:14,_reCount:0,callback:"",disconnectparams:null,_waitReconnectTimeID:null,dest:null,initialize:function(a){this.callback="tchat_"+b.randomChar();
this.hashSend=new b.HASH;this.hashComplete=new b.HASH;this.hashReceive=new b.HASH;this.data=b.store;this._reCount=0;this.options=b.extend({devicetype:b.browser.mobile?3:0,chattype:"0",chatvalue:"0"},b.whereGet(a,"siteid settingid tchatgoserver surl cid u n sid groupid rurl statictis htmlsid userlevel disconnecttime mini chattype chatvalue".split(" "),"siteid settingid tchatgoserver serverurl machineID userid username sessionid destid resourceurl statictis htmlsid userlevel disconnecttime mini chattype chatvalue".split(" ")));
this.dest={id:this.options.destid,name:a.destname};if(!this.options.pcid||10>=this.options.pcid.length)if(this.options.pcid=this.data.get("machineid"),!this.options.pcid||10>=this.options.pcid.length)this.options.pcid=b.base._createScriptPCID();this.data.set("machineid",this.options.pcid);this.options.userid||(this.options.userid=b.base.userIdFix+this.options.pcid.substr(0,21));this.debug&&b.Log("initialize comet chatConnect");this.status=!0;this._initQueue();this.loginConnect()},loginConnect:function(){var a=
this,c=this._toArray(this.options,this.connectParams);b.Log("connect tChat:"+c.join(","),1);this.connect=new b.comet(this.options.tchatgoserver,{timeout:10,onCallback:function(){a._onCallback.apply(a,arguments)},onComplete:function(){a._onComplete.apply(a,arguments)},onAbnormal:function(){a._onAbnormal.apply(a,arguments)},onTimeout:function(){a._onTimeout.apply(a,arguments)}});this.sessionIdleReplys={};this.sessionIdleReplys[+this.options.disconnecttime]="\u8d85\u65f6\u672a\u53d1\u9001\u6d88\u606f\uff0c\u81ea\u52a8\u65ad\u5f00\u8fde\u63a5";
this.connect.connect({ac:"conn",action:"roomconnect",login:!0,params:c.join(","),timeout:10})},kaliveConnect:function(a){b.Log("nTalk.TChat.kaliveConnect("+a+")",1);var c=this,d={ac:"kalive",action:"roomconnect",login:!1,params:this._toArray(this.options,this.connectParams).join(","),clientid:this.options.clientid,timeout:10};this.status?setTimeout(function(){c.connect.kalive(d)},1E3):b.Log("stop kalive connect")},reconnect:function(){var a=this;this._waitTime=3>=++this._reCount?500:1E3*+"034567890".charAt(Math.ceil(5*
Math.random()));this.status?this._waitReconnectTimeID=setTimeout(function(){a.connect.reconnect()},this._waitTime):b.Log("stop reconnect")},disconnect:function(){for(var a in this.sessionIdleReplys)this.sessionIdleTimeouts&&this.sessionIdleTimeouts[a]&&clearTimeout(this.sessionIdleTimeouts[a]);this.status=!1;clearTimeout(this._waitReconnectTimeID);this._waitReconnectTimeID=null;this.connect.disconnect()},sendMessage:function(a){var c,d,a=b.isObject(a)?a:b.JSON.parseJSON(a),a=b.charFilter(a);d=b.whereGet(a,
["type","msgid"],["type","msgid"]);a.url&&(d=b.extend(d,b.whereGet(a,"url emotion oldfile size extension sourceurl mp3 length".split(" "))));c={action:"remoteSendMessage",myuid:this.options.userid,clientid:this.options.clientid,sessionid:this.options.sessionid,flashuid:a.timerkeyid,type:"",fs:this.fontsize};1===a.type?b.extend(c,{msgid:a.msgid,style:0,type:1,msg:a.msg}):(b.extend(c,{msgid:a.msgid,msg:{msg:b.extend(a.msg,{attributes:d})}}),c.msg.msg.evaluate&&(c.msg.msg.evaluate=b.JSON.toJSONString(c.msg.msg.evaluate)),
c.msg=b.jsonToxml(c.msg));this.hashSend.add(c.msgid,c);5!==a.type&&this.processSessionIdle();this._splitParcels(c)},sendAbnormal:function(a){var a=this.hashSend.items(a),c=b.getTime(),a=b.extend({},{type:9,msgType:2,timesample:c,msgid:c+"J",userid:"system",body:a},a);delete a.timerkeyid;this._callback("fIM_receiveMessage",[a])},_splitParcels:function(a){var c=b.browser.mobile?300:768,d,e=d=0,f,g,h,j=[];f=encodeURIComponent(a.msg);for(g=Math.ceil(f.length/c);0<f.length;){d=!0;for(c=c<=f.length?c:f.length;d;){h=
f.substring(0,c);try{h=decodeURIComponent(h),d=!1}catch(k){c--}}d={msgid:a.msgid,index:e,body:b.extend({},a,{sendpacket:e,packetcount:g,msg:h})};j.push(d);this.messageQueue.addMessage(d);this.startSend(d);e++;d=c;f=f.substring(d,f.length)}return j},startSend:function(a){if(a&&this.login){if(!a.timestamp||!a.recount)a.timestamp=b.getTime(),a.recount=1;this.connect.send(b.extend({callback:this.callback},a.body))}},_callbackComplete:function(a,b,d){a&&(this.messageQueue.removeMessage(b,d),this.hashComplete.add(b,
this.hashSend.items(b)))},verificationMessage:function(){var a=this.messageQueue.first(),c=b.getTime(),d=0;if(this.login)for(;a;){if(3E3<=c-a.timestamp)if(3<=a.recount)this.sendAbnormal(a.msgid),this.messageQueue.removeMessage(a.msgid,-1);else{if(2<=d){a=this.messageQueue.nextMessage(a.msgid,a.body.sendpacket);continue}d++;a.timestamp=c;a.recount+=1;this.startSend(a)}a=this.messageQueue.nextMessage(a.msgid,a.body.sendpacket)}},closeTChat:function(){this.disconnect()},setTextStyle:function(a){a&&a.fontsize&&
(this.fontsize=a.fontsize)},predictMessage:function(a){this.connect.send({action:"onPredictMessage",myuid:this.options.userid,clientid:this.options.clientid,sessionid:this.options.sessionid,msg:a},function(){b.Log("comet.TChat.predictMessage()")})},LoginResult:function(a,c,d,e,f,g){this.login=!0===a;this.options.result=!0===a?1:0;this.options.clientid=c;this.options.sessionid=e;this.options.soid=f;this.options.time=g;try{this.options.userinfo=b.JSON.parseJSON(d)}catch(h){this.options.userinfo=this.options.userinfo||
{}}this._callback("fIM_tchatFlashReady",[this.options.userid,this.options.pcid,this.options.settingid]);this.options.result&&(this.userinfo=b.extend({},{myuid:this.options.userinfo.userid,myuname:this.options.userinfo.username,signature:"",mylogo:this.options.userinfo.usericon,sessionid:this.options.sessionid,timesample:this.options.time}),a=this.options.userid.split("_ISME9754_"),this.disconnectparams={from:"TCHAT",cid:this.options.clientid,sitid:this.options.siteid,uid:2==a.length?a[1]:""},this.flashGoURL=
this.connect.disconnectServer(this.disconnectparams,!1));this.options.userinfo&&!1===this.options.userinfo.connectable?this._callback("fIM_onGetUserInfo",['{"status": 0}']):(this.options.result?(this.kaliveConnect("login kalive"),this._callback("fIM_setTChatGoServer",[this.flashGoURL]),this._reCount=0,"function"==typeof im_destUserInfo&&im_destUserInfo(this.dest)):(this.reconnect("login relogin"),this.flashGoURL=this.userinfo=""),this._callback("fIM_ConnectResult",[this.options.result,this.userinfo,
""]))},remoteHistroyMessage:function(){for(var a=this,c,d,e=0,f=[],g={history:1},h=1;h<arguments.length;h++)switch(h%4){case 1:g.timestamp=arguments[h];break;case 2:g.userid=arguments[h];break;case 3:g=b.extend(g,b.whereGet(b.JSON.parseJSON(arguments[h]),["externalname","usericon","nickname","username"],["name","logo","nickname","username"]));break;case 0:c=arguments[h];if(null===c||""===c||-1!=c.indexOf("<msgtype"))continue;else c=c.replace(/<\?xml\s+version=\"1\.0\"\s+encoding=\"utf\-\d+\"\?>/gi,
""),c=c.replace(/&(?!amp;)/gi,"&amp;"),c=b.htmlToElement(c)[0],d=3==c.nodeType?{msg:c.textContent}:b.elementToObject(c),d.msg=c.textContent||c.text,"string"==typeof d.msg&&(d.msg=d.msg.replace(/</g,"&lt;")),g=b.extend(g,this.defBody,d);f.push(g);g={history:1}}b.each(f,function(b,c){setTimeout(function(){a._callback("fIM_receiveMessage",[c])},e);e+=50})},remoteSendMessage:function(a,c,d,e,f){var g,h;if(e&&!(-1<e.indexOf('type="5"'))){d&&"string"==typeof d&&(d=b.JSON.parseJSON(d),d=b.whereGet(d,["usericon",
"userid","externalname"],["logo","userid","name"]));e=e.replace(/<\?xml\s+version=\"1\.0\"\s+encoding=\"utf\-\d+\"\?>/gi,"");e=e.replace(/&(?!amp;)/gi,"&amp;");try{h=b.htmlToElement(e)[0],g=3==h.nodeType?{type:1,msg:h.textContent,msgid:f+"x"}:b.elementToObject(h)}catch(j){b.Log("remoteSendMessage:"+j.description+"; xmlString:"+e,3);return}g.msg=h.textContent||h.text;"string"==typeof g.msg&&(g.msg=g.msg.replace(/</g,"&lt;"));a=b.extend({},this.defBody,g,d,{timestamp:a});!this.hashSend.contains(a.msgid)&&
!this.hashReceive.contains(a.msgid)&&(this._callback("fIM_receiveMessage",[a]),this.hashReceive.add(a.msgid,a))}},remoteNotifyUserList:function(a){var c=[];try{c=b.JSON.parseJSON(a)}catch(d){b.Log("remoteNotifyUserList toJSON abnormal",3)}for(a=0;a<c.length;a++)c[a].userid==this.options.userid&&c.splice(a,1);this._callback("fIM_notifyUserNumbers",[c.length]);this._callback("fIM_notifyUserList",[b.JSON.toJSONString(c)])},remoteSearchWaiter:function(a,b){this._callback("fIM_onGetUserInfo",[b])},remoteNotifyUserInformation:function(a,
b){a!=this.options.userid&&this._callback("fIM_onGetUserInfo",[b])},remoteNotifyUserEnter:function(a,b){this.options.destid=a;var d=this._toArray(this.options,this.connectParams);this.connect&&(this.connect.connectOptions.params=d.join(","),this.connect.kaliveOptions.params=d.join(","));this._callback("fIM_notifyUserEnter",[this.options.destid,b,""])},remoteNotifyUserLeave:function(a){b.Log("tchat.remoteNotifyUserLeave("+a+")",2);this._callback("fIM_notifyUserLeave",[a])},remoteNotifyUserClose:function(a){a==
this.options.clientid&&(this._callback("fIM_ConnectResult",[5,"",""]),this.disconnect(),this._callback("fIM_ConnectResult",[4,"",""]))},remoteNotifySessionScene:function(a){this._callback("fIM_onNotifySessionSence",[a])},remoteNotifyUserInputing:function(a,b){this._callback("fIM_notifyUserInputing",[b])},remoteRequestEvalute:function(a,b,d){this._callback("fIM_requestEvaluate",[b,d])},processSessionIdle:function(){var a=this;this.sessionIdleTimeouts||(this.sessionIdleTimeouts={});b.each(this.sessionIdleReplys,
function(b){a.sessionIdleTimeouts[b]&&clearTimeout(a.sessionIdleTimeouts[b]);a.sendIdleReply(b)})},sendIdleReply:function(a){var c=this;this.sessionIdleTimeouts[a]=setTimeout(function(){var d=0,e=c.sessionIdleReplys[a];delete c.sessionIdleReplys[a];b.each(c.sessionIdleReplys,function(){d++});b.Log("setTimeout "+a+"s, disconnect tchat",1);0===d&&(c.connect&&c.options.result)&&(c.disconnect(),c._callback("fIM_ConnectResult",[4,"",e]))},1E3*a)},_toArray:function(a,c){var d=[];if(!a)return"error";for(var e=
0;e<c.length;e++)d.push(!b.isDefined(a[c[e]])?"":a[c[e]]);return d},_handleResponse:function(a,c){this[a]?this[a].apply(this,c):b.Log("The object of the method '"+a+"' does not exist",3)},_callback:function(a,c){c.push(this.options.settingid);if(b.hasOwnProperty(a))try{b[a].apply(this,c)}catch(d){}else b.Log("nTalk."+a+"(...)",2)},_onCallback:function(a,b){var d;if(b.length)if(d=b[0],"LoginResult"===d)if(a)this.LoginResult.apply(this,b.slice(1));else return!1;else this._handleResponse.call(this,d,
b.slice(1)),a&&(this.abnormalCount=0,this.kaliveConnect("call kalive"))},_onComplete:function(){var a=Array.prototype.slice.call(arguments);this.debug&&b.Log("TChat.onComplete( "+a[0]+","+a[1]+","+a[2]+" )");"kalive"==a[0]?(this.abnormalCount=0,this.kaliveConnect("complete kalive")):"login"==a[0]&&this.reconnect("abnormal login")},_onAbnormal:function(){var a=Array.prototype.slice.call(arguments);this.debug&&b.Log("TChat.onAbnormal( "+a[0]+","+a[1]+","+a[2]+" )",3);this.abnormalCount++;"login"==a[0]||
3<=this.abnormalCount?(this.abnormalCount=0,this._callback("fIM_ConnectResult",[2,"","\u8fde\u63a5\u670d\u52a1\u5668\u8d85\u65f6\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5\uff01"]),this.reconnect("abnormal login")):this.kaliveConnect("abnormal kalive")},_onTimeout:function(){var a=Array.prototype.slice.call(arguments);this.debug&&b.Log("TChat.onTimeout( "+a[0]+","+a[1]+","+a[2]+" )",3);"login"==a[0]&&this.loginAbnormalCount++;this.abnormalCount++;3<=this.loginAbnormalCount||5<=this.abnormalCount?(this.loginAbnormalCount=
this.abnormalCount=0,this._callback("fIM_ConnectResult",[2,"","\u8fde\u63a5\u670d\u52a1\u5668\u8d85\u65f6\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5\uff01"]),this.reconnect("time login")):this.kaliveConnect("timeout kalive")},_initQueue:function(){var a=this;this.messageQueue=new b.Queue;this.messageQueue.first=function(){return this.queueFront()};this.messageQueue.nextMessage=function(a,b){b=b||0;if(this.list.length){if(!a)return this.list[0]}else return null;for(var e=0;e<this.list.length;e++)if(this.list[e].msgid==
a&&this.list[e].body.sendpacket==b)return this.list[e+1];return null};this.messageQueue.removeMessage=function(a,b){for(var e=[],b=b||0,f=0;f<this.list.length;f++)this.list[f].msgid==a&&(this.list[f].index==b||-1==b)||e.push(this.list[f]);this.list=e;this.length=e.length};this.messageQueue.addMessage=function(a){for(var b=0;b<this.list.length;b++)if(this.list[b].msgid==a.msgid&&this.list[b].index==a.index)return!1;this.list.push(a);this.length=this.list.length;return!0};this.messageQueue.getSendingNum=
function(){for(var a=0,b=0;b<this.list.length;b++)this.list[b].status&&a++;return a};window[this.callback]=function(){a._callbackComplete.apply(a,arguments)};this.sendIntervalID=setInterval(function(){a.verificationMessage()},1E3)}};b.chatMode=b.Class.create();b.chatMode.prototype={name:"chatMode",debug:!1,view:null,options:null,manageMode:null,hash:new b.HASH,hashCache:new b.HASH,htmlsid:0,siteid:"",settingid:"",config:null,connected:!1,defData:null,_sendNum:0,_changeCsrNum:0,_changeCsrMaxNum:5,
_reconnectCount:0,_startQueue:!1,_queueNum:1,statusConnectT2D:"WAIT",statusConnectTChat:"WAIT",_submitRating:!1,_Evaluable:!1,_Enableevaluation:!1,_currentView:"",inputMaxByte:0,selected:!1,floatTimeID:null,dest:null,hashDest:new b.HASH,sessionid:"",user:null,_moreData:null,unread:0,userNumber:0,userList:[],sessionType:null,enterData:null,captureing:!1,waitTimeID:null,cacheTimeID:null,server:[],requestRobot:!1,enterUserId:null,startCSSwitch:"",CON_GENERAL:1,CON_ADPTER:1E4,CON_INVITE:10001,CON_VIEW_LOADING:"loading",
CON_VIEW_ERROR:"error",CON_VIEW_WINDOW:"window",CON_VIEW_MESSAGE:"message",CON_OFFLINE:0,CON_ONLINE:1,CON_INVISIBLE:2,CON_BUSY:3,CON_AWAY:4,CON_LOGIN_FAILURE:0,CON_LOGIN_SUCCESS:1,CON_CONNECT_FAILURE:2,CON_CONNECT_SUCCESS:3,CON_DISCONNECT:4,CON_CLOSE_CONNECT:5,CON_MOBILE_SHOW_GOODSINFO:0,CON_ROBOT_ID:"_ISME9754_T2D_webbot",CON_ROBOT_ERROR_MESSAGE:"ROBOT_ERROR_MESSAGE",CON_ROBOT_NO_ANSWER:"\u975e\u5e38\u5bf9\u4e0d\u8d77\u54e6\uff0c\u8fd9\u4e2a\u95ee\u9898\u5728\u6211\u77e5\u8bc6\u8303\u56f4\u5916\uff0c\u6211\u4f1a\u52aa\u529b\u53bb\u5b66\u4e60\u7684\uff01",
robotID:"",robotSessionID:"",uploadingid:{},initialize:function(a,c){this.defData={type:1,userid:"",name:"",logo:"",msg:""};this.sessionid="";this.dest={id:"",name:""};this._moreData=[];this.user={id:b.user.id};this.hash.clear();this.options=b.extend({},a);this.manageMode=c;this.siteid=this.options.siteid;this.sellerid=this.options.sellerid;this.settingid=this.options.settingid;this.htmlsid=b.getTime(2);this.selected=!0;this.unread=0;this._Evaluable=this._submitRating=!1;this._currentView=this.CON_VIEW_LOADING;
this.robotID=this.siteid+this.CON_ROBOT_ID;this._callbackGoodsinfo="scriptCallReceiveGoodsinfo_"+this.settingid;window[this._callbackGoodsinfo]=null;this.waitTimeID=[];this.cacheTimeID=[];var d=this;this.view=new b.chatView({siteid:this.siteid,settingid:this.settingid,width:this.manageMode.view.options.width,height:this.manageMode.view.options.height,chatHeader:this.manageMode.view.header,chatContainter:this.manageMode.view.chatContainter,toggleExpansion:function(a){d.toggleExpansion(a)}},this);this.setDest();
this.inputMaxByte=600;this.initConfig();b.browser.mobile||b.Capture.init(this.server.filetranserver);this.view.disableButton(["history","evaluate","capture"],!0);this.view.createFileButton(this.server)},toggleExpansion:function(a){return this.manageMode.callToggleExpansion(a)},getExpansionStatus:function(){return this.manageMode.view.extended.rightElement},loadLink:function(a,c){var d=this,e,f,g=b.isDefined(this.server.queryurl)&&this.server.queryurl?this.server.queryurl:"";if(g&&a&&(/^\d+\.\d+\.\d+\.\d+$/gi.test(b.domain)||
!(-1>=a.indexOf(b.domain)&&b.global.pageinchat)))b.Log("nTalk.chatMode.loadLink("+a+")"),e="callback_"+b.randomChar(),f=b.toURI({query:"getwebinfo",weburl:a,ctype:1,siteid:this.siteid,batch:0,callbackname:e}),window[e]=function(a){b.Log("nTalk.chatMode.loadLink() callback: "+b.JSON.toJSONString(a),1);d.view.viewLinkContainer&&a.title&&d.view.viewLinkContainer(a,c)},b.require(g+"?"+f+"#rnd")},callTrack:function(a,c){var d={siteid:this.siteid,userid:b.user.id,sid:this.getHtmlSid(),nodeid:a,nodeparam:c};
if(this.server.trackserver)return b.require(this.server.trackserver+"/track.php?"+b.toURI(d)+"#rnd#image",function(c){!0===c.error&&b.Log("call trackServer error: "+a,3);b(c.error?c.target:c).remove()}),!0;b.Log("nTalk.chatMode.callTrack("+a+"): trackserver error",1)},callStat:function(a){var c=RegExp("^(0|1|2|4|5|6|7|8|18|19|20|21)","gi"),d=RegExp("^(10|11|12|13|22|23)$","gi"),e={m:"Count",a:"collection",type:"chatjs",siteid:this.siteid,kfid:this.dest.id||"",guestid:b.user.id,action:a,htmlsid:this.getHtmlSid(),
chatsession:this.sessionid||"",settingid:this.settingid};if(!b.global.statictis&&c.test(a)||2===b.global.statictis&&!d.test(a))return!1;this.debug&&b.Log(this.settingid+":chat.callStat("+a+")");b.require(this.server.mcenter+"statistic.php?"+b.toURI(e)+"#rnd",function(c){!0===c.error&&b.Log("call statictis error: "+a,3);b(c.error?c.target:c).remove()});return!0},close:function(){this.statusConnectTChat="CLOSECHAT";this.disconnect();this.userList=[];this.sessionid="";this.view.close();this.callStat("23");
2==this.server.isnoim&&("1"==b.cache.get("opd")&&b.base)&&b.base.startIM()},start:function(a){var c;if(!this.config||b.isEmptyObject(this.config))b.Log("chatMode.start():config is null",3);else if(b.Log(this.settingid+":chatMode.start()"),b.isFunction(this.manageMode.callVerification)&&(c=this.manageMode.callVerification(this.settingid,this.config)))c.showMessage("system0",{type:9,msg:b.utils.handleLinks(b.lang.system_merge_session,{destname:c.dest.name})}),c.send(a),b.chatManage.switchChatTag(c.settingid),
b.Log("Only one customer to open a chat window",2);else{this.dest.kfid=this.getDest(!0);a=b.base.checkID(this.options.destid);if(!1===a||a!=b.CON_CUSTOMER_ID&&a!=b.CON_GROUP_ID)this.options.destid=this.getDest(!0);this.options.single||(this.options.single=b.base.checkID(this.options.destid)==b.CON_GROUP_ID?0:1);this.callStat("8");this.getCustomerServiceInfo(this.options.destid,this.options.single)}},reconnect:function(a,c,d){if(a){for(;a&&"LI"!=a.tagName.toUpperCase()&&a.parentNode;)a=a.parentNode;
b(a).remove()}/QUERY|QUEUE/i.test(this.statusConnectT2D)?b.Log("reconnect:"+this.statusConnectT2D):/QUEUE|READY|COMPLETE/i.test(this.statusConnectTChat)?b.Log("reconnect:"+this.statusConnectTChat):(c&&(this.options.destid=c||"",this.options.single=d||"0"),this._currentView!==this.CON_VIEW_WINDOW&&this.switchUI(this.CON_VIEW_WINDOW),this.start())},createConnect:function(){var a=this,c;b.Log("connect tchat sessioId>>"+this.sessionid,2);c={tchatgoserver:this.server.tchatgoserver,siteid:this.siteid,settingid:this.settingid,
surl:this.server.flashserver,rurl:b.baseURI,u:b.user.id,n:b.user.name,groupid:this.dest.id,destname:this.dest.name,sid:this.sessionid,cid:b.global.pcid,htmlsid:this.getHtmlSid(),statictis:b.global.statictis,userlevel:b.global.isvip||"0",disconnecttime:this.config.contime||180,mini:0,chattype:b.global.chattype||"1",chatvalue:3==b.global.chattype?b.global.inviteid:b.global.chatvalue||"0",loadnid:b.CON_LOAD_MODE_NID,requestRobot:this.requestRobot};this.callTrack("10-01-01","start connect");this.connect&&
(this.statusConnectT2D=this.statusConnectTChat="WAIT",this.disconnect());this.connect=new b.chatConnect(c,this.server.close_tchat_flash||"0");this.requestRobot&&setTimeout(function(){a.connect.error&&(clearTimeout(this._connectTimeout),a.switchUI(a.CON_VIEW_MESSAGE,"TIMEOUT"))},6E3);this._connectTimeout=setTimeout(function(){a.callTrack("10-01-03","connect time out");a.debug&&b.Log("connect timeout 60s");a.switchUI(a.CON_VIEW_MESSAGE,"TIMEOUT")},6E4)},getHtmlSid:function(){return this.htmlsid?this.htmlsid=
144E5<b.getTime()-this.htmlsid.substring(0,this.htmlsid.length-3)?b.getTime(2):this.htmlsid:""},disconnect:function(){var a=this;"CLOSECHAT"==this.statusConnectTChat?this.showMessage("system",{type:9,msg:b.utils.handleLinks(b.lang.system_end_session,{settingid:this.settingid})}):"COMPLETE"==this.statusConnectTChat?0!=this.config.enable_auto_disconnect&&this.showMessage("system",{type:9,msg:b.utils.handleLinks(b.lang.system_auto_disconnect,{settingid:this.settingid})}):"WAIT"==this.statusConnectTchat&&
this._clearChangeCsrNum();this._stopConnectTimeout();this.view.disableButton(["evaluate","capture"],!0);this.manageMode.view.updateViewStatus(!0);b.Log(a.settingid+":chatMode.disconnect()",1);this.connected=!1;this.statusConnectTChat="DISCONNECT";this.setDest({status:0});this.chatFlashGoUrl&&(a=this,b.require(this.chatFlashGoUrl+"#rnd",function(c){a.chatFlashGoUrl="";b(c.error?c.target:c).remove()}));this._queueTimeID&&(clearTimeout(this._queueTimeID),this._queueTimeID=null);b.each(this.waitTimeID,
function(a,b){clearTimeout(b)});this.waitTimeID=[];b.each(this.cacheTimeID,function(a,b){clearTimeout(b)});this.cacheTimeID=[];this.connect&&this.connect.disconnect()},endSession:function(){var a=this;if(1<this.manageMode.hash.count())if(b.Log("...............close",2),this.config&&1==this.config.enableevaluation&&!this._submitRating&&this._Evaluable&&this._currentView==this.CON_VIEW_WINDOW){if(!1===this.showEvaluation(0,function(){a.manageMode.closeChat(a.settingid)}))try{a.manageMode.closeChat(a.settingid)}catch(c){b.Log(c,
3)}}else this.manageMode.closeChat(this.settingid);else this.manageMode.close()},switchUI:function(a,c){this.view.switchUI(a);this._currentView=a;b.Log(this.settingid+":chatMode.switchUI("+a+", "+c+")");a===this.CON_VIEW_MESSAGE&&(this.callTrack("10-01-08"),this.manageMode.view&&b.isFunction(this.manageMode.view.updateViewStatus)&&this.manageMode.view.updateViewStatus(!0),this.disconnect(),this.callStat("22"),this.createMessageForm())},createMessageForm:function(){var a;if(!this.config.form_message||
"string"==typeof this.config.form_message||!this.config.form_message.length)this.config.form_message=this.config.message_form;if(!this.config.form_message||"string"==typeof this.config.form_message||!this.config.form_message.length)this.config.form_message=b.lang.default_message_form_fields;this.dest=this.getDest(!1);this.setDest({status:0});a={myuid:b.user.id,destid:this.dest.id,sid:this.sessionid||"",source:"",content:""};this.hashCache.each(function(b,d){1==d.type?a.content+=d.msg+"\n":/^(2|4)$/.test(d.type)&&
(a.fileError=!0)});this.hashCache.clear();this.view.createMessageForm(this.config.form_message,this.config.disable_message,this.config.form_announcement||this.config.announcement||"",a)},submitMessageForm:function(){this.view.submitMessageForm(this.config.form_message,this.server.mcenter+"queryservice.php?m=Index&a=queryService&t=leaveMsg&siteid="+this.siteid+"&sellerid="+this.sellerid)},_stopConnectTimeout:function(){clearTimeout(this._connectTimeout);this._connectTimeout=null},cancelUpload:function(a){var c=
"uploadfile"==a?"objFile":"objImage";b.Log(this.settingid+":chatMode.cancelUpload()");this.view[c].cancelUpload&&this.view[c].cancelUpload();this.view.updateMessage(this.uploadmsgid,"uploadfile"==a?4:2,-1)},_uploadReady:function(a){a="uploadfile"==a?"objFile":"objImage";b.Log(this.settingid+":chatMode._uploadReady("+a+")",1);b.isFunction(this.view[a].setUploadServer)&&this.view[a].setUploadServer(this.server.filetranserver)},startUpload:function(a,c){var d=b.hexToDec(c||"").replace(/.*?(\u201c|\\u201c)/ig,
"").replace(/(\u201d|\\u201d).*?$/ig,"");this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==a?4:2,status:"UPLOADING",oldfile:b.browser.mobile?"":d})},startCompress:function(a){this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==a?4:2,status:"COMPRESS"})},uploadSuccess:function(a,c){c=b.isObject(c)?c:b.JSON.parseJSON(c);c=b.protocolFilter(c);this.view.updateMessage(this.uploadmsgid,"uploadfile"==a?4:2,c);b.Log(this.settingid+": $.chatMode.uploadSuccess()",1);this.send(b.extend(c,
{msg:c}));this.uploadmsgid=""},uploadFailure:function(a,b){this.uploadmsgid||(this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==a?4:2,oldfile:"",name:b.name,size:b.size}));this.view.updateMessage(this.uploadmsgid,"uploadfile"==a?4:2,-2,b);this.uploadmsgid=""},uploadProgress:function(a,b){this.view.updateMessage(this.uploadmsgid,"uploadfile"==a?4:2,b)},showEvaluation:function(a,c){if(2==a&&this.view.evalDialog||"WAIT"==this.statusConnectTChat&&2!=a||!0===this._submitRating&&2!=a)return!1;
this.manageMode.callReceive(this.settingid);if(!this.config.form_evaluation||"string"==typeof this.config.form_evaluation||!this.config.form_evaluation.length)this.config.form_evaluation=this.config.evaluation_form;if(!this.config.form_evaluation||"string"==typeof this.config.form_evaluation||!this.config.form_evaluation.length)this.config.form_evaluation=b.lang.default_evaluation_form_fields;this.config.evaluation_form_title||(this.config.evaluation_form_title=b.lang.default_evaluation_form_title);
for(var d=0;d<this.config.form_evaluation.length;d++)this.config.form_evaluation[d]=b.extend(this.config.form_evaluation[d],{titlewidth:/zh_cn|en_us/ig.test(b.lang.language)?"5px":"10px",inputwidth:"auto",optionLine:!0,messageid:"alert-form-"+this.config.form_evaluation[d].name}),"textarea"==this.config.form_evaluation[d].type&&(this.config.form_evaluation[d]=b.extend(this.config.form_evaluation[d],{input:{width:"95%",height:"70px"}}));this.evaluationElement=this.view.createEvaluation(this.config.form_evaluation,
this.config.evaluation_form_title,this.config.startColor,this.config.endColor,c);return!0},submitEvaluationForm:function(a){var c=this;b.FORM.verificationForm(this.config.form_evaluation,function(b){c.postEvaluate(b);a&&setTimeout(function(){a.call(c)},500)},this.evaluationElement)},postEvaluate:function(a){var c=this;this.evaluationHidden=!0;a=this._formatEvaluationData(a);this.chatgourl||(b.Log("chatMode.postEvaluate():chatgourl:"+this.chatgourl,3),this.chatgourl=this.mdyServerAddr(this.server.tchatgoserver));
this.manageMode.addHistoryPageCount();new b.POST(this.chatgourl+"?"+b.toURI({action:"onremark",myuid:this.user.id,clientid:this.clientid,sessionid:this.sessionid}),a.data,[function(){b.Log("evaluate submit complete.",1);evMsg=b.browser.mobile?b.lang.system_mobile_evaluation:b.utils.handleLinks(b.lang.system_evaluation,{evaluation:b.enCut(a.info,120)});c.showMessage("info",{type:9,msg:evMsg})},function(){b.Log("evaluate submit failed.",2)}])},download:function(){b.Log("download recording file");if("WAIT"!=
this.statusConnectTChat){var a=b.toURI({m:"Msg",a:"downloadMsg",uid:this.user.id,sid:this.sessionid,lang:b.language,tzo:(new Date).getTimezoneOffset()/60,ts:b.getTime()}),a=this.server.mcenter+"historymessage.php?"+a;"function"==typeof window.openURLToBrowser?window.openURLToBrowser(a):this.view.displayiFrame.attr("src",a)}},viewHistory:function(a,c){var d=this.server.mcenter+"index.php/messageweb/webAppIndex?"+b.toURI({userid:this.user.id,lang:b.language,tzo:(new Date).getTimezoneOffset()/60,ts:b.getTime()});
b.Log("view chats,iFrame:"+c+", url:"+d,2);b(c).attr("src",d)},startCapture:function(){var a=this;this.connected&&!0!==this.captureing&&(this.captureing=!0,b.Log(this.settingid+":chatMode.startCapture()"),b.Capture.start(this.settingid,!1,function(){a.captureing=!1;b.Log("Capture.onUploadCompleted()")}),setTimeout(function(){a.captureing=!1},500))},switchServerType:function(a,c){a?(b.Log("switch connect t2dstatus"),this.view.disableButton("manual",!0),this.robotSessionID=this.sessionid,this.statusConnectTChat=
"CLOSECHAT",this.disconnect(),this.requestRobot=!1,this.view.switchToolbar(!0)):(b.Log("switch connect robot"),this.view.disableButton("manual",!1),this.robotSessionID="",this.statusConnectTChat="CLOSECHAT",this.callMethod[this.callBack]=new Function,this.disconnect(),this.requestRobot=!0,this.view.switchToolbar(!1,c));this.sendFirstMessage();this.reconnect()},minimize:function(){this.selected=!1;this.view.minimize()},maximize:function(){b.Log(this.settingid+":chatMode.maximize()");this.selected=
!0;this.unread=0;this.view.maximize();this.setDest()},receive:function(a){var c;b.isObject(a)?b.Log(this.settingid+":chatMode.receive("+b.JSON.toJSONString(a)+")"):(b.Log(this.settingid+":chatMode.receive("+a+")"),a=b.JSON.parseJSON(a));a=this._filterReceive(a);if(b.clearHtml(a.msg)==this.CON_ROBOT_NO_ANSWER||a.msg==this.CON_ROBOT_ERROR_MESSAGE)a.msg=this.config.robot_noanswer||a.msg;!this.hash.contains(a.msgid)&&!1!==a&&(c=b.base.checkID(a.userid)==b.CON_CUSTOMER_ID?"left":"right",this.showMessage(c,
a))},suggest:function(a){return this.view.suggest(a)},sendFirstMessage:function(){if(this.requestRobot&&0!=this.config.enable_robotgreeting)this.config.robot_greeting&&this.showMessage("left",{msgid:"welcome_robot",type:1,history:1,msg:this.config.robot_greeting||""});else if(0!=this.config.enable_artificialgreeting){var a=this.config.greet_detail?this.config.greet_detail:b.utils.handleLinks(b.lang.system_first_news,{name:this.config.name});this.showMessage("left",{msgid:"welcome",type:1,msg:a})}},
send:function(a){var c=b.getTime(),c={localtime:c,timerkeyid:c,msgid:this.getMsgId(c)},a="string"==typeof a?b.extend({},this.defData,c,{msg:a.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")}):b.extend({},this.defData,c,a);if(!this.connected)return/FAILURE|QUEUE/i.test(this.statusConnectTChat)||(b.Log("connected:"+this.connected+", statusConnectTChat:"+this.statusConnectTChat+", start",1),this.statusConnectTChat="QUEUE",this.start(a)),this.hashCache.add(a.msgid,a),!1;"string"==typeof a.msg&&(a.msg=b.enCut(a.msg,
this.inputMaxByte));b.Log(this.settingid+":chatMode.send("+(b.isObject(a)?b.JSON.toJSONString(a):a)+")",1);1==a.type||2==a.type&&1==a.emotion?this.showMessage("right",a):/^(2|4|6)$/gi.test(a.type)&&this.hash.add(a.msgid,a);/^(1|2|4|6)$/gi.test(a.type)&&(this._sendNum++,this._changeCsrNum++,this._changeCsrNum==this._changeCsrMaxNum&&this.view.disableButton("csr",!1));this.connect&&this.connect.sendMessage(a);return!0},resend:function(a){if(!this.hash.contains(a))return!1;this.send(this.hash.items(a))},
predictMessage:function(a){this.connected&&this.connect&&(b.Log("$.chatMode.predictMessage("+a+")"),this.connect.predictMessage(a))},_filterReceive:function(a){var c=this;this.user.id==a.userid||b.base.checkID(a.userid)===b.CON_VISITOR_ID?a.msgid=!a.msgid?this.getMsgId(a.timerkeyid):a.msgid:!+a.history&&/^(1|2|4)$/.test(a.type)&&(b.promptwindow.startPrompt("",b.lang.news_new,!0),this.manageMode.callReceive(this.settingid),this.selected||this.unread++);a.msgid=a.msgid||a.timerkeyid;a.timestamp+=this.jetLag;
a.timerkeyid=a.timestamp;a.localtime=a.timestamp;return 1==a.msgType?(this.view.updateMessage(a.msgid,1,b.lang.system_send_failure),this.callTrack("10-01-04","flash timeout, message send failure"),!1):2==a.msgType?(b.isObject(a.msg)||(this.callTrack("10-01-04","common message send failure"),this.view.updateMessage(a.msgid,1,b.lang.system_send_failure)),!1):9===a.type?(this.callTrack("10-01-04","message is too fast to send"),a.msgid=a.msgid||this.getMsgId(a.timeData),this.view.updateMessage(a.msgid,
1,b.lang.system_send_failure),this.view.displayStatusInfo&&(this.view.displayStatusInfo(!0,b.lang.system_fast_messaging),this.floatTimeID=setTimeout(function(){clearTimeout(c.floatTimeID);c.floatTimeID=null;c.view.displayStatusInfo(!1)},3E3)),!1):a},showMessage:function(a,c){var d=b.getTime(),c=b.extend({localtime:d,timerkeyid:d,msgid:this.getMsgId(d),msg:""},this.defData,c);if(!this.hash.contains(c.msgid))return c.logo&&(c.logo=b.protocolFilter(c.logo)),c.url&&(c.url=b.protocolFilter(c.url)),c.sourceurl&&
(c.sourceurl=b.protocolFilter(c.sourceurl)),c.mp3&&(c.mp3=b.protocolFilter(c.mp3)),this.hash.add(c.msgid,c),this.view.showMessage(a,c)},_sendGoodsinfo:function(){var a=this,c;this.options.itemid&&(this.callStat("20"),c=this.server.mcenter+"/goodsinfo/api.php?"+b.toURI({siteid:this.siteid,itemid:this.options.itemid,itemparam:this.options.itemparam,sellerid:this.options.sellerid,user_id:b.global.shortid}),this.hashCache.add(b.getTime(1),{type:5,msg:{msgtype:5,productInfoURL:c+"&type=2&ts="+b.getTime()}}),
window[this._callbackGoodsinfo]||b.browser.mobile&&!this.CON_MOBILE_SHOW_GOODSINFO?b.Log("CON_MOBILE_SHOW_GOODSINFO:"+this.CON_MOBILE_SHOW_GOODSINFO):(window[this._callbackGoodsinfo]=function(b){a._showGoodsinfo(b)},b.require(c+"&type=jsonp&lan="+b.lang.language+"&callback="+this._callbackGoodsinfo+"#rnd",function(a){b(a.error?a.target:a).remove()})))},_showGoodsinfo:function(a){a?this.showMessage("goods",{type:13,msg:a}):this.showMessage("goods",{type:3})},isVisitor:function(a){return b.base.checkID(a)===
b.CON_VISITOR_ID},getDest:function(a){var c=this.config;b.Log("chatMode.getDest("+a+")");if(a)return temp=c.icon||c.list||c.toolbar||c.featureset||null,!temp||!temp.members.groupID||!temp.members.idList.length?"":temp.members.groupID;if(this.dest&&this.dest.id&&this.dest.id!=this.robotID&&this.dest.id!=b.CON_SINGLE_SESSION&&-1==this.dest.id.indexOf("GT2D"))return this.dest;this.dest.id="";this.dest.name="";a=(c.icon||c.list||c.toolbar||c.featureset).members;return{id:a.idList[0],name:a.nameList[0],
sign:a.sigList[0]}},setDest:function(a){var c=this,a=a||{};b.Log(this.settingid+":chatMode.setDest("+(a?b.JSON.toJSONString(a):"")+")");b.each(a,function(a,b){c.dest[a]=b||c.dest[a]});a&&(a.id&&!this.hashDest.contains(a.id))&&this.hashDest.add(this.dest.id,b.extend({},this.dest));this.dest.title=this.config&&"trial"==this.config.mode?b.lang.chat_title_ext+" "+this.dest.name:this.dest.name;this.dest.attr={width:b.browser.mobile?35:55,height:b.browser.mobile?35:55};this.dest.logo?(b.CON_MULTIPLAYER_SESSION===
this.dest.logo?this.dest.logo=b.imagemultiplayer:b.CON_SINGLE_SESSION===this.dest.logo&&(this.dest.logo=b.imagesingle),this.selected&&this.manageMode.callSetDest(this.settingid,b.extend({},this.dest)),b.require(this.dest.logo+"#image",function(){this.src===c.dest.logo&&(!0!==this.error?(c.dest=b.extend(c.dest,{logo:1<c.userNumber?b.imagemultiplayer:c.dest.logo,image:this,attr:b.zoom(this,c.dest.attr.width,c.dest.attr.height)}),c.hashDest.items(c.dest.id,b.extend({},c.dest))):c.dest.logo=1<c.userNumber?
b.imagemultiplayer:b.imagesingle,c.selected?c.manageMode.callSetDest(c.settingid,b.extend({},c.dest)):c.manageMode.callSetDestStatus(c.settingid,b.extend({},c.dest),!0))})):c.selected&&(c.dest.logo=1<c.userNumber?b.imagemultiplayer:b.imagesingle,c.manageMode.callSetDest(this.settingid,b.extend({},this.dest)))},setUser:function(a){this.user=b.extend(this.user,a);this.defData=b.extend(this.defData,{userid:this.user.id||"",name:this.user.name||"",logo:this.user.logo||""})},showInputState:function(){this.showMessage("bottom",
{userid:this.dest.id,name:this.dest.name,logo:this.dest.logo,type:1,msg:['<span class="view-history-body-wait" style="',b.STYLE_NBODY,"margin:0 10px;display:block;width:32px;height:20px;",b.browser.mobile?"background:transparent url("+b.imageicon+") no-repeat -22px -250px;":"background:transparent url("+b.imageicon+") no-repeat -140px -60px;",'"></span>'].join("")});this.view.showInputState()},initConfig:function(){var a;if(!this.options.config||b.isEmptyObject(this.options.config))this.switchUI(this.CON_VIEW_ERROR,
"LOAD_FAIED");else{this.switchUI(this.CON_VIEW_WINDOW,"LOAD_COMPLETE");this.config=b.extend({settingid:this.settingid},this.options.config);this.options.config.service?this.server=b.extend({},b.server,b.protocolFilter(this.options.config.service)):(b.Log("config file version error.",3),this.server=b.extend({},b.server,{tchatserver:"",tchatgoserver:"",filetranserver:""}));this.config.logo=b.protocolFilter(this.config.logo);if(a=1==this.server.robot&&1==this.config.robot&&this.server.roboturl){if(1==
this.options.manual)this.requestRobot=!1;else if(0==this.config.robot_mode&&(!this.config.robot_inherits_state||1==this.config.robot_inherits_state&&b.default_connect_robot))this.requestRobot=!0;b.Log("nTalk.chatMode.initConfig(): requestRobot:"+this.requestRobot)}this._initChatConfig();a=!b.browser.mobile&&this.config.logo?'<p style="'+b.STYLE_BODY+'background-color:transparent;text-align:center;"><img data-type="ntalk-enterprise-logo" src="'+this.config.logo+'" style="'+b.STYLE_BODY+'text-align:center;display:inline;" onerror="nTalk.loadImageAbnormal(this, event)" /></p>':
"";this.setDest({id:this.siteid,logo:this.config.logo||"",name:b.utils.handleLinks(b.lang.system_title_news,{name:this.config.name||""}),status:0});this.showMessage("first",{type:0,msg:a});this.sendFirstMessage();1==this.config.enable_audio&&this.audioInit()}},audioInit:function(){var a=this;b.Audio&&b.Audio.start(this.server.filetranserver,{action:"uploadaudio",roomid:"T2D",siteid:this.siteid,settingid:this.settingid},function(c){b.Log("set Audio Button disabled:"+c,2);a.view.disabledAudioButton(c)})},
audioUpload:function(a,c){var d,e,f,g=this;if("uploading"===a.status)this.uploadingid[c]||(this.uploadingid[c]="temp",this.uploadingid[c]=this.showMessage("right",{type:6,msg:"uploading"})),d=(100*(a.event.loaded/a.event.total)).toFixed(2),this.uploadingid[c]&&"temp"!=this.uploadingid[c]&&this.view.audioProgress(this.uploadingid[c],d);else if("success"===a.status)var h=setInterval(function(){if(g.uploadingid[c]&&"temp"!=g.uploadingid[c]){clearInterval(h);e=a.event.target||a.event.currentTarget||a.event.srcElement;
b.Log(e.responseText);try{f=b.JSON.parseJSON(e.responseText)}catch(d){}f.type=6;f.sourceurl=f.url;f.url=f.mp3;f.duration=f.length;delete f.mp3;g.view.updateMessage(g.uploadingid[c],6,f);b.Log("audioUpload:"+b.JSON.toJSONString(f),2);g.send(b.extend(f,{msg:f}));g.view.showAudioResult(g.uploadingid[c]);g.uploadingid[c]=""}},200);else"error"===a.status?g.view.showAudioResult(g.uploadingid[c]):b.Log(a,3)},_initChatConfig:function(){var a=this,c=[],d;if(b.isDefined(this.config.message_skin)&&("chat/2"==
this.config.message_skin||""==this.config.message_skin||-1<this.config.message_skin.indexOf("|")))this.config.message_skin=!this.config.message_skin?"#2c2c2e|#474749":this.config.message_skin,this.config.startColor=this.config.message_skin.substr(0,this.config.message_skin.indexOf("|")),this.config.endColor=this.config.message_skin.substr(this.config.message_skin.indexOf("|")+1);else{var e={"chat/1":"#4297e0","chat/3":"#575757","chat/4":"#f25488","chat/5":"#52ab52","chat/6":"#9bc942","chat/7":"#4297e0",
"chat/8":"#4297e0","chat/9":"#4297e0","chat/10":"#4297e0"};this.config.startColor=e[this.config.message_skin]?this.config.endColor=e[this.config.message_skin]:this.config.endColor=this.config.message_skin}this.config.chatBackground=b.isDefined(this.config.message_content_skin)?this.config.message_content_skin:"#FFFFFF";this.view.disableButton("face",0==this.config.enable_face);this.view.displayButton("face",0==this.config.enable_face);this.view.disableButton(["image","file"],0==this.config.transferfiles);
0==this.config.transferfiles||b.browser.android&&0==this.config.androidtransf||b.browser.mobile&&!b.browser.android&&0==this.config.othertransf?this.view.displayButton(["image","file"],!0):this.view.displayButton(["image","file"],!1);b.browser.mobile&&(0==this.config.enable_audio||2==this.config.enable_audio&&b.browser.gecko)&&this.view.hideAudioButton();this.view.disableButton("history",0==this.config.chatingrecord);this.view.displayButton("history",0==this.config.chatingrecord);this.view.disableButton("loadhistory",
1!=this.config.viewchatrecord);this.view.displayButton("loadhistory",1!=this.config.viewchatrecord);this.view.disableButton("evaluate",0==this.config.evaluation);this.view.displayButton("evaluate",0==this.config.evaluation);this.view.disableButton(["capture","capoptions"],0==this.config.captureimage);this.view.displayButton(["capture","capoptions"],0==this.config.captureimage);this.view.disableButton("csr",1!=this.config.changecsr);this.view.displayButton("csr",1!=this.config.changecsr);this.view.displayButton("xiaonengver",
0==this.config.xiaonengver);this.requestRobot&&0==this.config.robot_mode&&this.view.switchToolbar(!1);var f=!0;this.config.faces=this.config.faces||[];d={id:"-1",name:"",icon:"",pics:[]};b.each(b.lang.editorFaceAlt,function(a){f&&(d.icon=b.sourceURI+"images/faces/"+a+(b.browser.msie6?".gif":".png"),f=!1);d.pics.push({id:a,url:b.sourceURI+"images/faces/"+a+(b.browser.msie6?".gif":".png"),sourceurl:b.lang.editorFaceAlt[a]})});(!this.config.faces.length||"-1"!=this.config.faces[0].id)&&this.config.faces.unshift(d);
this.config.rightlabel=!this.config.rightlabel||b.isEmptyObject(this.config.rightlabel)?b.lang.rightlabel:b.merge({},this.config.rightlabel);b.each(this.config.rightlabel,function(d,e){switch(d){case "about":var f=a.config.introduction,i=/\[tab\s+(.*?)\](.*?)\[\/tab\]/gi;i.test(f)?(f=f.replace(i,"$1"),f=b.utils.handleLinks(f,{siteid:a.siteid,user_id:b.global.shortid,lang:b.language||"",itemid:a.itemid||"1111",erpparam:b.global.erpparam||"",itemparam:a.options.itemparam,sellerid:!a.options.itemparam?
a.options.sellerid:""}),c.push(b.extend(e,{data:f}))):f&&c.push(b.extend(e,{data:f}));break;case "faq":a.config.faqlist&&a.config.faqlist.length&&c.push(b.extend(e,{data:a.config.faqlist||[]}));break;default:e.data=b.utils.handleLinks(e.data,{siteid:a.siteid,user_id:b.global.shortid,itemid:a.itemid||"1111",itemparam:a.options.itemparam}),e.data&&c.push(e)}});this._moreData=c;this.manageMode.callConfigLoaded&&this.manageMode.callConfigLoaded(this.settingid,this.config,c);this.displayMoreData()},displayMoreData:function(){if(this.view.displayButton){if(!this._moreData||
!this._moreData.length||!1===b.global.pageinchat)return this.view.displayButton("exp",!0),!0;"1"==this.config.autoexpansion&&!this.getExpansionStatus()&&this.toggleExpansion(this.settingid);return!1}},getCustomerServiceInfo:function(a,c,d){this.callTrack("10-01-05","start t2d connect");var e=this;this.callMethod=this.callMethod||window;this.callBack="callBack_chat_"+b.randomChar();this.callMethod[this.callBack]=function(){"function"==typeof window.nTalk.fIM_getSessionCustomerServiceInfo?window.nTalk.fIM_getSessionCustomerServiceInfo.apply(e,
arguments):window.nTalk.Log("nTalk.fIM_getSessionCustomerServiceInfo is undefined",3)};this.requestRobot?(this.dest.destid=this.robotID,a={status:1,userid:this.dest.destid,nickname:this.config.robot_name||b.lang.robot_name,usericon:this.config.robot_logo||"",signature:"",sessionid:""},this.callMethod[this.callBack](a,this.settingid)):this._getCustomerServiceForT2dStatus(a,c,d)},changeCustomerServiceInfo:function(){this.startCSSwitch="START";this.getCustomerServiceInfo(this.getDest(!0),0,this.getDest().id)},
_getCustomerServiceForT2dStatus:function(a,c,d){b.Log("chatMode._getCustomerServiceForT2dStatus("+a+", "+c+")",1);var e=this,f=b.base.checkID(a);this._connectTimeout?b.Log("Connect tchat...",2):b.user.id&&b.global.pcid&&(!1===f||f!=b.CON_CUSTOMER_ID&&f!=b.CON_GROUP_ID?this.showMessage("system",{type:9,msg:b.lang.system_no_user}):(a=b.toURI({query:"requestchat",sitid:this.siteid,settingid:this.settingid,uid:b.user.id,uids:a,ruids:d,issingle:c,cid:b.global.pcid,type:b.global.isvip,callbackname:this.callBack},
!0),this.view.displayStatusInfo&&"QUEUE"!==this.statusConnectT2D&&this.view.displayStatusInfo(!0,b.lang.system_allocation_service),b.Log("QueryString:"+a),b.Log(":::"+this.server.t2dstatus+"?"+a+"#rnd",1),this.statusConnectT2D="QUERY",b.require(this.server.t2dstatus+"?"+a+"#rnd",function(a){b.Log("request t2dstatus complete: error:"+(a.error||"")+", reconnect:"+e._reconnectCount+", statusConnectT2D:"+e.statusConnectT2D);if(a.error||"QUERY"==e.statusConnectT2D)e.callTrack("10-01-07","t2d abnormal"),
e._reconnectCount++,e.statusConnectT2D="WAIT",3>e._reconnectCount?setTimeout(function(){e.reconnect()},1E3):(e._reconnectCount=0,e._failure("3TH_REQUEST"));b(a.error?a.target:a).remove()})))},callBackCustomerServiceInfo:function(a){var c="";b.Log(this.settingid+":chatMode.callBackCustomerServiceInfo("+b.JSON.toJSONString(a)+")",1);!a||a.error||3!=a.status&&(!a.userid||!a.externalname&&!a.nickname)?(this.callTrack("10-01-07","result params abnormal"),"no free users"==a.error?c=b.lang.system_no_free_user:
"over rechatnum"==a.error?(c=b.lang.system_over_rechatnum,this.view.disableButton("csr",!0)):"no user2"==a.error&&(c=b.lang.system_no_user),""!=c?(this.showMessage("system",{type:9,msg:c}),this.callStat("13"),this.statusConnectT2D="COMPLETE",this.view.displayStatusInfo&&this.view.displayStatusInfo(!1),this._stopQueue()):(this._abnormal(a.error||""),this.startCSSwitch="",this.view.displayStatusInfo&&this.view.displayStatusInfo(!1))):(this.callTrack("10-01-06","success"),"START"==this.startCSSwitch&&
(this.startCSSwitch="SHOW"),this._clearChangeCsrNum(),this.sessionid=a.sessionid||"",b.Log("get sessioId>>"+this.sessionid,2),a.usericon="null"==a.usericon?"":a.usericon,this.setDest({id:a.userid,name:a.externalname||a.nickname||"",sign:a.signature||"",logo:b.protocolFilter(a.usericon||""),status:a.status||0}),this.callMethod[this.callBack]=new Function,a.status===this.CON_OFFLINE?(this.statusConnectT2D="COMPLETE",this._offline()):a.status===this.CON_BUSY?(this.statusConnectT2D="QUEUE",this._queueNum=
+a.num+1,this._busy()):(this.statusConnectT2D="COMPLETE",this._online()))},_abnormal:function(a){var c=b.utils.handleLinks(b.lang.system_abnormal,{settingid:this.settingid});this.callStat("13");this.connected=!1;this._stopQueue();this.showMessage("system",{type:9,msg:c});b.Log("Customer information request an exception.("+a+")",3)},_failure:function(a){var c=b.utils.handleLinks(b.lang.system_failure,{settingid:this.settingid});this.view.displayStatusInfo&&this.view.displayStatusInfo(!1);this.connected=
!1;this._stopQueue();this.showMessage("system",{type:9,msg:c});b.Log("Customer information request fails.("+a+")",3)},_offline:function(){var a=b.utils.handleLinks(b.lang.system_offline,{destname:this.dest.name,settingid:this.settingid});this.view.displayStatusInfo&&this.view.displayStatusInfo(!1);this.callStat("12");this.connected=!1;this._stopQueue();this.showMessage("system",{msg:a,type:9});1==this.server.robot&&this.server.roboturl&&1==this.config.robot&&(0<parseFloat(this.config.robot_mode)||
1==this.options.manual)?this.switchServerType(!1,"OFFLINE"):this.switchUI(this.CON_VIEW_MESSAGE,"OFFLINE")},_online:function(){var a=this;this.view.displayStatusInfo&&(this.view.displayStatusInfo(!1),b.browser.safari&&!navigator.cookieEnabled&&setTimeout(function(){a.view.displayStatusInfo(!0,b.lang.system_cookie,{"font-size":"12px","line-height":"27px",padding:"0 45px"},!0)},1E3));this.callStat("10");this._stopQueue();b.Log("connect user "+this.dest.name+"...",1);this.createConnect()},_busy:function(){var a;
this.connected=!1;this.view.displayStatusInfo&&this.view.displayStatusInfo(!1);if(this._startQueue)this.view.chatHistory.find(".chat-view-queue-num").html(this._queueNum.toString());else if(1==this.server.robot&&this.server.roboturl&&1==this.config.robot&&2==parseFloat(this.config.robot_mode))this.statusConnectT2D="COMPLETE",this.switchServerType(!1,"BUSY");else{if(!0!==this._startQueue){this._startQueue=!0;this.callStat("11");var c=this;this.view.disableButton(["image","file","submit"],!0);this._queueTime=
0;this._queueTimeID=setInterval(function(){0===c._queueTime%3&&c.getCustomerServiceInfo(c.options.destid,c.options.single,"");c._queueTime++;c.view.chatHistory.find(".chat-view-queue-time").html(b.secondsToMinutes(c._queueTime))},1E3)}if(!this.view.chatHistory.find(".chat-view-queue-num").length){a='<font class="chat-view-queue-num" style="'+b.STYLE_BODY+'color:red;font-weight:bold;">'+this._queueNum.toString()+"</font>";toRobotMessage="";var d,e;b.browser.mobile?(d=b.lang.system_mobile_queue1||b.lang.system_queue1,
e=b.lang.system_mobile_queue2||b.lang.system_queue2):(d=b.lang.system_queue1,e=b.lang.system_queue2);queue1message=b.utils.handleLinks(e,{settingid:this.settingid,count:a,time:""});a=b.utils.handleLinks(d,{settingid:this.settingid,count:a,time:"",br:"",torobot:toRobotMessage});1===this.config.disable_message?this.showMessage("system",{type:0,msg:queue1message}):this.showMessage("system",{type:0,msg:a});this.view.changeQueueStyle()}}},_stopQueue:function(){this._startQueue=!1;clearInterval(this._queueTimeID);
this.view.disableButton(["image","file","submit"],!1)},_ready:function(){b.Log(this.settingid+"::chatMode._ready()",1);this.connect&&this.connect.stopSwitchConnect();this.statusConnectTChat="READY";"zh_cn"!==b.lang.language.toLowerCase()&&(this.debug&&b.Log(this.settingid+":chat.connect.setTextStyle"),this.connect&&this.connect.setTextStyle(b.JSON.toJSONString({fontsize:20})));this.callStat("4")},_connectSuccess:function(a){this.callTrack("10-01-02","connect success");var c=this,d=0;a&&(a="string"==
typeof a?b.JSON.parseJSON(a):a,this.setUser({id:a.myuid||"",name:a.myuname||"",sign:a.signature||"",logo:b.protocolFilter(a.mylogo||"")}),this.sessionid=a.sessionid||"",this.jetLag=b.getTime()-a.timesample,this.mergeSession(this.dest.id,this.sessionid,function(){b.Log("merge session")}));this._stopConnectTimeout();this.statusConnectTChat="COMPLETE";b.Log("connect "+this.dest.name+" complete",1);b.browser.mobile&&(this.manageMode&&b.isFunction(this.manageMode.view.updateViewStatus))&&this.manageMode.view.updateViewStatus(!1);
this.view.removeMessage("system");"SHOW"==this.startCSSwitch&&(this.userList=[],this.startCSSwitch="",this.showMessage("system",{type:9,msg:b.utils.handleLinks(b.lang.system_switch_session,{destname:this.dest.name})}));b.waitMessage.each(function(a,b){c.waitTimeID[c.waitTimeID.length]=setTimeout(function(){c.send(b)},d);d+=600});this._sendGoodsinfo();this.hashCache.each(function(a,b){c.cacheTimeID[c.cacheTimeID.length]=setTimeout(function(){c.send(b)},d);d+=600});this.hashCache.clear();this.view.disableButton("history",
!1);!this.requestRobot&&1==this.config.robot_inherits_state&&(b.default_connect_robot=!1)},_connectException:function(){b.Log(this.settingid+":chatMode._connectException()");this.connected=!1;this.statusConnectTChat="FAILURE";this.showMessage("system",{type:9,msg:b.utils.handleLinks(b.lang.system_connect_wait,{settingid:this.settingid})})},_connectResult:function(a,c,d){d=b.hexToDec(d);b.Log(this.settingid+":chatMode.connectResult("+b.JSON.toJSONString(arguments)+")");if(this.connected&&a===this.CON_CLOSE_CONNECT)this.statusConnectTChat=
"CLOSECHAT";else switch(this.connected&&a===this.CON_DISCONNECT&&this.disconnect(),!this.connected&&a===this.CON_LOGIN_SUCCESS&&(this.connected=!0),a){case this.CON_LOGIN_SUCCESS:this.view.disableButton("capture",!1);this._connectSuccess(c);break;case this.CON_LOGIN_FAILURE:case this.CON_CONNECT_FAILURE:this.view.disableButton("capture",!0),this._connectException()}},mdyServerAddr:function(a){return a.replace(/\/flashgo/i,"/httpgo")},setFlashGoServer:function(a){var c;c=/cid=(\-?\d+)/gi;b.Log(this.settingid+
':chatMode.setFlashGoServer("'+a+'")');a&&(a=this.mdyServerAddr(a),c=c.exec(a),this.chatFlashGoUrl=b.protocolFilter(a),this.chatgourl=b.protocolFilter(a.substr(0,a.indexOf("?"))),this.clientid=c&&2==c.length?c[1]:"")},notifySessionSence:function(a){b.Log("chatMode.notifySessionSence("+a+")",1);try{a=b.JSON.parseJSON(a)}catch(c){}this._Evaluable=1===a.evaluable?!0:!1;this._Enableevaluation=1===a.enableevaluation?!0:!1;b.browser.mobile&&this.view.displayEvClose(this._Enableevaluation?1:0);this.view.disableButton("evaluate",
!this._Evaluable);-1==a.score?(this._submitRating=!1,this.showMessage("info",{type:9,msg:b.lang.system_evaluation_failure})):0<a.score&&(this._submitRating=!0)},notifyUserList:function(a){b.Log(this.settingid+":chatMode.notifyUserList("+a+")");try{a=b.JSON.parseJSON(a)}catch(c){a=[]}for(var d=0;d<a.length;d++)b.base.checkID(a[d].userid)!==b.CON_CUSTOMER_ID&&a.splice(d,1);this.userList=a;this.userNumber=this.userList.length;b.Log(this.settingid+":chatMode.notifyUserList:"+a.length);1<this.userNumber&&
this.callStat("21")},userEnter:function(a){var c,d=b.lang.system_add_session,e=!0;try{c=b.JSON.parseJSON(a)}catch(f){c=null}if(!(b.base.checkID(c.userid)!=b.CON_CUSTOMER_ID||0==this.userList.length)){for(var g=0;g<this.userList.length;g++)this.userList[g].userid==c.userid&&(e=!1);e&&(this.userList.push(c),this.userNumber=this.userList.length);1<this.userList.length&&this._clearChangeCsrNum();b.Log(this.settingid+":["+this.userList.length+"]chatMode.userEnter("+a+")");d&&1<this.userNumber&&(this.enterUserId=
c.userid,this.showMessage("system",{type:9,msg:b.utils.handleLinks(d,{destname:c?c.externalname||c.nickname||"":this.dest.name})}))}},userLeave:function(a){this.enterData=null;b.Log(this.settingid+":chatMode.userLeave("+a+")");var c=b.extend({},this.hashDest.items(a));if(c&&!b.isEmptyObject(c)){if(!(2>this.userList.length)){for(var d=[],e=0;e<this.userList.length;e++)this.userList[e].userid!=a&&d.push(this.userList[e]);this.userList=d;this.userNumber=this.userList.length;if(d=this.userList[0])this.setDest({id:d.userid||
"",name:d.externalname||d.nickname||"",sign:d.signature||"",logo:b.protocolFilter(d.usericon||d.logo||""),status:d.status}),this.showMessage("system",{type:9,msg:b.utils.handleLinks(b.lang.system_go_away_session,{destname:c.name})})}}else b.Log("chatMode.userLeave(): dest info is null",2)},_userInfo:function(a){var c;if("object"==typeof a)c=a;else try{c=b.JSON.parseJSON(a)}catch(d){return}c.status===this.CON_OFFLINE||c.status===this.CON_AWAY?(this.statusConnectTChat="CLOSECHAT",this.disconnect()):
this.dest.id!=c.userid&&1!=c.status?(b.Log(">userid:"+this.dest.id+"!="+c.userid+" ,>"+(this.dest.id!=c.userid)+", "+c.status+"!=1>"+(1!=c.status),1),b.Log("Switch to is not online customer service does not update the customer information ",2)):this.setDest({id:c.userid||this.dest.id,name:c.externalname||c.nickname||this.dest.name,sign:c.signature||this.dest.sign,logo:b.protocolFilter(c.usericon||c.logo||this.dest.logo),status:c.status})},getMsgId:function(a){for(a=a||b.getTime();this.hash.contains(a+
"J");)a++;return parseFloat(a)+"J"},mergeSession:function(a,c,d){if(this.robotSessionID){var e=this;new b.POST(this.server.mcenter+"/message.php?m=Message&a=updateRobotMsg",{siteid:this.siteid,robotsessionid:this.robotSessionID,sessionid:c||this.sessionid,destid:a,myuid:b.user.id},function(){b.Log("send hidtory message complete");setTimeout(function(){d.call(e)},50)})}},_clearChangeCsrNum:function(){this._changeCsrNum=0;this.view.disableButton("csr",!0)},_filterNullChar:function(a){var c=this;b.each(a,
function(d,e){a[d]=b.isObject(e)?c._filterNullChar(e):"number"==typeof e?e:e.replace(l,"")});return a},_formatEvaluationData:function(a){var c="",d=b.getTime(),d={type:5,timerkeyid:d,msgid:this.getMsgId(d)},a=this._filterNullChar(a);d.msg=b.extend({msgtype:3},{evaluate:a});for(var e in a)a[e]&&(a[e].value&&!b.isFunction(a[e])&&a.hasOwnProperty(e))&&(c="string"===typeof a[e].value?c+(a[e].value+"; "):c+(a[e].value.text+"; "));b.Log("submitData::"+b.JSON.toJSONString(d));return{data:this._toEvaluateXML(d),
info:b.enCut(c,50)}},_toEvaluateXML:function(a){var c,a=b.charFilter(a);c=b.whereGet(a,["type","msgid"]);for(var d in c)c[d]===i&&delete c[d];a={flashuid:a.timerkeyid,msg:{msg:b.extend(a.msg,{attributes:c})}};a.msg.msg.evaluate&&(a.msg.msg.evaluate=b.JSON.toJSONString(a.msg.msg.evaluate));a.msg=b.jsonToxml(a.msg);return a}};b.chatManage={name:"chatManage",view:null,options:null,hash:new b.HASH,hashWait:new b.HASH,hashConfig:new b.HASH,hashStatus:new b.HASH,objMinView:null,cacheLeft:null,cacheTop:null,
open:function(a,c,d,e,f,g,h,i){b.Log("$.chatManage.open("+b.JSON.toJSONString(arguments)+")");var k=this;this.settingid=a;this.destid=c||"";this.itemid=d;this.itemparam=e;this.sellerid=f;this.single=h||(this.destid?1:0);this.manual=i||"0";this.clearHistoryPageCount();this.view&&this.objMinView&&this.objMinView.remove();if(this.hash.contains(this.settingid))this.hash.items(this.settingid)&&(b.Log("$.chatManage.switchChat("+this.settingid+")",1),this.chat=this.hash.items(this.settingid),this.chat.selected||
this.switchChat(this.settingid));else{if(this.hashWait.contains(this.settingid)){b.Log("wait open chat",2);return}this.hashWait.add(this.settingid,"wait");b.base.showLoading();this.loadConfig(a,function(a){k.initChatManage(g,a)})}return!0},initChatManage:function(a,c){var d=this,e;e={};this.view||(e.position=c?c.position:{},c&&typeof c.resize_chat!=i&&typeof c.drag_chat!=i?(e.resize=!b.global.pageinchat||!c||0==c.resize_chat?!1:!0,e.drag=!b.global.pageinchat||!c||0==c.drag_chat?!1:!0):(e.resize=!1,
e.drag=!0),this.view=new b.chatManageView(e,this),b(window).bind("beforeunload",function(a){d.beforeunload(a)}));b.global.pageinchat||(b.Capture.captureWithMin=!1);this.view.addChatTag(this.settingid);this.hash.each(function(a,b){b&&b.minimize()});c&&1==c.autoconnect?(b.Log("autoconnect:1"),a=!0):c&&-1==c.autoconnect?a=!1:(e=b.store.get(b.base.CON_LOCAL_FIX+this.settingid))&&18E5>b.getTime()-e&&(a=!0);try{c=b.protocolFilter(c)}catch(f){b.Log("error config file: "+f)}this.chat=this.createChatMode(a,
c);this.hash.add(this.settingid,this.chat);(a||this.chat.requestRobot)&&!this.chat.connected&&this.chat.start();b.store.set(b.base.CON_LOCAL_FIX+this.settingid,b.getTime())},beforeunload:function(a){if(0!==this.hash.count()&&(this.chat.connected&&0<this.chat._sendNum&&0!==this.chat.config.sessioncarry?(b.cache.set("carry_sid",this.chat.settingid),b.cache.set("carry_did",this.chat.dest.id)):(b.cache.set("carry_sid",""),b.cache.set("carry_did","")),!b.global.pageinchat&&!b.browser.mobile))if(this.chat&&
this.chat.config&&1==this.chat.config.enableevaluation&&this.chat._Evaluable&&!this.chat._submitRating){this.close();if(b.browser.chrome)return b.lang.system_before_evaluation;b.Event.fixEvent(a).returnValue=b.lang.system_before_evaluation}else setTimeout(function(){},500)},loadConfig:function(a,c){var d=this,e,f=this.hashConfig.items(a);url=[b.server.flashserver,"config/6/",a.split("_").slice(0,2).join("_"),"_",a,".js#rnd"].join("");b.Log("$.chatManage.loadConfig("+a+"):"+url);!f&&(!b.isEmptyObject(b.base.config)&&
b.base.config.settingid==a)&&(f=f||b.base.config);f&&f.service&&f.service.tchatgoserver?(b.base.hiddenLoading(),d.hashWait.remove(a),(e=d.verificationDestId(f))?(b.Log("Only one customer to open a chat window",2),e.showMessage("system0",{type:9,msg:b.utils.handleLinks(b.lang.system_merge_session,{destname:e.dest.name})})):c.call(this,f)):b.require(url,function(g){b.base.hiddenLoading();d.hashWait.remove(a);g.error||!nTalk.CONFIG&&!NTKF.CONFIG?(d.view&&d.view.toggleExpansion("rightElement",!1),c.call(d,
null)):(f=nTalk.CONFIG||NTKF.CONFIG,d.hashConfig.add(a,f),(e=d.verificationDestId(f))?(b.Log("Only one customer to open a chat window",2),e.showMessage("system0",{type:9,msg:b.utils.handleLinks(b.lang.system_merge_session,{destname:e.dest.name})})):c.call(d,f));setTimeout(function(){delete NTKF.CONFIG;delete nTalk.CONFIG},1E3);b(g.error?g.target:g).remove()})},verificationDestId:function(a){var c,d=!1,e;if(a){e=a.icon||a.list||a.toolbar||a.featureset||null;if(!e||!e.members.groupID||!e.members.idList.length)return b.Log("No valid entry configuration",
3),!1;c=e.members?e.members.idList:[];if(!b.isArray(c))return!1;this.hash.each(function(e,g){-1<b.inArray(g.dest.id,c)&&g.settingid!=a.settingid?(b.Log("opened destid:"+g.dest.id+", idList:"+b.JSON.toJSONString(c),2),d=g):b.Log("opened destid:"+g.dest.id+", idList:"+b.JSON.toJSONString(c),1)});return d}return!1},createChatMode:function(a,c){b.Log("nTalk.chatManage.createChatMode():noWaitConnect:"+a,1);return new b.chatMode({config:c,siteid:b.global.siteid,settingid:this.settingid,destid:this.destid,
itemid:this.itemid,itemparam:this.itemparam,sellerid:this.sellerid,single:this.single,manual:this.manual},this)},get:function(a,c){if(!this.hash.count())return null;if(!a)return this.chat||this.hash.first();if(this.hash.contains(a))return this.hash.items(a);if(c&&b.base.checkID(c)==b.CON_CUSTOMER_ID)for(var d in this.hash.hashTable){var e=this.hash.items(d);d&&(this.hash.hashTable.hasOwnProperty(d)&&e.dest.id==c)&&(a=e.settingid)}return this.hash.contains(a)?this.hash.items(a):null},close:function(){b.Log("nTalk.chatManage.close()");
var a=this,c=function(){a.hash.each(function(a,b){b.close()});a.hash.clear();b.global.pageinchat?(a.view.close(),a.view=null):b.browser.mobile?history.go(-1):(window.opener=null,b.browser.chrome||window.open("","_self"),window.close()||(window.location.href="about:blank"))};if(this.chat&&this.chat.config&&!this.chat._submitRating&&this.chat._currentView==this.chat.CON_VIEW_WINDOW&&1==this.chat.config.enableevaluation&&this.chat._Enableevaluation){if(!1===this.chat.showEvaluation(0,function(){c()}))try{c()}catch(d){b.Log(d,
3)}}else try{c()}catch(e){b.Log(e,3)}},switchChat:function(a){b.Log("chatManage.switchChat("+a+")");this.view.switchChatTag(a);this.callSwitchChat(a)},closeChat:function(a){var c=this.hash.next(a);b.Log("chatManage.closeChat()");this.view.removeChatTag(a);this.switchChat(c);this.hash.items(a).close();this.hash.remove(a)},callVerification:function(a,c){var d;b.Log("chatManage._callStart("+a+", [config Object])");return(d=this.verificationDestId(c))?(this.closeChat(a),d):!1},callManageResize:function(a,
b){this.hash.each(function(d,e){e.view.callChatResize(a,b)})},callMinimize:function(){b.Log("$.chatManage.callMinimize()");var a=this;this.objMinView=new b.minimizeView(this.chat.dest,this.chat._currentView==this.chat.CON_VIEW_MESSAGE,function(){b.isFunction(a.view.maximize)&&a.view.maximize();a.objMinView=null})},callSwitchChat:function(a){var c=this;b.Log("chatManage.callSwitchChat("+a+")");this.hash.each(function(b,e){e.settingid===a?(e.maximize(),e.displayMoreData()&&c.view.toggleExpansion("rightElement",
!1),c.view.updateRightData(e.settingid,e._moreData),c.chat=e):e.minimize()})},callToggleExpansion:function(){var a=this.view.toggleExpansion("rightElement");this.hash.each(function(b,d){d.view.updateMore(a)});return a},callToggleExpansionTab:function(){return this.view.toggleExpansion("leftElement")},callConfigLoaded:function(a,b,d){this.view.updataSkin(b.chatBackground,b.startColor,b.endColor);d&&d.length&&this.view.updateRightData(a,d)},showFAQ:function(a,c,d){a=this.hash.items(a);b.Log("chatManage.showFAQ()");
a.showMessage("otherinfo",{userid:a.dest.id,type:9,title:c,msg:d})},callSetDest:function(a,b){this.view&&this.view.updateChatTag(a,b);if(this.objMinView)this.objMinView[0===b.status?"offline":"online"]()},callSetDestStatus:function(a,b,d){this.view&&this.view.updateChatTag(a,b,d)},callReceive:function(a){b.Log("$.chatManage.callReceive()");this.hash.items(a).selected||this.view.labelFlicker(a);this.objMinView&&(this.objMinView.count++,this.objMinView.startFlicker())},getHistoryPageCount:function(){return!b.browser.mobile?
-1:b.store.get("history")||-1},clearHistoryPageCount:function(){return b.store.remove("history")},addHistoryPageCount:function(){if(!b.browser.mobile)return-1;var a=b.store.get("history")||"-1",a=parseFloat(a)-1;b.store.set("history",a);return a}};b.extend({fIM_getSessionCustomerServiceInfo:function(a,c){var d,e=b.chatManage.get(c);if(e){if(b.isObject(a))d=a;else try{d=b.JSON.parseJSON(a.replace(/[\r|\n]/ig,""))}catch(f){}e.callBackCustomerServiceInfo(d);return!0}}});b.extend({fIM_tchatFlashReady:function(a,
c,d){setTimeout(function(){var e=b.chatManage.get(d);e?e._ready(a,c):b.Log("fIM_tchatFlashReady:settingid:"+d,3)},0);return!0},fIM_ConnectResult:function(a,c,d,e){b.Log("nTalk.fIM_ConnectResult("+a+', userinfo, "'+d+'", "'+e+'")',1);setTimeout(function(){var f=b.chatManage.get(e);f&&f._connectResult(a,c,d)},0);return!0},fIM_onGetUserStatus:function(a,c){b.Log("nTalk.fIM_onGetUserStatus("+a+', "'+c+'")',2);return!0},fIM_requestEvaluate:function(a,c,d){b.Log("nTalk.fIM_requestEvaluate("+b.JSON.toJSONString(arguments)+
")");setTimeout(function(){var a=b.chatManage.get(d);a?a.showEvaluation(2):b.Log("fIM_requestEvaluate:settingid:"+d,3)},0);return!0},fIM_notifyUserInputing:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d?d.showInputState(a):b.Log("fIM_notifyUserInputing:settingid:"+c,3)},0);return!0},fIM_receiveCustomerServiceInfo:function(a,c){b.Log('nTalk.fIM_receiveCustomerServiceInfo("'+a+'", "'+c+'")')},fIM_onNotifySessionSence:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d&&
d.notifySessionSence(a)},0);return!0},fIM_notifyUserNumbers:function(a,c){setTimeout(function(){b.chatManage.get(c)},0)},fIM_notifyUserList:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d&&d.notifyUserList(a)},0);return!0},fIM_onGetUserInfo:function(a,c){b.Log("nTalk.fIM_onGetUserInfo("+b.JSON.toJSONString(a)+", "+c+")",1);setTimeout(function(){var d=b.chatManage.get(c);d&&d._userInfo(a)},0);return!0},fIM_notifyUserEnter:function(a,c,d,e){b.Log("nTalk.fIM_notifyUserEnter("+a+", "+
c+")");setTimeout(function(){var a=b.chatManage.get(e);a&&(a.userEnter(c),a._userInfo(c))},0);return!0},fIM_notifyUserLeave:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d&&d.userLeave(a)},0);return!0},fIM_receiveMessage:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d&&d.receive(a)},0)},fIM_suggestMessage:function(a,c){setTimeout(function(){var d=b.chatManage.get(c);d&&d.suggest(a)},0)},fIM_onGetFlashServer:function(){},fIM_setTChatGoServer:function(a,c){b.Log("nTalk.fIM_setTChatGoServer("+
a+")");setTimeout(function(){var d=b.chatManage.get(c);d&&d.setFlashGoServer(a)},0)},fIM_updateUserNumber:function(){}});b.extend({fIM_uploadFlashReady:function(a,c,d){setTimeout(function(){var a=b.chatManage.get(d);a?a._uploadReady(c):b.Log("nTalk.uploadFlashReady()",3)},0);return!0},fIM_startSendFile:function(a,c,d,e){var f=b.chatManage.get(e);b.Log("nTalk.fIM_startSendFile("+c+","+d+", "+e+")");setTimeout(function(){f.startUpload(c,d)},0);return!0},fIM_receiveUploadSuccess:function(a,c,d,e){var f=
b.chatManage.get(e);b.Log("nTalk.fIM_receiveUploadSuccess("+b.JSON.toJSONString(arguments)+")");setTimeout(function(){f.uploadSuccess(c,d)},0)},fIM_receiveUploadFailure:function(a,c,d,e){var f=b.chatManage.get(e);b.Log("nTalk.fIM_receiveUploadFailure("+b.JSON.toJSONString(arguments)+")");setTimeout(function(){f.uploadFailure(c,d)},0)},fIM_receiveUploadProgress:function(a,c,d,e){var f=b.chatManage.get(e);setTimeout(function(){f.uploadProgress(c,d)},0);return!0}});b.extend({clearSessionCache:function(){var a=
this,c;if(!b.base||!b.base.clearChatCache)b.Log("no clear chat cache");else{try{c=b.store.getAll()}catch(d){b.Log("$.store:"+typeof b.store,3)}c&&(b.each(c,function(c){-1<c.toString().indexOf(b.base.CON_LOCAL_FIX)&&a.store.remove(c)}),b.Log("clear chat cache"))}},chatReady:function(){b.waitMessage||(b.waitMessage=new b.HASH,b.waitMessage.verificationAdd=function(a,b){var d=!1;this.each(function(a,f){f.type==b.type&&f.msg.msgtype==b.msg.msgtype&&(d=!0)});d||this.add(a,b)});b.waitMessage.verificationAdd(b.getTime(1),
{type:5,msg:{msgtype:2,parentpagetitle:(b.global.title||b.title).toString().substr(0,32),parentpageurl:b.global.source||b.source,userlevel:b.global.isvip,sences:""}});b.waitMessage.verificationAdd(b.getTime(1),{type:5,msg:{msgtype:7,param:b.global.erpparam+"|lang="+(b.global.lang||b.language)}});b.Log("$.chatReady():: $.waitMessage.count():"+b.waitMessage.count(),1);!b.themesURI&&b.browser.mobile?b.imageicon=b.sourceURI+"images/mobileicon.png":b.themesURI||(b.imageicon=b.sourceURI+"images/chaticon."+
(b.browser.msie6?"gif":"png"),b.imagebg=b.sourceURI+"images/chatbg.gif");b.imagesingle=b.sourceURI+"images/single.png";b.imagemultiplayer=b.sourceURI+"images/multiplayer.png";b.require([b.imageicon],function(a){a.error&&b.Log("cache chat icon failure",3)});b.clearSessionCache()}});b.chatReady()})(nTalk);
